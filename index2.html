<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Presenze Cantiere</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{
      --primary:#FF6B35; --primary-dark:#E55A2B;
      --secondary:#004E89; --secondary-light:#1A659E;
      --accent:#F7B801; --success:#06D6A0; --danger:#ef4444;
      --muted:#94a3b8; --text:#fff; --text-secondary:#B8C5D6;
      --bg:#0A0E27; --bg-light:#111634; --card:#151a3b; --border:rgba(255,255,255,.12);
      --slot-h: 160px;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .container{max-width:480px;margin:0 auto;min-height:100vh}
    .topbar{display:flex;justify-content:flex-end;padding:10px 16px}
    .logout-btn{background:rgba(255,255,255,.06);border:1px solid var(--border);color:#fff;border-radius:12px;padding:6px 10px;cursor:pointer;font-weight:700;font-size:12px}
    .header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));padding:18px;border-radius:0 0 20px 20px}
    .header h1{font-size:18px;font-weight:800;margin-bottom:6px}
    .user-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);padding:6px 10px;border-radius:14px;font-size:12px;font-weight:600}
    .content{padding:16px}
    .step-indicator{display:flex;gap:8px;margin-bottom:12px}
    .step{flex:1;height:4px;background:rgba(255,255,255,.08);border-radius:4px}
    .step.active{background:linear-gradient(90deg,var(--primary),var(--accent))}
    .view{display:none}
    .view.active{display:block}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:12px}
    .card-title{font-size:15px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px}
    .date-selector{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:6px}
    .date-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(255,255,255,.05);border:2px solid transparent;border-radius:10px;cursor:pointer;font-size:12px}
    .date-day .day-name{font-size:9px;color:var(--text-secondary);margin-bottom:2px;text-transform:uppercase;font-weight:600}
    .date-day .day-num{font-size:14px;font-weight:800}
    .date-day.selected{background:linear-gradient(135deg,var(--primary),var(--accent));border-color:transparent}
    .date-day.today{outline:2px solid var(--success)}
    .date-day.weekend:not(.selected), .date-day.holiday:not(.selected){background: rgba(220,38,38,.12); border-color: rgba(220,38,38,.35);}
    .date-actions{display:flex;gap:8px;margin-top:8px}
    .chip{flex:1;background:rgba(255,255,255,.06);border:1px dashed var(--border);border-radius:12px;padding:8px 10px;cursor:pointer;font-size:12px;font-weight:700;color:#e5e7eb;text-align:center}
    .chip.active{border-style:solid;border-color:var(--danger);background:linear-gradient(135deg,#9f123999,#7f1d1d77)}
    .time-picker{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    .time-slot{position:relative;overflow:hidden;border-radius:16px;border:1px solid var(--border);background:var(--bg-light);min-height:var(--slot-h);padding:10px;isolation:isolate}
    .slot-bg{position:absolute;inset:0;border-radius:16px;opacity:.95;transform:translateZ(0)}
    .time-slot.morning .slot-bg{background:linear-gradient(135deg,#4da3ff,#5bc0eb)}
    .time-slot.afternoon .slot-bg{background:linear-gradient(135deg,var(--primary),var(--accent))}
    .slot-inner{position:relative;z-index:1;display:grid;grid-template-rows:auto 1fr auto;gap:8px;height:100%}
    .slot-head{display:flex;align-items:center;justify-content:space-between}
    .slot-time{font-size:16px;font-weight:900;text-align:left}
    .slot-badge{font-size:12px;font-weight:800;padding:4px 8px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.4)}
    .time-inputs{align-self:end;display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .time-inputs input[type="time"]{width:100%;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.35);color:#fff;border-radius:10px;padding:8px 10px;font-size:14px;outline:none}
    .total-card{margin-top:8px;text-align:center}
    .total-card small{display:block;color:var(--text-secondary)}
    .total-card strong{display:block;font-size:22px}
    .btn-group{display:flex;gap:10px;margin-top:12px}
    .btn{flex:1;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border:none;border-radius:12px;padding:12px;font-size:15px;font-weight:800;color:#fff;cursor:pointer}
    .btn-secondary{background:rgba(255,255,255,.06);border:1px solid var(--border)}
    .btn-success{background:linear-gradient(135deg,var(--success),#05b78b)}
    .summary-card{background:linear-gradient(135deg,var(--secondary),var(--secondary-light));border:none}
    .summary-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.15)}
    .summary-row:last-child{border-bottom:none}
    .summary-works{display:flex;flex-direction:column;gap:10px}
    .summary-work{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:10px}
    .month-list{display:none;flex-direction:column;gap:8px;margin-top:8px}
    .month-list.open{display:flex}
    .month-item{display:flex;align-items:center;justify-content:space-between;gap:10px;background:var(--bg-light);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .mi-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
    .mi-date{min-width:46px;text-align:center;font-weight:900;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:10px;padding:4px 6px;font-size:12px}
    .mi-main{display:flex;flex-direction:column;min-width:0;flex:1}
    .mi-cant{font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mi-lav{font-size:12px;color:#e5e7eb;opacity:.8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mi-right{display:flex;align-items:center;gap:8px}
    .mi-ore{font-weight:900;font-size:14px}
    .preview-card{display:none}
    .preview-card.show{display:block}
    .preview-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.12)}
    .preview-row:last-child{border-bottom:none}
    .preview-actions{display:flex;gap:8px;margin-top:12px}
    .notes-area{width:100%;min-height:70px;background:#0b102a;border:1px solid rgba(255,255,255,.55);border-radius:10px;color:#fff;padding:10px;font-size:14px}
    .notes-area::placeholder{color:#cbd5e1;opacity:.9}
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginPage" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;">
    <div class="card" style="max-width:420px;width:100%">
      <h2 style="margin-bottom:10px;">üîê Accesso</h2>
      <div style="display:grid;gap:8px">
        <input id="loginUser" type="text" placeholder="User" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg-light);color:#fff">
        <input id="loginPass" type="password" placeholder="Password" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg-light);color:#fff">
        <button id="loginBtn" class="btn">Entra</button>
        <div id="loginError" style="margin-top:6px;color:#ff7b7b;font-weight:800;display:none;">Credenziali errate</div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="container" id="appContainer" style="display:none;">
    <div class="topbar"><button class="logout-btn" onclick="handleLogout()">Esci</button></div>

    <div class="header">
      <h1>‚ö° Presenze Cantiere</h1>
      <div class="user-badge"><span>üë∑</span><span id="userName">-</span></div>
    </div>

    <div class="content">
      <div class="step-indicator"><div class="step active"></div><div class="step"></div><div class="step"></div><div class="step"></div></div>

      <!-- Pagina 1 -->
      <div class="view active" id="page1">
        <div class="card">
          <div class="card-title">üìÖ Seleziona la data</div>
          <div class="date-selector" id="dateSelector"></div>
          <div class="date-actions">
            <button class="chip" onclick="repeatYesterday()">‚Üª Ripeti ieri</button>
            <button id="assenteChip" class="chip" onclick="toggleAssente()">üö´ Assente</button>
          </div>
        </div>

        <!-- Preview ripeti ieri -->
        <div class="card preview-card" id="previewCard">
          <div class="card-title">‚ö° Riepilogo di ieri</div>
          <div class="preview-row"><span>Data</span><span id="previewDate">-</span></div>
          <div class="preview-row"><span>Orario</span><span id="previewTime">-</span></div>
          <div class="preview-row"><span>Ore totali</span><span id="previewHours">-</span></div>
          <div class="preview-row"><span>Cantiere</span><span id="previewSite">-</span></div>
          <div class="preview-row"><span>Lavorazione</span><span id="previewWork">-</span></div>
          <div class="preview-actions">
            <button class="btn btn-success" onclick="confirmRepeat()">‚úì Usa questo</button>
            <button class="btn btn-secondary" onclick="cancelRepeat()">‚úó Annulla</button>
          </div>
        </div>

        <div class="card">
          <div class="card-title" id="monthTitle" style="cursor:pointer" onclick="toggleMonthList()">üìÜ Presenze del mese ‚ñæ</div>
          <div id="monthList" class="month-list"></div>
        </div>

        <div class="btn-group"><button class="btn" onclick="goFromPage1()">Avanti ‚Üí</button></div>
      </div>

      <!-- Pagina 2: orari -->
      <div class="view" id="page2">
        <div class="card">
          <div class="card-title">‚è∞ Orario di lavoro</div>
          <div class="time-picker">
            <div class="time-slot morning">
              <div class="slot-bg"></div>
              <div class="slot-inner">
                <div class="slot-head">
                  <div class="slot-time" id="morningText">08:00 - 12:00</div>
                  <div class="slot-badge" id="mHours">4.0h</div>
                </div>
                <div class="time-inputs">
                  <input type="time" id="mStart" value="08:00" min="07:00" max="15:00" step="1800" oninput="updateTimes()">
                  <input type="time" id="mEnd"   value="12:00" min="07:00" max="15:00" step="1800" oninput="updateTimes()">
                </div>
              </div>
            </div>
            <div class="time-slot afternoon">
              <div class="slot-bg"></div>
              <div class="slot-inner">
                <div class="slot-head">
                  <div class="slot-time" id="afternoonText">13:00 - 17:00</div>
                  <div class="slot-badge" id="pHours">4.0h</div>
                </div>
                <div class="time-inputs">
                  <input type="time" id="pStart" value="13:00" min="12:00" max="20:00" step="1800" oninput="updateTimes()">
                  <input type="time" id="pEnd"   value="17:00" min="12:00" max="20:00" step="1800" oninput="updateTimes()">
                </div>
              </div>
            </div>
          </div>
          <div class="card total-card">
            <small>Ore totali</small>
            <strong id="totalHours">8.0h</strong>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevPage(1)">‚Üê Indietro</button>
          <button class="btn" onclick="nextPage(3)">Avanti ‚Üí</button>
        </div>
      </div>

      <!-- Pagina 3: cantieri -->
      <div class="view" id="page3">
        <div class="card">
          <div class="card-title">üèóÔ∏è Cantieri</div>
          <div id="workItems"></div>
          <button class="chip" id="addWorkBtn" onclick="addWorkItem()" style="width:100%;margin-top:10px">+ Aggiungi cantiere (max 3)</button>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevPage(2)">‚Üê Indietro</button>
          <button class="btn" onclick="nextPage(4)">Avanti ‚Üí</button>
        </div>
      </div>

      <!-- Pagina 4: riepilogo -->
      <div class="view" id="page4">
        <div class="card summary-card">
          <div class="card-title">üìã Riepilogo</div>
          <div class="summary-row"><span>Data</span><span id="summaryDate">-</span></div>
          <div class="summary-row"><span>Orario</span><span id="summaryTime">‚Äî</span></div>
          <div class="summary-row" style="border:none;display:block;padding-top:0;">
            <div style="margin-bottom:6px;color:#e2e8f0">Cantieri & lavorazioni</div>
            <div class="summary-works" id="summaryWorks"></div>
          </div>
          <div class="summary-row" style="align-items:flex-start">
            <span>Note</span>
            <span style="flex:1;max-width:60%">
              <textarea id="notesInput" class="notes-area" placeholder="Aggiungi note..." oninput="updateSummary()"></textarea>
            </span>
          </div>
          <div class="summary-row"><span>Ore totali</span><span id="summaryHours">0.0h</span></div>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevPage(3)">‚Üê Indietro</button>
          <button class="btn btn-success" onclick="submitPresence()">‚úì Conferma</button>
        </div>
      </div>
    </div>
  </div>

  <div class="success-overlay" id="successOverlay" style="display:none;position:fixed;inset:0;background:rgba(10,14,39,.95);align-items:center;justify-content:center;z-index:1000">
    <div class="card"><h2>‚ú® Presenza registrata!</h2></div>
  </div>

  <script>
    const SHEET_ID = "1WLK8tqQPAddqOm1DkTAOdtG5iFS9nYQFc3pxL0Fdc70";
    const OS_BASE  = `https://opensheet.elk.sh/${SHEET_ID}/`;
    const L0URL    = "https://script.google.com/macros/s/AKfycbxPtNkoQlypf1RKNgIAQEJPgMsmoUDVpYeIzbqMeDICK3-hsZTKrPC718hBy0o7dQDa/exec";

    let AUTH = { user:null, nome:null, ruolo:null };
    let selectedDate = new Date();
    let currentPage = 1;
    let SITE_OPTIONS = [];
    let workState = [];
    let LAST_PRESENZE = [];
    let ABSENT_MODE = false;
    let PREVIEW_DATA = null;
    let MONTH_OPEN = false; // stato collassabile

    // ---------- utils ----------
    function pad2(n){return String(n).padStart(2,'0');}
    function fmtISO(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;}
    function fmtHuman(d){return d.toLocaleDateString('it-IT',{day:'numeric',month:'long'})}
    function toMinutes(hhmm){if(!hhmm) return 0; const [h,m]=hhmm.split(':').map(Number); return h*60+m;}
    function diffHours(a,b){return Math.max(0,(toMinutes(b)-toMinutes(a)))/60;}
    function sameYMD(a,b){return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();}
    function addDays(d,n){const x=new Date(d); x.setDate(x.getDate()+n); return x;}
    function startOfWeekMonday(d){const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x;}
    function easterDate(year){const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1;return new Date(year,month-1,day);}
    function isItalianHoliday(d){const y=d.getFullYear(); const fixed=[[1,1],[1,6],[4,25],[5,1],[6,2],[8,15],[11,1],[12,8],[12,25],[12,26]]; for(const [mm,dd] of fixed){ if(sameYMD(d,new Date(y,mm-1,dd))) return true; } return sameYMD(d, addDays(easterDate(y),1));}

    // ---------- cache locale SWR ----------
    function cacheGet(key, maxAgeMs){
      try{ const raw=localStorage.getItem(key); if(!raw) return null; const obj=JSON.parse(raw); if(Date.now()-obj.t>maxAgeMs) return null; return obj.v; }catch{ return null; }
    }
    function cacheSet(key, value){ try{ localStorage.setItem(key, JSON.stringify({t:Date.now(), v:value})); }catch{} }

    // ---------- login ----------
    async function handleLogin(){
      const u=(document.getElementById('loginUser').value||'').trim();
      const p=(document.getElementById('loginPass').value||'');
      document.getElementById('loginError').style.display='none';
      try{
        const rows = await (await fetch(OS_BASE+'Credenziali')).json();
        const rec  = rows.find(r => String(r.User||'').trim()===u && String(r.Password||'')===p);
        if(!rec) throw new Error('BAD');
        AUTH.user=rec.User; AUTH.nome=rec.Nome||rec.User; AUTH.ruolo=rec.Ruolo||'';
        document.getElementById('userName').textContent=AUTH.nome;
        showApp();
        await postLoginInit();
      }catch(e){
        document.getElementById('loginError').style.display='block';
      }
    }
    function handleLogout(){ AUTH={user:null,nome:null,ruolo:null}; showLogin(); }
    function showLogin(){ document.getElementById('loginPage').style.display='flex'; document.getElementById('appContainer').style.display='none';
