<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Presenze Cantiere</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{
      --primary:#FF6B35; --primary-dark:#E55A2B;
      --secondary:#004E89; --secondary-light:#1A659E;
      --accent:#F7B801; --success:#06D6A0;
      --danger:#ef4444; --muted:#94a3b8;
      --bg:#0A0E27; --bg-light:#1a1f3a;
      --card-bg:rgba(255,255,255,.05); --border:rgba(255,255,255,.1);
      --text:#fff; --text-secondary:#B8C5D6;
      --slot-h: 148px;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .container{max-width:480px;margin:0 auto;min-height:100vh}
    .topbar{display:flex;justify-content:flex-end;padding:10px 16px}
    .logout-btn{background:var(--card-bg);border:1px solid var(--border);color:#fff;border-radius:12px;padding:6px 10px;cursor:pointer;font-weight:700;font-size:12px}
    .header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));padding:22px 18px;border-radius:0 0 22px 22px}
    .header h1{font-size:20px;font-weight:800;margin-bottom:6px}
    .user-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);padding:6px 12px;border-radius:16px;font-size:12px;font-weight:600}
    .content{padding:18px}
    .step-indicator{display:flex;gap:8px;margin-bottom:16px}
    .step{flex:1;height:4px;background:var(--card-bg);border-radius:4px}
    .step.active{background:linear-gradient(90deg,var(--primary),var(--accent))}
    .view{display:none}
    .view.active{display:block}
    .card{background:var(--card-bg);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:14px}
    .card-title{font-size:15px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px}
    .date-selector{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
    .date-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--card-bg);border:2px solid transparent;border-radius:10px;cursor:pointer;font-size:12px}
    .date-day .day-name{font-size:9px;color:var(--text-secondary);margin-bottom:2px;text-transform:uppercase;font-weight:600}
    .date-day .day-num{font-size:14px;font-weight:700}
    .date-day.selected{background:linear-gradient(135deg,var(--primary),var(--accent));border-color:transparent}
    .date-day.today{border-color:var(--success)}
    .date-day.weekend:not(.selected), .date-day.holiday:not(.selected){background: rgba(220, 38, 38, 0.12); border-color: rgba(220, 38, 38, 0.35);}
    .date-actions{display:flex;gap:8px;margin-top:8px}
    .chip{flex:1;background:var(--card-bg);border:1px dashed var(--border);border-radius:12px;padding:8px 10px;cursor:pointer;font-size:12px;font-weight:700;color:var(--text-secondary);text-align:center}
    .chip.active{border-style:solid;border-color:var(--danger);color:#fff;background:linear-gradient(135deg,#b91c1c55,#7f1d1d55)}
    .time-picker{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .time-slot{position:relative;overflow:hidden;border-radius:16px;border:1px solid var(--border);background:var(--bg-light);min-height:var(--slot-h);padding:10px}
    .slot-inner{position:relative;z-index:1;display:grid;grid-template-rows:auto auto 1fr;gap:6px;height:100%}
    .slot-time{font-size:16px;font-weight:800}
    .time-inputs{align-self:end;display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .time-inputs input[type="time"]{width:100%;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.35);color:#fff;border-radius:10px;padding:8px 10px;font-size:14px;outline:none}
    .btn-group{display:flex;gap:10px;margin-top:14px}
    .btn{flex:1;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border:none;border-radius:12px;padding:12px;font-size:15px;font-weight:700;color:#fff;cursor:pointer}
    .btn-secondary{background:var(--card-bg);border:1px solid var(--border)}
    .btn-success{background:linear-gradient(135deg,var(--success),#05b78b)}
    .summary-card{background:linear-gradient(135deg,var(--secondary),var(--secondary-light));border:none}
    .summary-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.1)}
    .summary-row:last-child{border-bottom:none}
    .summary-works{display:flex;flex-direction:column;gap:10px}
    .summary-work{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px}
    .month-list{display:none;flex-direction:column;gap:8px;margin-top:8px}
    .month-list.open{display:flex}
    .month-item{display:flex;align-items:center;justify-content:space-between;gap:10px;background:var(--bg-light);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .mi-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
    .mi-date{min-width:46px;text-align:center;font-weight:800;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:10px;padding:4px 6px;font-size:12px}
    .mi-main{display:flex;flex-direction:column;min-width:0;flex:1}
    .mi-cant{font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mi-lav{font-size:12px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mi-right{display:flex;align-items:center;gap:8px}
    .mi-ore{font-weight:800;font-size:14px}
    /* preview "ripeti ieri" */
    .preview-card{display:none}
    .preview-card.show{display:block}
    .preview-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.08)}
    .preview-row:last-child{border-bottom:none}
    .preview-actions{display:flex;gap:8px;margin-top:12px}
    /* login card */
    .login-card{max-width:420px;margin:0 auto}
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginPage" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;">
    <div class="card login-card">
      <h2 style="margin-bottom:10px;">üîê Accesso</h2>
      <div class="card" style="padding:12px">
        <div style="display:grid;gap:8px">
          <input id="loginUser" type="text" placeholder="User" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg-light);color:#fff">
          <input id="loginPass" type="password" placeholder="Password" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg-light);color:#fff">
          <button id="loginBtn" class="btn">Entra</button>
          <div id="loginError" style="margin-top:8px;color:#ff7b7b;font-weight:700;display:none;">Credenziali errate</div>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="container" id="appContainer" style="display:none;">
    <div class="topbar"><button class="logout-btn" onclick="handleLogout()">Esci</button></div>

    <div class="header">
      <h1>‚ö° Presenze Cantiere</h1>
      <div class="user-badge"><span>üë∑</span><span id="userName">-</span></div>
    </div>

    <div class="content">
      <div class="step-indicator"><div class="step active"></div><div class="step"></div><div class="step"></div><div class="step"></div></div>

      <!-- Pagina 1 -->
      <div class="view active" id="page1">
        <div class="card">
          <div class="card-title">üìÖ Seleziona la data</div>
          <div class="date-selector" id="dateSelector"></div>
          <div class="date-actions">
            <button class="chip" onclick="repeatYesterday()">‚Üª Ripeti ieri</button>
            <button id="assenteChip" class="chip" onclick="toggleAssente()">üö´ Assente</button>
          </div>
        </div>

        <!-- Preview ripeti ieri -->
        <div class="card preview-card" id="previewCard">
          <div class="card-title">‚ö° Riepilogo di ieri</div>
          <div class="preview-row"><span>Data</span><span id="previewDate">-</span></div>
          <div class="preview-row"><span>Orario</span><span id="previewTime">-</span></div>
          <div class="preview-row"><span>Ore totali</span><span id="previewHours">-</span></div>
          <div class="preview-row"><span>Cantiere</span><span id="previewSite">-</span></div>
          <div class="preview-row"><span>Lavorazione</span><span id="previewWork">-</span></div>
          <div class="preview-actions">
            <button class="btn btn-success" onclick="confirmRepeat()">‚úì Usa questo</button>
            <button class="btn btn-secondary" onclick="cancelRepeat()">‚úó Annulla</button>
          </div>
        </div>

        <div class="card">
          <div class="card-title" id="monthTitle" style="cursor:pointer" onclick="toggleMonthList()">üìÜ Presenze del mese ‚ñæ</div>
          <div id="monthList" class="month-list"></div>
        </div>

        <div class="btn-group"><button class="btn" onclick="goFromPage1()">Avanti ‚Üí</button></div>
      </div>

      <!-- Pagina 2: orari -->
      <div class="view" id="page2">
        <div class="card">
          <div class="card-title">‚è∞ Orario di lavoro</div>
          <div class="time-picker">
            <div class="time-slot">
              <div class="slot-inner">
                <div class="slot-time" id="morningText">08:00 - 12:00</div>
                <div class="time-inputs">
                  <input type="time" id="mStart" value="08:00" min="07:00" max="15:00" step="1800" oninput="updateTimes()">
                  <input type="time" id="mEnd"   value="12:00" min="07:00" max="15:00" step="1800" oninput="updateTimes()">
                </div>
              </div>
            </div>
            <div class="time-slot">
              <div class="slot-inner">
                <div class="slot-time" id="afternoonText">13:00 - 17:00</div>
                <div class="time-inputs">
                  <input type="time" id="pStart" value="13:00" min="12:00" max="20:00" step="1800" oninput="updateTimes()">
                  <input type="time" id="pEnd"   value="17:00" min="12:00" max="20:00" step="1800" oninput="updateTimes()">
                </div>
              </div>
            </div>
          </div>
          <div class="card" style="margin-top:10px">
            <div style="text-align:center;font-size:12px;color:var(--text-secondary)">Ore totali</div>
            <div style="text-align:center;font-weight:800;font-size:24px" id="totalHours">8.0h</div>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevPage(1)">‚Üê Indietro</button>
          <button class="btn" onclick="nextPage(3)">Avanti ‚Üí</button>
        </div>
      </div>

      <!-- Pagina 3: cantieri -->
      <div class="view" id="page3">
        <div class="card">
          <div class="card-title">üèóÔ∏è Cantieri</div>
          <div id="workItems"></div>
          <button class="chip" id="addWorkBtn" onclick="addWorkItem()" style="width:100%;margin-top:10px">+ Aggiungi cantiere (max 3)</button>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevPage(2)">‚Üê Indietro</button>
          <button class="btn" onclick="nextPage(4)">Avanti ‚Üí</button>
        </div>
      </div>

      <!-- Pagina 4: riepilogo -->
      <div class="view" id="page4">
        <div class="card summary-card">
          <div class="card-title">üìã Riepilogo</div>
          <div class="summary-row"><span>Data</span><span id="summaryDate">-</span></div>
          <div class="summary-row"><span>Orario</span><span id="summaryTime">‚Äî</span></div>
          <div class="summary-row" style="border:none;display:block;padding-top:0;">
            <div style="margin-bottom:6px;color:#e2e8f0">Cantieri & lavorazioni</div>
            <div class="summary-works" id="summaryWorks"></div>
          </div>
          <div class="summary-row" style="align-items:flex-start">
            <span>Note</span>
            <span style="flex:1;max-width:60%">
              <textarea id="notesInput" placeholder="Aggiungi note..." oninput="updateSummary()" style="width:100%;min-height:60px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);border-radius:8px;color:#fff;padding:8px"></textarea>
            </span>
          </div>
          <div class="summary-row"><span>Ore totali</span><span id="summaryHours">0.0h</span></div>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevPage(3)">‚Üê Indietro</button>
          <button class="btn btn-success" onclick="submitPresence()">‚úì Conferma</button>
        </div>
      </div>
    </div>
  </div>

  <div class="success-overlay" id="successOverlay" style="display:none;position:fixed;inset:0;background:rgba(10,14,39,.95);align-items:center;justify-content:center;z-index:1000">
    <div class="card"><h2>‚ú® Presenza registrata!</h2></div>
  </div>

  <script>
    const SHEET_ID = "1WLK8tqQPAddqOm1DkTAOdtG5iFS9nYQFc3pxL0Fdc70";
    const OS_BASE  = `https://opensheet.elk.sh/${SHEET_ID}/`;
    const L0URL    = "https://script.google.com/macros/s/AKfycbxPtNkoQlypf1RKNgIAQEJPgMsmoUDVpYeIzbqMeDICK3-hsZTKrPC718hBy0o7dQDa/exec";

    let AUTH = { user:null, nome:null, ruolo:null };
    let selectedDate = new Date();
    let currentPage = 1;
    let SITE_OPTIONS = [];
    let workState = [];
    let LAST_PRESENZE = [];
    let ABSENT_MODE = false;
    let PREVIEW_DATA = null;

    // ---------- utils ----------
    function pad2(n){return String(n).padStart(2,'0');}
    function fmtISO(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;}
    function fmtHuman(d){return d.toLocaleDateString('it-IT',{day:'numeric',month:'long'})}
    function toMinutes(hhmm){if(!hhmm) return 0; const [h,m]=hhmm.split(':').map(Number); return h*60+m;}
    function diffHours(a,b){return Math.max(0,(toMinutes(b)-toMinutes(a)))/60;}
    function sameYMD(a,b){return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();}
    function addDays(d,n){const x=new Date(d); x.setDate(x.getDate()+n); return x;}
    function startOfWeekMonday(d){const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x;}
    function isWeekend(d){const g=d.getDay(); return g===0||g===6;}
    function easterDate(year){const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1;return new Date(year,month-1,day);}
    function isItalianHoliday(d){const y=d.getFullYear(); const fixed=[[1,1],[1,6],[4,25],[5,1],[6,2],[8,15],[11,1],[12,8],[12,25],[12,26]]; for(const [mm,dd] of fixed){ if(sameYMD(d,new Date(y,mm-1,dd))) return true; } return sameYMD(d, addDays(easterDate(y),1));}

    // ---------- cache locale SWR ----------
    function ymOf(date){ return date.toISOString().slice(0,7); }
    function cacheGet(key, maxAgeMs){
      try{ const raw=localStorage.getItem(key); if(!raw) return null; const obj=JSON.parse(raw); if(Date.now()-obj.t>maxAgeMs) return null; return obj.v; }catch{ return null; }
    }
    function cacheSet(key, value){ try{ localStorage.setItem(key, JSON.stringify({t:Date.now(), v:value})); }catch{} }

    // ---------- login ----------
    async function handleLogin(){
      const u=(document.getElementById('loginUser').value||'').trim();
      const p=(document.getElementById('loginPass').value||'');
      document.getElementById('loginError').style.display='none';
      try{
        const rows = await (await fetch(OS_BASE+'Credenziali')).json();
        const rec  = rows.find(r => String(r.User||'').trim()===u && String(r.Password||'')===p);
        if(!rec) throw new Error('BAD');
        AUTH.user=rec.User; AUTH.nome=rec.Nome||rec.User; AUTH.ruolo=rec.Ruolo||'';
        document.getElementById('userName').textContent=AUTH.nome;
        showApp();
        await postLoginInit();
      }catch(e){
        document.getElementById('loginError').style.display='block';
      }
    }
    function handleLogout(){ AUTH={user:null,nome:null,ruolo:null}; showLogin(); }
    function showLogin(){ document.getElementById('loginPage').style.display='flex'; document.getElementById('appContainer').style.display='none'; }
    function showApp(){   document.getElementById('loginPage').style.display='none';  document.getElementById('appContainer').style.display='block'; }

    // ---------- step nav ----------
    function setStep(p){ document.querySelectorAll('.step').forEach((el,i)=> el.classList.toggle('active', i<=p-1)); currentPage=p; window.scrollTo({top:0,behavior:'smooth'});}
    function nextPage(p){ document.getElementById('page'+currentPage).classList.remove('active'); document.getElementById('page'+p).classList.add('active'); setStep(p); updateSummary(); }
    function prevPage(p){ nextPage(p); }

    // ---------- date selector ----------
    function initDateSelector(){
      const cont = document.getElementById('dateSelector'); cont.innerHTML='';
      const today = new Date(); const start = startOfWeekMonday(addDays(today,-7));
      const dayLabel=['L','M','M','G','V','S','D'];
      for(let w=0; w<2; w++){
        for(let i=0;i<7;i++){
          const d = addDays(start, w*7+i);
          const div=document.createElement('div'); div.className='date-day'; div.dataset.date=fmtISO(d);
          if(isWeekend(d)) div.classList.add('weekend');
          if(isItalianHoliday(d)) div.classList.add('holiday');
          if(sameYMD(d,today)){ div.classList.add('today','selected'); selectedDate=today; }
          div.innerHTML=`<div class="day-name">${dayLabel[i]}</div><div class="day-num">${d.getDate()}</div>`;
          div.onclick=()=> selectDate(div,d);
          cont.appendChild(div);
        }
      }
    }
    function selectDate(el,d){
      document.querySelectorAll('.date-day').forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected'); selectedDate=d; ABSENT_MODE=false; updateAssenteChip(); renderMonthList();
    }

    // ---------- assente ----------
    function toggleAssente(){ ABSENT_MODE=!ABSENT_MODE; updateAssenteChip(); }
    function updateAssenteChip(){ document.getElementById('assenteChip').classList.toggle('active', ABSENT_MODE); }
    function goFromPage1(){ ABSENT_MODE ? (updateSummary(), nextPage(4)) : nextPage(2); }

    // ---------- orari ----------
    function updateTimes(){
      const ms=document.getElementById('mStart'), me=document.getElementById('mEnd');
      const ps=document.getElementById('pStart'), pe=document.getElementById('pEnd');
      document.getElementById('morningText').textContent=`${ms.value} - ${me.value}`;
      document.getElementById('afternoonText').textContent=`${ps.value} - ${pe.value}`;
      const tot = diffHours(ms.value,me.value) + diffHours(ps.value,pe.value);
      document.getElementById('totalHours').textContent = tot.toFixed(1) + 'h';
      updateSummary();
    }

    // ---------- cantieri ----------
    function newWorkItem(){ return {id:crypto.randomUUID(), siteSelect:'', siteManual:'', work:''}; }
    async function loadCantieri(){
      const rows = await (await fetch(OS_BASE+'Cantieri')).json();
      SITE_OPTIONS = rows.map(r => r.Cantiere || r[Object.keys(r)[0]]).map(x=>String(x||'').trim()).filter(Boolean);
      workState=[newWorkItem()];
      renderWorkItems();
    }
    function renderWorkItems(){
      const wrap=document.getElementById('workItems'); wrap.innerHTML='';
      workState.forEach((it,idx)=>{
        const el=document.createElement('div'); el.className='card'; el.style.padding='12px'; el.innerHTML=`
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <div style="font-weight:700">Cantiere ${idx+1}</div>
            ${idx>0?`<button class="chip" onclick="removeWorkItem('${it.id}')">Rimuovi</button>`:''}
          </div>
          <div style="display:grid;gap:8px">
            <select onchange="onSel('${it.id}', this.value)" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg-light);color:#fff">
              <option value="">‚Äî Seleziona cantiere ‚Äî</option>
              ${SITE_OPTIONS.map(s=>`<option ${it.siteSelect===s?'selected':''}>${s}</option>`).join('')}
            </select>
            <input type="text" placeholder="Oppure scrivi il nome..." value="${(it.siteManual||'').replace(/"/g,'&quot;')}" oninput="onMan('${it.id}', this.value)" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg-light);color:#fff">
            <textarea placeholder="Descrivi la lavorazione..." oninput="onWork('${it.id}', this.value)" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg-light);color:#fff;min-height:68px">${it.work||''}</textarea>
          </div>`;
        wrap.appendChild(el);
      });
      document.getElementById('addWorkBtn').disabled = (workState.length>=3);
      updateSummary();
    }
    function addWorkItem(){ if(workState.length<3){ workState.push(newWorkItem()); renderWorkItems(); } }
    function removeWorkItem(id){ workState=workState.filter(w=>w.id!==id); if(workState.length===0) workState=[newWorkItem()]; renderWorkItems(); }
    function onSel(id,v){ const it=workState.find(w=>w.id===id); if(!it) return; it.siteSelect=v||''; if(v) it.siteManual=''; updateSummary(); }
    function onMan(id,v){ const it=workState.find(w=>w.id===id); if(!it) return; it.siteManual=v; if(v.trim()) it.siteSelect=''; updateSummary(); }
    function onWork(id,v){ const it=workState.find(w=>w.id===id); if(!it) return; it.work=v; updateSummary(); }

    // ---------- presenze: FAST GET ----------
    async function fetchMonthFast(userName, dateRef){
      const ym = dateRef.toISOString().slice(0,7);
      const url = `${L0URL}?action=month&user=${encodeURIComponent(userName)}&ym=${ym}`;
      const cacheKey = `presenze:${userName.toLowerCase()}:${ym}`;

      // 1) cache immediata
      const cached = cacheGet(cacheKey, 10*60*1000);
      if (cached) {
        LAST_PRESENZE = cached.rows.map(r => ({
          dataPresenza: new Date(r.dateISO), cantiere:r.cantiere, lavorazione:r.lavorazione, ore:r.ore, orari:r.orari
        })).sort((a,b)=> b.dataPresenza - a.dataPresenza);
        renderMonthList(); // subito
      }

      // 2) rete in background
      try{
        const res = await fetch(url);
        const json = await res.json();
        if (json && json.ok) {
          cacheSet(cacheKey, json);
          LAST_PRESENZE = json.rows.map(r => ({
            dataPresenza: new Date(r.dateISO), cantiere:r.cantiere, lavorazione:r.lavorazione, ore:r.ore, orari:r.orari
          })).sort((a,b)=> b.dataPresenza - a.dataPresenza);
          renderMonthList();
        }
      }catch(_){}
    }

    async function fetchLastFast(userName){
      const url = `${L0URL}?action=last&user=${encodeURIComponent(userName)}`;
      const cacheKey = `last:${userName.toLowerCase()}`;

      const cached = cacheGet(cacheKey, 10*60*1000);
      if (cached && cached.last) return cached.last;

      try{
        const res = await fetch(url);
        const json = await res.json();
        if (json && json.ok) { cacheSet(cacheKey, json); return json.last || null; }
      }catch(_){}
      return cached?.last || null;
    }

    // ---------- mese corrente ----------
    function toggleMonthList(){
      const list = document.getElementById('monthList');
      list.classList.toggle('open');
      const title = document.getElementById('monthTitle');
      title.textContent = `üìÜ Presenze del mese ${selectedDate.toLocaleDateString('it-IT',{month:'long'})} ${list.classList.contains('open')?'‚ñ¥':'‚ñæ'}`;
    }

    async function renderMonthList(){
      const list=document.getElementById('monthList'); list.innerHTML='';
      const y=selectedDate.getFullYear(), m=selectedDate.getMonth();
      const days=new Date(y,m+1,0).getDate();
      const today=new Date(); today.setHours(0,0,0,0);
      document.getElementById('monthTitle').textContent = `üìÜ Presenze del mese ${selectedDate.toLocaleDateString('it-IT',{month:'long'})} ‚ñæ`;

      for(let d=1; d<=days; d++){
        const dt=new Date(y,m,d);
        const entries=LAST_PRESENZE.filter(p=> sameYMD(p.dataPresenza, dt));
        const item=document.createElement('div');
        item.className='month-item';
        if(isWeekend(dt)) item.classList.add('weekend');
        if(isItalianHoliday(dt)) item.classList.add('holiday');
        if(sameYMD(dt,today)) item.classList.add('today');
        if(dt>today) item.classList.add('future');

        item.innerHTML = `
          <div class="mi-left">
            <div class="mi-date"><div>${pad2(d)}</div><div style="font-size:10px;opacity:.8">${dt.toLocaleDateString('it-IT',{month:'short'})}</div></div>
            <div class="mi-main">
              <div class="mi-cant">${entries[0]?.cantiere || (dt<today?'<span style="color:#fecaca">NON COMPILATO</span>':'' )}</div>
              <div class="mi-lav">${entries[0]?.lavorazione || ''}</div>
            </div>
          </div>
          <div class="mi-right">
            ${dt>today?'<span style="opacity:.75">FUTURO</span>': `<div class="mi-ore">${entries[0]?.ore?entries[0].ore+'h':'-'}</div>`}
          </div>`;
        list.appendChild(item);
      }
    }

    // ---------- summary ----------
    function updateSummary(){
      document.getElementById('summaryDate').textContent = fmtHuman(selectedDate);
      const worksBox=document.getElementById('summaryWorks'); worksBox.innerHTML='';
      if(ABSENT_MODE){
        document.getElementById('summaryTime').textContent='‚Äî';
        document.getElementById('summaryHours').textContent='0.0h';
        const div=document.createElement('div'); div.className='summary-work';
        div.innerHTML = `<div><strong>Cantiere:</strong> ASSENTE</div><div><strong>Lavorazione:</strong> ASSENTE</div>`;
        worksBox.appendChild(div);
        return;
      }
      const ms=document.getElementById('mStart').value, me=document.getElementById('mEnd').value;
      const ps=document.getElementById('pStart').value, pe=document.getElementById('pEnd').value;
      document.getElementById('summaryTime').textContent=`${ms}-${me} + ${ps}-${pe}`;
      let tot=diffHours(ms,me)+diffHours(ps,pe);
      document.getElementById('summaryHours').textContent = tot.toFixed(1)+'h';
      workState.forEach((w,i)=>{
        const name=(w.siteSelect||w.siteManual||'-').trim()||'-';
        const lav=(w.work||'-').trim()||'-';
        const div=document.createElement('div'); div.className='summary-work';
        div.innerHTML=`<div><strong>Cantiere ${i+1}:</strong> ${name}</div><div><strong>Lavorazione:</strong> ${lav}</div>`;
        worksBox.appendChild(div);
      });
    }

    // ---------- quick: ripeti ieri (usa endpoint last se serve) ----------
    async function repeatYesterday(){
      const yest = addDays(new Date(), -1);
      let found = LAST_PRESENZE.find(p=> sameYMD(p.dataPresenza,yest));
      if(!found){ found = await fetchLastFast(AUTH.nome || AUTH.user || ''); }
      if(!found){ alert('Nessuna presenza trovata per ieri'); return; }

      PREVIEW_DATA = found;
      document.getElementById('previewDate').textContent = fmtHuman(yest);
      document.getElementById('previewTime').textContent = found.orari || '-';
      document.getElementById('previewHours').textContent = (found.ore?Number(found.ore).toFixed(1)+'h':'-');
      document.getElementById('previewSite').textContent = found.cantiere || '-';
      document.getElementById('previewWork').textContent = found.lavorazione || '-';
      document.getElementById('previewCard').classList.add('show');
      document.getElementById('previewCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    function confirmRepeat(){
      if(!PREVIEW_DATA) return;
      const yest = addDays(new Date(), -1);
      selectedDate = yest;
      document.querySelectorAll('.date-day').forEach(dd=> dd.classList.toggle('selected', dd.dataset.date===fmtISO(yest)));
      ABSENT_MODE=false; updateAssenteChip();

      const parts=(PREVIEW_DATA.orari||'').split('+').map(s=>s.trim());
      const [m1,p1]=parts;
      if(m1){ const [a,b]=m1.split('-'); document.getElementById('mStart').value=a; document.getElementById('mEnd').value=b; }
      if(p1){ const [c,d]=p1.split('-'); document.getElementById('pStart').value=c; document.getElementById('pEnd').value=d; }
      workState=[newWorkItem()];
      const cantiere=PREVIEW_DATA.cantiere||'';
      if(SITE_OPTIONS.includes(cantiere)){ workState[0].siteSelect=cantiere; workState[0].siteManual=''; }
      else { workState[0].siteManual=cantiere; workState[0].siteSelect=''; }
      workState[0].work=PREVIEW_DATA.lavorazione||'';
      renderWorkItems();
      updateTimes();

      document.getElementById('previewCard').classList.remove('show');
      PREVIEW_DATA=null;
      nextPage(2);
    }
    function cancelRepeat(){ document.getElementById('previewCard').classList.remove('show'); PREVIEW_DATA=null; }

    // ---------- submit ----------
    async function submitPresence(){
      const notes = (document.getElementById('notesInput')?.value || '').trim();
      if(ABSENT_MODE){
        const body={ dataISO: fmtISO(selectedDate), orari: "-", operaio: AUTH.nome||AUTH.user||"", user: AUTH.user||"", cantiere:"ASSENTE", lavorazione:"ASSENTE", ore:0, note:notes };
        try{ await fetch(L0URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});}catch(_){}
      }else{
        const ms=document.getElementById('mStart').value, me=document.getElementById('mEnd').value;
        const ps=document.getElementById('pStart').value, pe=document.getElementById('pEnd').value;
        const tot=diffHours(ms,me)+diffHours(ps,pe);
        const lavori=workState.map(w=>({cantiere:(w.siteSelect||w.siteManual||'').trim(), lavorazione:(w.work||'').trim()})).filter(x=>x.cantiere||x.lavorazione);
        if(lavori.length===0){ alert('Inserisci almeno un cantiere e una lavorazione.'); return; }
        const quota = tot / lavori.length;
        for(const w of lavori){
          const body={ dataISO: fmtISO(selectedDate), orari:`${ms}-${me} + ${ps}-${pe}`, operaio: AUTH.nome||AUTH.user||"", user: AUTH.user||"", cantiere:w.cantiere, lavorazione:w.lavorazione, ore:Number(quota.toFixed(2)), note:notes };
          try{ await fetch(L0URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});}catch(_){}
          await new Promise(r=>setTimeout(r,100));
        }
      }
      document.getElementById('successOverlay').style.display='flex';
      setTimeout(async ()=>{
        document.getElementById('successOverlay').style.display='none';
        await fetchMonthFast(AUTH.nome || AUTH.user || '', selectedDate); // ricarica mese corrente (cache invalidata lato server)
        nextPage(1);
      }, 700);
    }

    // ---------- init ----------
    document.addEventListener('DOMContentLoaded', async ()=>{
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('loginUser').addEventListener('keypress', e=>{ if(e.key==='Enter') handleLogin(); });
      document.getElementById('loginPass').addEventListener('keypress', e=>{ if(e.key==='Enter') handleLogin(); });
      document.getElementById('previewCard')?.classList.remove('show');
    });

    // ---------- post-login ----------
    async function postLoginInit(){
      initDateSelector();
      await loadCantieri();
      // carico mese + ultimo in parallelo
      const [ _m, last ] = await Promise.all([
        fetchMonthFast(AUTH.nome || AUTH.user || '', selectedDate),
        fetchLastFast(AUTH.nome || AUTH.user || '')
      ]);
      // opzionale: potresti usare "last" per una anteprima all'avvio
      workState=[newWorkItem()];
      renderWorkItems();
      updateTimes();
      updateSummary();
    }
  </script>
</body>
</html>
