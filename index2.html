<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Presenze Cantiere</title>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{
      --primary:#FF6B35; --primary-dark:#E55A2B;
      --secondary:#004E89; --secondary-light:#1A659E;
      --accent:#F7B801; --success:#06D6A0;
      --bg:#0A0E27; --bg-light:#1a1f3a;
      --card-bg:rgba(255,255,255,.05); --border:rgba(255,255,255,.1);
      --text:#fff; --text-secondary:#B8C5D6;
      --zoom:1;
      --morning-grad: linear-gradient(135deg,#4da3ff,#5bc0eb);
      --afternoon-grad: linear-gradient(135deg,var(--primary),var(--accent));
      --slot-h: 160px; --radius: 20px;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;min-height:100vh;position:relative;padding-bottom: env(safe-area-inset-bottom, 0);touch-action: manipulation;}
    body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:
      radial-gradient(circle at 20% 50%,rgba(255,107,53,.15)0%,transparent 50%),
      radial-gradient(circle at 80% 80%,rgba(0,78,137,.15)0%,transparent 50%),
      radial-gradient(circle at 40% 20%,rgba(247,184,1,.1)0%,transparent 50%);
      animation:drift 20s ease-in-out infinite;z-index:0}
    @keyframes drift{0%,100%{transform:translate(0,0) rotate(0)}33%{transform:translate(30px,-30px) rotate(5deg)}66%{transform:translate(-20px,20px) rotate(-5deg)}}
    .container{position:relative;z-index:1;max-width:480px;margin:0 auto;min-height:100vh;transform: scale(var(--zoom));transform-origin: top center;width: calc(100vw / var(--zoom));min-height: calc(100vh / var(--zoom));will-change: transform,width;}
    .header{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);padding:50px 24px 32px;border-radius:0 0 32px 32px;box-shadow:0 10px 40px rgba(255,107,53,.3);position:relative;overflow:hidden}
    .header::before{content:'';position:absolute;top:-50%;right:-20%;width:200px;height:200px;background:rgba(255,255,255,.1);border-radius:50%;animation:float 6s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-20px) scale(1.1)}}
    .header h1{font-size:26px;font-weight:800;margin-bottom:6px}
    .header .subtitle{color:rgba(255,255,255,.9);font-size:15px;font-weight:500}
    .user-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);padding:6px 14px;border-radius:20px;margin-top:12px;font-size:13px;font-weight:600}
    .content{padding:20px}
    .step-indicator{display:flex;justify-content:space-between;margin-bottom:24px;padding:0 8px}
    .step{flex:1;height:4px;background:var(--card-bg);border-radius:4px;margin:0 4px;position:relative;overflow:hidden;transition:.3s}
    .step.active{background:linear-gradient(90deg,var(--primary),var(--accent))}
    .step.active::after{content:'';position:absolute;top:0;left:0;height:100%;width:30%;background:rgba(255,255,255,.5);animation:shimmer 1.5s infinite}
    .topbar{display:flex;justify-content:flex-end;align-items:center;padding:10px 16px;gap:8px}
    .logout-btn{background:var(--card-bg);border:1px solid var(--border);color:#fff;border-radius:12px;padding:6px 10px;cursor:pointer;font-weight:700;font-size:12px}
    .card{background:var(--card-bg);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:20px;padding:20px;margin-bottom:16px;box-shadow:0 8px 32px rgba(0,0,0,.2)}
    .card-title{font-size:16px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
    .card-title .icon{font-size:20px}
    .date-selector{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:12px}
    .date-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--card-bg);border:2px solid transparent;border-radius:10px;cursor:pointer;transition:.2s;font-size:13px}
    .date-day .day-name{font-size:9px;color:var(--text-secondary);margin-bottom:3px;text-transform:uppercase;font-weight:600}
    .date-day .day-num{font-size:15px;font-weight:700}
    .date-day:hover{border-color:var(--primary);transform:scale(1.05)}
    .date-day.selected{background:linear-gradient(135deg,var(--primary),var(--accent));border-color:transparent;transform:scale(1.05);box-shadow:0 4px 20px rgba(255,107,53,.4)}
    .date-day.today{border-color:var(--success)}
    .date-day.weekend:not(.selected), .date-day.holiday:not(.selected){background: rgba(220, 38, 38, 0.12); border-color: rgba(220, 38, 38, 0.35);}
    .time-picker{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .time-slot{position:relative;overflow:hidden;border-radius:16px;border:2px solid var(--border);box-shadow:0 8px 24px rgba(0,0,0,.15);min-height:var(--slot-h);padding:12px;background:var(--bg-light)}
    .time-slot.morning .slot-bg{background:var(--morning-grad)}
    .time-slot.afternoon .slot-bg{background:var(--afternoon-grad)}
    .slot-bg{position:absolute;inset:0;opacity:.9;border-radius:14px}
    .slot-inner{position:relative;z-index:1;display:grid;grid-template-rows:auto auto 1fr;gap:8px;height:100%}
    .slot-head{display:flex;align-items:center;gap:8px}
    .slot-head .icon{font-size:24px}
    .slot-head .label{font-size:13px;font-weight:700;letter-spacing:.2px}
    .slot-time{font-size:18px;font-weight:800}
    .time-inputs{align-self:end;display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .time-inputs input[type="time"]{width:100%;background:rgba(0,0,0,.25);border:2px solid rgba(255,255,255,.35);color:#fff;border-radius:10px;padding:8px 10px;font-size:14px;outline:none;transition:.2s}
    .time-inputs input[type="time"]:focus{border-color:#fff;box-shadow:0 0 0 3px rgba(255,255,255,.25)}
    .input-group{position:relative;margin-top:12px}
    .input-group input,.input-group textarea,.input-group select{width:100%;background:var(--bg-light);border:2px solid var(--border);border-radius:14px;padding:12px 16px 12px 42px;font-size:14px;color:var(--text);font-family:inherit;transition:.2s}
    .input-group select{padding-left:42px;appearance:none}
    .input-group textarea{resize:vertical;min-height:80px}
    .input-group input:focus,.input-group textarea:focus,.input-group select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(255,107,53,.1)}
    .input-group .input-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:18px;color:var(--text-secondary)}
    .input-group textarea + .input-icon{top:16px;transform:none}
    .btn-group{display:flex;gap:10px;margin-top:20px}
    .btn{flex:1;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border:none;border-radius:14px;padding:14px;font-size:15px;font-weight:700;color:var(--text);cursor:pointer;transition:.2s cubic-bezier(.4,0,.2,1);box-shadow:0 4px 16px rgba(255,107,53,.3);display:flex;align-items:center;justify-content:center;gap:8px}
    .btn-secondary{background:var(--card-bg);border:2px solid var(--border);box-shadow:none}
    .btn-success{background:linear-gradient(135deg,var(--success),#05b78b)}
    .btn:active{transform:scale(.97)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .total-hours-badge{margin-top:12px;padding:12px;background:var(--bg-light);border-radius:12px;text-align:center}
    .total-hours-badge .label{color:var(--text-secondary);font-size:12px;margin-bottom:2px}
    .total-hours-badge .value{font-size:26px;font-weight:800;color:var(--accent)}
    .work-item{background:var(--bg-light);border:1px solid var(--border);border-radius:14px;padding:14px;margin-top:10px;position:relative}
    .work-item-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .work-item-title{font-weight:700;font-size:14px}
    .work-item-remove{background:rgba(220,38,38,.2);border:1px solid rgba(220,38,38,.4);color:#ff6b6b;border-radius:8px;padding:4px 10px;font-size:12px;cursor:pointer;font-weight:600}
    .add-work-btn{width:100%;background:var(--card-bg);border:2px dashed var(--border);border-radius:12px;padding:12px;margin-top:12px;color:var(--text-secondary);cursor:pointer;font-weight:600;font-size:13px;transition:.2s}
    .add-work-btn:hover{border-color:var(--primary);color:var(--primary)}
    .add-work-btn:disabled{opacity:.4;cursor:not-allowed}
    .summary-card{background:linear-gradient(135deg,var(--secondary),var(--secondary-light));border:none;padding:24px}
    .summary-row{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid rgba(255,255,255,.1)}
    .summary-row:last-child{border-bottom:none;padding-bottom:0}
    .summary-label{font-size:13px;color:rgba(255,255,255,.8);font-weight:600}
    .summary-value{font-size:16px;font-weight:700}
    .summary-works{display:flex;flex-direction:column;gap:10px}
    .summary-work{display:flex;flex-direction:column;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:10px}
    .summary-work .line{display:flex;justify-content:space-between;gap:8px}
    .summary-work .label{color:rgba(255,255,255,.7);font-size:11px}
    .summary-work .value{font-weight:700;font-size:13px}
    .month-toggle{display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--card-bg);border:1px dashed var(--border);border-radius:14px;padding:12px 14px;cursor:pointer}
    .month-toggle span{font-weight:700;font-size:14px}
    .month-list{display:none;flex-direction:column;gap:10px;margin-top:10px}
    .month-list.open{display:flex}
    .month-item{display:flex;align-items:center;justify-content:space-between;gap:10px;background:var(--bg-light);border:1px solid var(--border);border-radius:14px;padding:10px 12px}
    .mi-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
    .mi-date{min-width:48px;text-align:center;font-weight:800;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:10px;padding:4px 6px;font-size:13px}
    .mi-main{display:flex;flex-direction:column;min-width:0;flex:1}
    .mi-cant{font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mi-lav{font-size:12px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mi-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
    .mi-ore{font-weight:800;font-size:14px}
    .mi-btn{background:linear-gradient(135deg,var(--secondary),var(--secondary-light));border:none;border-radius:10px;color:#fff;padding:6px 10px;cursor:pointer;font-size:12px;font-weight:600}
    .month-item.weekend, .month-item.holiday{
      background:linear-gradient(0deg, rgba(220, 38, 38, 0.12), rgba(220, 38, 38, 0.12)), var(--bg-light);
      border-color: rgba(220, 38, 38, 0.35);
    }
    .success-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,14,39,.95);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .2s ease}
    .success-overlay.show{display:flex}
    .success-content{text-align:center;animation:popIn .4s cubic-bezier(.68,-.55,.265,1.55)}
    .success-icon{font-size:70px;margin-bottom:16px;animation:bounce 1s ease}
    .success-title{font-size:24px;font-weight:800;margin-bottom:10px}
    .success-message{font-size:14px;color:var(--text-secondary)}
    .view{display:none}
    .view.active{display:block;animation:fadeIn .2s ease}
    #loginPage { position:relative; z-index:2; }
    #appContainer { position:relative; z-index:1; }
    .quick-actions{display:flex;gap:8px;margin-top:10px}
    .quick-btn{flex:1;background:var(--card-bg);border:1px solid var(--border);border-radius:10px;padding:8px;font-size:12px;font-weight:600;color:var(--text-secondary);cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:6px}
    .quick-btn:hover{border-color:var(--primary);color:var(--primary)}
    .smart-hint{background:rgba(247,184,1,.15);border:1px solid rgba(247,184,1,.3);border-radius:10px;padding:8px 12px;margin-bottom:12px;font-size:12px;color:var(--accent);display:flex;align-items:center;gap:8px}
    @media (max-width:480px){.header{padding:40px 20px 28px}.content{padding:16px}.card{padding:16px}}
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginPage" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;">
    <div style="width:100%;max-width:420px;background:var(--card-bg);border:1px solid var(--border);border-radius:24px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,.25)">
      <h2 style="margin-bottom:12px;">🔐 Accesso</h2>
      <p style="color:var(--text-secondary);margin-bottom:16px">Inserisci le credenziali</p>
      <div class="input-group">
        <span class="input-icon">👤</span>
        <input id="loginUser" type="text" placeholder="User">
      </div>
      <div class="input-group">
        <span class="input-icon">🔒</span>
        <input id="loginPass" type="password" placeholder="Password">
      </div>
      <div class="btn-group" style="margin-top:18px;">
        <button id="loginBtn" class="btn" type="button">Entra</button>
      </div>
      <div id="loginError" style="margin-top:12px;color:#ff7b7b;font-weight:700;display:none;">Credenziali errate</div>
    </div>
  </div>

  <!-- APP -->
  <div class="container" id="appContainer" style="display:none;">
    <div class="topbar">
      <button class="logout-btn" onclick="handleLogout()">Esci</button>
    </div>

    <div class="header">
      <h1>⚡ Presenze Cantiere</h1>
      <p class="subtitle">Registra velocemente la tua giornata</p>
      <div class="user-badge"><span>👷</span><span id="userName">-</span></div>
    </div>

    <div class="content">
      <div class="step-indicator">
        <div class="step active"></div>
        <div class="step"></div>
        <div class="step"></div>
        <div class="step"></div>
      </div>

      <!-- Pagina 1: DATA -->
      <div class="view active" id="page1">
        <div class="card">
          <div class="card-title"><span class="icon">📅</span><span>Seleziona la data</span></div>
          <div class="date-selector" id="dateSelector"></div>
          <div class="quick-actions">
            <button class="quick-btn" onclick="repeatYesterday()">↻ Ripeti ieri</button>
          </div>
        </div>

        <div class="card">
          <div class="month-toggle" id="monthToggle">
            <span id="monthTitle">📆 Presenze del mese</span>
            <strong id="monthToggleArrow">▼</strong>
          </div>
          <div id="monthList" class="month-list"></div>
        </div>

        <div class="btn-group">
          <button class="btn" onclick="nextPage(2)">Avanti <span>→</span></button>
        </div>
      </div>

      <!-- Pagina 2: ORARI -->
      <div class="view" id="page2">
        <div id="smartHint" class="smart-hint" style="display:none;">
          <span>💡</span>
          <span id="smartHintText"></span>
        </div>

        <div class="card">
          <div class="card-title"><span class="icon">⏰</span><span>Orario di lavoro</span></div>

          <div class="time-picker">
            <div class="time-slot morning">
              <div class="slot-bg"></div>
              <div class="slot-inner">
                <div class="slot-head"><span class="icon">☀️</span><div class="label">Mattina</div></div>
                <div class="slot-time" id="morningText">08:00 - 12:00</div>
                <div class="time-inputs">
                  <input type="time" id="mStart" value="08:00" min="07:00" max="15:00" step="1800" oninput="updateTimes()">
                  <input type="time" id="mEnd"   value="12:00" min="07:00" max="15:00" step="1800" oninput="updateTimes()">
                </div>
              </div>
            </div>

            <div class="time-slot afternoon">
              <div class="slot-bg"></div>
              <div class="slot-inner">
                <div class="slot-head"><span class="icon">🌙</span><div class="label">Pomeriggio</div></div>
                <div class="slot-time" id="afternoonText">13:00 - 17:00</div>
                <div class="time-inputs">
                  <input type="time" id="pStart" value="13:00" min="12:00" max="20:00" step="1800" oninput="updateTimes()">
                  <input type="time" id="pEnd"   value="17:00" min="12:00" max="20:00" step="1800" oninput="updateTimes()">
                </div>
              </div>
            </div>
          </div>

          <div class="total-hours-badge">
            <div class="label">Ore totali</div>
            <div class="value" id="totalHours">8.0h</div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevPage(1)"><span>←</span> Indietro</button>
          <button class="btn" onclick="nextPage(3)">Avanti <span>→</span></button>
        </div>
      </div>

      <!-- Pagina 3: CANTIERI -->
      <div class="view" id="page3">
        <div class="card">
          <div class="card-title"><span class="icon">🏗️</span><span>Cantieri</span></div>
          <div id="workItems"></div>
          <button class="add-work-btn" id="addWorkBtn" onclick="addWorkItem()">+ Aggiungi cantiere (max 3)</button>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevPage(2)"><span>←</span> Indietro</button>
          <button class="btn" onclick="nextPage(4)">Avanti <span>→</span></button>
        </div>
      </div>

      <!-- Pagina 4: NOTE + RIEPILOGO -->
      <div class="view" id="page4">
        <div class="card">
          <div class="card-title"><span class="icon">🗒️</span><span>Note (facoltative)</span></div>
          <div class="input-group">
            <span class="input-icon">✏️</span>
            <textarea id="notesInput" placeholder="Aggiungi eventuali note..." oninput="updateSummary()"></textarea>
          </div>
        </div>

        <div class="card summary-card">
          <div class="card-title" style="color:#fff;margin-bottom:20px;"><span class="icon">📋</span><span>Riepilogo</span></div>
          <div class="summary-row"><span class="summary-label">Data</span><span class="summary-value" id="summaryDate">Oggi</span></div>
          <div class="summary-row"><span class="summary-label">Orario</span><span class="summary-value" id="summaryTime">08:00 - 17:00</span></div>
          <div style="margin-top:10px"></div>
          <div class="summary-row" style="border:none;display:block;padding-top:0;">
            <div class="summary-label" style="margin-bottom:8px">Cantieri & lavorazioni</div>
            <div class="summary-works" id="summaryWorks"></div>
          </div>
          <div class="summary-row"><span class="summary-label">Note</span><span class="summary-value" id="summaryNotes">-</span></div>
          <div class="summary-row"><span class="summary-label">Ore totali</span><span class="summary-value" style="color:var(--accent);" id="summaryHours">8.0h</span></div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevPage(3)"><span>←</span> Indietro</button>
          <button class="btn btn-success" onclick="submitPresence()"><span>✓</span> Conferma</button>
        </div>
      </div>
    </div>
  </div>

  <div class="success-overlay" id="successOverlay">
    <div class="success-content">
      <div class="success-icon">✨</div>
      <div class="success-title">Presenza registrata!</div>
      <div class="success-message">La tua giornata è stata salvata</div>
    </div>
  </div>

  <script>
    const SHEET_ID = "1WLK8tqQPAddqOm1DkTAOdtG5iFS9nYQFc3pxL0Fdc70";
    const OS_BASE  = `https://opensheet.elk.sh/${SHEET_ID}/`;
    const L0URL    = "https://script.google.com/macros/s/AKfycbxPtNkoQlypf1RKNgIAQEJPgMsmoUDVpYeIzbqMeDICK3-hsZTKrPC718hBy0o7dQDa/exec";

    let AUTH = { user:null, nome:null, ruolo:null };
    let selectedDate = new Date();
    let currentPage = 1;
    let workState = [];
    let SITE_OPTIONS = [];
    let LAST_PRESENZE = [];

    // --------- Utils ----------
    function pad2(n){return String(n).padStart(2,'0');}
    function fmtISO(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;}
    function fmtDateHuman(d){return d.toLocaleDateString('it-IT',{day:'numeric',month:'short'});}
    function toMinutes(hhmm){if(!hhmm)return 0;const [h,m]=hhmm.split(':').map(Number);return h*60+m;}
    function diffHours(s,e){const a=toMinutes(s),b=toMinutes(e);return Math.max(0,(b-a))/60;}
    function addDays(date,n){const d=new Date(date);d.setDate(d.getDate()+n);return d;}
    function sameYMD(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}
    function easterDate(year){const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1;return new Date(year,month-1,day);}
    function isItalianHoliday(d){const y=d.getFullYear();const fixed=[[1,1],[1,6],[4,25],[5,1],[6,2],[8,15],[11,1],[12,8],[12,25],[12,26]];for(const[mm,dd]of fixed){if(sameYMD(d,new Date(y,mm-1,dd)))return true;}const easter=easterDate(y);return sameYMD(d,addDays(easter,1));}
    function isWeekend(d){const day=d.getDay();return day===0||day===6;}
    function clampTime(val,min,max){const v=toMinutes(val),mi=toMinutes(min),ma=toMinutes(max);if(v<mi)return min;if(v>ma)return max;return val;}

    // Parser robusto: Date | yyyy-mm-dd | dd/mm/yyyy (con o senza ora)
    function parseDateFlex(v){
      if (v instanceof Date) return v;
      if (typeof v !== 'string') return new Date(NaN);
      const s = v.trim();
      // yyyy-mm-dd...
      if (/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s);
      // dd/mm/yyyy (eventuale spazio + ora)
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2}))?/);
      if (m){
        const d = Number(m[1]), mo = Number(m[2])-1, y = Number(m[3]);
        const hh = m[4]?Number(m[4]):0, mm = m[5]?Number(m[5]):0;
        return new Date(y, mo, d, hh, mm, 0, 0);
      }
      // fallback
      return new Date(s);
    }

    // --------- Auto-scale ----------
    function applyAutoScale(){const base=420,w=Math.max(320,Math.min(window.innerWidth,1024));const scale=Math.max(1,Math.min(1.35,w/base));document.documentElement.style.setProperty('--zoom',scale.toFixed(3));}
    window.addEventListener('resize', applyAutoScale, {passive:true});
    window.addEventListener('orientationchange', applyAutoScale);

    // --------- Login ----------
    async function handleLogin(){
      const u = (document.getElementById('loginUser').value||'').trim();
      const p = document.getElementById('loginPass').value||'';
      document.getElementById('loginError').style.display='none';
      try{
        const res = await fetch(OS_BASE+'Credenziali');
        const rows = await res.json();
        const rec  = rows.find(r => String(r.User||'').trim()===u && String(r.Password||'')===p);
        if(!rec) throw new Error('BAD_CREDENTIALS');
        AUTH.user  = rec.User;
        AUTH.nome  = rec.Nome || rec.User;
        AUTH.ruolo = rec.Ruolo || '';
        document.getElementById('userName').textContent = AUTH.nome;
        showApp();
        await postLoginInit();
      }catch(e){
        console.error(e);
        document.getElementById('loginError').style.display='block';
      }
    }
    function handleLogout(){ AUTH={user:null,nome:null,ruolo:null}; showLogin(); }
    function showLogin(){ document.getElementById('loginPage').style.display='flex'; document.getElementById('appContainer').style.display='none'; }
    function showApp(){   document.getElementById('loginPage').style.display='none';  document.getElementById('appContainer').style.display='block'; }

    // --------- Navigazione a step ----------
    function setStepBar(p){
      document.querySelectorAll('.step').forEach((s,i)=> s.classList.toggle('active', i <= (p-1)));
    }
    function nextPage(p){
      const cur = document.getElementById('page'+currentPage);
      const nxt = document.getElementById('page'+p);
      if (cur) cur.classList.remove('active');
      if (nxt) nxt.classList.add('active');
      currentPage = p;
      setStepBar(p);
      updateSummary();
      window.scrollTo({top:0, behavior:'smooth'});
    }
    function prevPage(p){ nextPage(p); }

    // --------- Post-login init ----------
    async function postLoginInit(){
      applyAutoScale();
      initDateSelector();
      setupMonthToggle();
      workState = [ newWorkItem() ];
      updateTimes();
      await loadCantieri();
      await loadPresenze();
      await renderMonthList();
    }

    // --------- Smart defaults / quick actions ----------
    async function applySmartDefaults(){
      if(LAST_PRESENZE.length === 0) return;
      const last = LAST_PRESENZE[0]; // più recente

      const parts = (last.orari||'').split('+').map(s=>s.trim());
      const [m,p] = parts;
      if(m){ const [ms,me] = m.split('-'); document.getElementById('mStart').value = ms; document.getElementById('mEnd').value = me; }
      if(p){ const [ps,pe] = p.split('-'); document.getElementById('pStart').value = ps; document.getElementById('pEnd').value = pe; }
      updateTimes();

      const c = last.cantiere || '';
      workState[0].siteSelect = SITE_OPTIONS.includes(c) ? c : '';
      workState[0].siteManual = SITE_OPTIONS.includes(c) ? '' : c;
      workState[0].work = last.lavorazione || '';
      renderWorkItems();

      showSmartHint(`Pre-compilato con ultima presenza (${fmtDateHuman(last.dataPresenza)})`);
    }
    function showSmartHint(text){
      document.getElementById('smartHintText').textContent = text;
      document.getElementById('smartHint').style.display = 'flex';
      setTimeout(()=> document.getElementById('smartHint').style.display='none', 4000);
    }
    async function repeatYesterday(){
      const yesterday = addDays(new Date(), -1);
      const found = LAST_PRESENZE.find(p => sameYMD(p.dataPresenza, yesterday));
      if(!found){ alert('Nessuna presenza trovata per ieri'); return; }

      selectedDate = yesterday;
      document.querySelectorAll('.date-day').forEach(dd =>
        dd.classList.toggle('selected', dd.dataset.date===fmtISO(yesterday))
      );

      const parts = (found.orari||'').split('+').map(s=>s.trim());
      const [m,p] = parts;
      if(m){ const [ms,me] = m.split('-'); document.getElementById('mStart').value=ms; document.getElementById('mEnd').value=me; }
      if(p){ const [ps,pe] = p.split('-'); document.getElementById('pStart').value=ps; document.getElementById('pEnd').value=pe; }
      updateTimes();

      const c = found.cantiere || '';
      workState[0].siteSelect = SITE_OPTIONS.includes(c) ? c : '';
      workState[0].siteManual = SITE_OPTIONS.includes(c) ? '' : c;
      workState[0].work = found.lavorazione || '';
      renderWorkItems();

      showSmartHint(`Ripetuta presenza di ieri (${fmtDateHuman(yesterday)})`);
      nextPage(2);
    }

    // --------- Date selector ----------
    function initDateSelector(){
      const selector = document.getElementById('dateSelector');
      selector.innerHTML = '';
      const today = new Date();
      const dayLetter = ['D','L','M','M','G','V','S'];
      for(let i=13; i>=0; i--){
        const d = new Date(today); d.setDate(today.getDate() - i);
        const dayDiv = document.createElement('div');
        dayDiv.className = 'date-day'; dayDiv.dataset.date = fmtISO(d);
        if(isWeekend(d)) dayDiv.classList.add('weekend');
        if(isItalianHoliday(d)) dayDiv.classList.add('holiday');
        if(i===0){ dayDiv.classList.add('today','selected'); selectedDate = today; }
        dayDiv.innerHTML = `<div class="day-name">${dayLetter[d.getDay()]}</div><div class="day-num">${d.getDate()}</div>`;
        dayDiv.onclick = () => selectDate(dayDiv, d);
        selector.appendChild(dayDiv);
      }
      const last = selector.lastElementChild;
      if(last && last.scrollIntoView){ last.scrollIntoView({behavior:'instant',block:'nearest',inline:'end'}); }
    }
    function selectDate(el, date){
      document.querySelectorAll('.date-day').forEach(d => d.classList.remove('selected'));
      el.classList.add('selected');
      selectedDate = date;
      renderMonthList();
    }

    // --------- Orari ----------
    function updateTimes(){
      const mStartEl = document.getElementById('mStart');
      const mEndEl   = document.getElementById('mEnd');
      const pStartEl = document.getElementById('pStart');
      const pEndEl   = document.getElementById('pEnd');
      mStartEl.value = clampTime(mStartEl.value, mStartEl.min, mStartEl.max);
      mEndEl.value   = clampTime(mEndEl.value,   mEndEl.min,   mEndEl.max);
      pStartEl.value = clampTime(pStartEl.value, pStartEl.min, pStartEl.max);
      pEndEl.value   = clampTime(pEndEl.value,   pEndEl.min,   pEndEl.max);
      document.getElementById('morningText').textContent   = `${mStartEl.value} - ${mEndEl.value}`;
      document.getElementById('afternoonText').textContent = `${pStartEl.value} - ${pEndEl.value}`;
      const hours = diffHours(mStartEl.value, mEndEl.value) + diffHours(pStartEl.value, pEndEl.value);
      document.getElementById('totalHours').textContent = hours.toFixed(1) + 'h';
      updateSummary();
    }
    function buildOrariString(){
      const ms = document.getElementById('mStart').value;
      const me = document.getElementById('mEnd').value;
      const ps = document.getElementById('pStart').value;
      const pe = document.getElementById('pEnd').value;
      return `${ms}-${me} + ${ps}-${pe}`;
    }

    // --------- Cantieri ----------
    function newWorkItem(){ return {id:crypto.randomUUID(), siteSelect:'', siteManual:'', work:''}; }
    async function loadCantieri(){
      try{
        const res = await fetch(OS_BASE+'Cantieri');
        const rows = await res.json();
        SITE_OPTIONS = rows.map(r => r.Cantiere || r[Object.keys(r)[0]])
          .map(x => String(x||'').trim()).filter(Boolean);
        renderWorkItems();
      }catch(e){ console.error('Cantieri error:', e); }
    }
    function renderWorkItems(){
      const wrap = document.getElementById('workItems');
      wrap.innerHTML = '';
      workState.forEach((item, idx) => {
        const el = document.createElement('div');
        el.className = 'work-item'; el.dataset.id = item.id;
        el.innerHTML = `
          <div class="work-item-head">
            <div class="work-item-title">Cantiere ${idx+1}</div>
            ${idx>0 ? '<button class="work-item-remove" onclick="removeWorkItem(\''+item.id+'\')">Rimuovi</button>' : ''}
          </div>
          <div class="input-group">
            <span class="input-icon">🏷️</span>
            <select onchange="onWorkSelectChange('${item.id}', this.value)">
              <option value="">— Seleziona cantiere —</option>
              ${SITE_OPTIONS.map(s => `<option ${item.siteSelect===s?'selected':''}>${s}</option>`).join('')}
            </select>
          </div>
          <div class="input-group">
            <span class="input-icon">🔍</span>
            <input type="text" placeholder="Oppure scrivi il nome..." value="${(item.siteManual||'').replace(/"/g,'&quot;')}" oninput="onWorkManualChange('${item.id}', this.value)">
          </div>
          <div class="input-group">
            <span class="input-icon">📝</span>
            <textarea placeholder="Descrivi la lavorazione..." oninput="onWorkTextChange('${item.id}', this.value)">${item.work||''}</textarea>
          </div>`;
        wrap.appendChild(el);
      });
      document.getElementById('addWorkBtn').disabled = (workState.length >= 3);
      updateSummary();
    }
    function addWorkItem(){ if(workState.length >= 3) return; workState.push(newWorkItem()); renderWorkItems(); }
    function removeWorkItem(id){ workState = workState.filter(w => w.id !== id); if(workState.length === 0) workState.push(newWorkItem()); renderWorkItems(); }
    function onWorkSelectChange(id,val){ const it=workState.find(w=>w.id===id); if(!it) return; it.siteSelect=val||''; if(val) it.siteManual=''; updateSummary(); }
    function onWorkManualChange(id,val){ const it=workState.find(w=>w.id===id); if(!it) return; it.siteManual=val; if(val.trim()) it.siteSelect=''; updateSummary(); }
    function onWorkTextChange(id,val){ const it=workState.find(w=>w.id===id); if(!it) return; it.work=val; updateSummary(); }

    // --------- Presenze mese (OpenSheet) ----------
    async function loadPresenze(){
      try{
        const res = await fetch(OS_BASE+'Presenze');
        const rows = await res.json();
        const nome = (AUTH.nome || '').toLowerCase();

        LAST_PRESENZE = rows.map(r => {
          const dRaw = r["Data Presenza"] || r["Data"] || '';
          return {
            dataPresenza: parseDateFlex(dRaw),
            cantiere: r["Cantiere"] || '',
            lavorazione: r["Lavorazione"] || '',
            ore: r["Ore"] || '',
            orari: r["Orari"] || '',
            nome: String(r["Nome Operaio"]||'')
          };
        })
        .filter(o => o.nome.toLowerCase() === nome && o.dataPresenza instanceof Date && !isNaN(o.dataPresenza))
        .sort((a,b) => b.dataPresenza - a.dataPresenza);

      }catch(e){ console.error('loadPresenze:', e); }
    }

    async function renderMonthList(){
      const list = document.getElementById('monthList');
      list.innerHTML = '';

      const mese = selectedDate.toLocaleDateString('it-IT', {month:'long'});
      const titleEl = document.getElementById('monthTitle');
      if(titleEl) titleEl.textContent = `📆 Presenze mese ${mese}`;

      const y = selectedDate.getFullYear();
      const m = selectedDate.getMonth() + 1;

      const rows = LAST_PRESENZE.filter(r => r.dataPresenza.getFullYear()===y && (r.dataPresenza.getMonth()+1)===m);

      if(rows.length === 0){
        list.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-secondary);font-size:14px;">Nessuna presenza registrata per questo mese</div>';
        return;
      }

      rows.forEach(r => {
        const d = r.dataPresenza;
        const item = document.createElement('div');
        const cls = ['month-item'];
        if(isWeekend(d)) cls.push('weekend');
        if(isItalianHoliday(d)) cls.push('holiday');
        item.className = cls.join(' ');
        item.innerHTML = `
          <div class="mi-left">
            <div class="mi-date">
              <div>${pad2(d.getDate())}</div>
              <div style="font-size:10px;color:var(--text-secondary)">${d.toLocaleDateString('it-IT',{month:'short'})}</div>
            </div>
            <div class="mi-main">
              <div class="mi-cant">${r.cantiere || '(—)'}</div>
              <div class="mi-lav">${r.lavorazione || ''}</div>
            </div>
          </div>
          <div class="mi-right">
            <div class="mi-ore">${r.ore || '-'}h</div>
            <button class="mi-btn">Usa</button>
          </div>`;
        item.querySelector('.mi-btn').onclick = () => applyTemplateFromMonth(r);
        list.appendChild(item);
      });
    }

    function applyTemplateFromMonth(r){
      const d = r.dataPresenza;
      if(!d || isNaN(d)) return;

      selectedDate = d;
      document.querySelectorAll('.date-day').forEach(dd =>
        dd.classList.toggle('selected', dd.dataset.date === fmtISO(d))
      );

      const parts = (r.orari||'').split('+').map(s => s.trim());
      const [m,p] = parts;
      if(m){ const [ms,me] = m.split('-'); document.getElementById('mStart').value = ms; document.getElementById('mEnd').value = me; }
      if(p){ const [ps,pe] = p.split('-'); document.getElementById('pStart').value = ps; document.getElementById('pEnd').value = pe; }
      updateTimes();

      const c = r.cantiere || '';
      workState = [ newWorkItem() ];
      workState[0].siteSelect = SITE_OPTIONS.includes(c) ? c : '';
      workState[0].siteManual = SITE_OPTIONS.includes(c) ? '' : c;
      workState[0].work = r.lavorazione || '';
      renderWorkItems();

      showSmartHint(`Copiato da ${fmtDateHuman(d)}`);
      nextPage(2);
    }

    // --------- Summary ----------
    function updateSummary(){
      document.getElementById('summaryDate').textContent = fmtDateHuman(selectedDate);
      document.getElementById('summaryTime').textContent = buildOrariString();
      const box = document.getElementById('summaryWorks'); box.innerHTML='';
      workState.forEach((it, idx) => {
        const name=(it.siteSelect||it.siteManual||'-').trim()||'-';
        const work=(it.work||'-').trim()||'-';
        const div=document.createElement('div'); div.className='summary-work';
        div.innerHTML = `<div class="line"><span class="label">Cantiere ${idx+1}</span><span class="value">${name}</span></div>
                         <div class="line"><span class="label">Lavorazione</span><span class="value">${work}</span></div>`;
        box.appendChild(div);
      });
      const notes=(document.getElementById('notesInput')?.value||'').trim();
      document.getElementById('summaryNotes').textContent = notes || '-';
      const ms=document.getElementById('mStart').value, me=document.getElementById('mEnd').value;
      const ps=document.getElementById('pStart').value, pe=document.getElementById('pEnd').value;
      const hours=diffHours(ms,me)+diffHours(ps,pe);
      document.getElementById('summaryHours').textContent = hours.toFixed(1)+'h';
    }

    // --------- Submit (L0 legacy) ----------
    async function submitPresence(){
      const ms=document.getElementById('mStart').value;
      const me=document.getElementById('mEnd').value;
      const ps=document.getElementById('pStart').value;
      const pe=document.getElementById('pEnd').value;
      const oreTot=diffHours(ms,me)+diffHours(ps,pe);
      const note=(document.getElementById('notesInput').value||'').trim();

      const lavori = workState.map(w=>({
        cantiere:(w.siteSelect||w.siteManual||'').trim(),
        lavorazione:(w.work||'').trim()
      })).filter(x=>x.cantiere||x.lavorazione);

      if(lavori.length===0){ alert('Inserisci almeno un cantiere e una lavorazione.'); return; }

      const quota = lavori.length ? (oreTot / lavori.length) : 0;

      for(const w of lavori){
        const body={
          dataISO: fmtISO(selectedDate),
          orari: `${ms}-${me} + ${ps}-${pe}`,
          operaio: AUTH.nome || AUTH.user || '',
          user: AUTH.user || '',
          cantiere: w.cantiere,
          lavorazione: w.lavorazione,
          ore: Number(quota.toFixed(2)),
          note
        };
        try{
          await fetch(L0URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        }catch(_){}
        await new Promise(r=>setTimeout(r,120));
      }

      document.getElementById('successOverlay').classList.add('show');
      setTimeout(async ()=>{
        document.getElementById('successOverlay').classList.remove('show');
        await loadPresenze();
        await renderMonthList();
        nextPage(1);
      }, 900);
    }

    // --------- Month toggle ----------
    function setupMonthToggle(){
      const toggle=document.getElementById('monthToggle');
      const arrow=document.getElementById('monthToggleArrow');
      const list=document.getElementById('monthList');
      list.classList.remove('open');
      toggle.addEventListener('click', ()=>{
        const isOpen=list.classList.toggle('open');
        arrow.textContent=isOpen?'▲':'▼';
      });
    }

    // --------- Init ----------
    document.addEventListener('DOMContentLoaded', async ()=>{
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('loginUser').addEventListener('keypress', e => { if(e.key==='Enter') handleLogin(); });
      document.getElementById('loginPass').addEventListener('keypress', e => { if(e.key==='Enter') handleLogin(); });
      showLogin();
    });
  </script>
</body>
</html>
