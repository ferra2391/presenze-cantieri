<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Analisi per Cantiere - Dashboard Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --primary: hsl(210,100%,45%);
    --primary-dark: hsl(210,100%,35%);
    --text: hsl(210,15%,15%);
    --text-light: hsl(210,10%,40%);
    --muted: hsl(210,8%,50%);
    --bg: hsl(210,25%,96%);
    --card: #ffffff;
    --border: hsl(210,20%,88%);
    --border-strong: hsl(210,20%,75%);
    --orange-weak: hsla(30,100%,50%,0.12);
    --orange-border: hsla(30,100%,50%,0.3);
    --success: hsl(140,70%,40%);
    --error: hsl(0,70%,50%);
    --hover-bg: hsl(210,30%,98%);
  }
  
  * { box-sizing: border-box; }
  
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font: 16px/1.6 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }
  
  .container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 32px 40px;
  }
  
  h1 {
    margin: 0 0 24px;
    font-size: 32px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.5px;
  }

  /* CONTROL PANEL */
  .control-panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 2px 12px rgba(0,0,0,.06);
    margin-bottom: 28px;
  }
  
  .control-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
  }
  
  .control-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .nav {
    display: flex;
    gap: 10px;
  }
  
  .nav a {
    padding: 10px 18px;
    border: 2px solid var(--border);
    border-radius: 10px;
    background: var(--card);
    text-decoration: none;
    font-weight: 600;
    font-size: 15px;
    color: var(--text);
    transition: all 0.2s;
  }
  
  .nav a:hover {
    border-color: var(--primary);
    background: var(--hover-bg);
  }
  
  .nav a.primary {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }
  
  .nav a.primary:hover {
    background: var(--primary-dark);
  }
  
  input[type="month"] {
    padding: 10px 16px;
    border: 2px solid var(--border);
    border-radius: 10px;
    background: var(--card);
    font-size: 15px;
    font-weight: 500;
    min-width: 160px;
    transition: border-color 0.2s;
  }
  
  input[type="month"]:focus {
    outline: none;
    border-color: var(--primary);
  }
  
  button {
    padding: 10px 18px;
    border: 2px solid var(--border);
    border-radius: 10px;
    background: var(--card);
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    transition: all 0.2s;
    color: var(--text);
  }
  
  button:hover:not(:disabled) {
    border-color: var(--primary);
    background: var(--hover-bg);
  }
  
  button.primary {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }
  
  button.primary:hover:not(:disabled) {
    background: var(--primary-dark);
  }
  
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .spinner {
    display: none;
  }
  
  .spinner.show {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #ddd;
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: -4px;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  #status {
    margin-top: 12px;
    font-size: 15px;
  }
  
  .ok {
    color: var(--success);
    font-weight: 600;
  }
  
  .error {
    color: var(--error);
    font-weight: 600;
  }

  /* TABLE CARDS */
  .table-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,.06);
    overflow: hidden;
    margin-bottom: 28px;
  }
  
  .table-title {
    padding: 20px 24px;
    border-bottom: 2px solid var(--border);
    font-weight: 700;
    font-size: 20px;
    color: var(--text);
    background: linear-gradient(to bottom, var(--card), var(--hover-bg));
  }
  
  .table-wrap {
    overflow-x: auto;
  }

  table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    font-size: 15px;
  }
  
  thead th {
    background: var(--hover-bg);
    border-bottom: 2px solid var(--border-strong);
    padding: 16px 18px;
    text-align: left;
    white-space: nowrap;
    font-weight: 700;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-light);
  }
  
  thead th.num {
    text-align: right;
  }
  
  tbody td,
  tbody th {
    border-top: 1px solid var(--border);
    padding: 16px 18px;
    font-size: 15px;
  }
  
  tbody tr {
    transition: background-color 0.15s;
  }
  
  tbody tr:hover {
    background: var(--hover-bg);
  }
  
  td.num {
    text-align: right;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }

  .cant-link {
    color: var(--primary);
    font-weight: 700;
    font-size: 16px;
    text-decoration: none;
    cursor: pointer;
    transition: color 0.2s;
  }
  
  .cant-link:hover {
    color: var(--primary-dark);
    text-decoration: underline;
  }

  /* DETAIL SECTIONS */
  .detail-section {
    padding: 24px;
    border-bottom: 1px solid var(--border);
  }
  
  .detail-section:last-child {
    border-bottom: none;
  }
  
  .section-header {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--border);
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  
  .stat-box {
    background: var(--hover-bg);
    padding: 16px;
    border-radius: 10px;
    border: 1px solid var(--border);
  }
  
  .stat-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  
  .stat-value {
    font-size: 28px;
    font-weight: 900;
    color: var(--text);
  }

  /* OPERAI TABLE */
  .operai-table {
    margin-top: 16px;
  }
  
  .operai-table table {
    font-size: 15px;
  }

  /* CALENDARIO LAVORAZIONI (stile dettaglio operaio) */
  .detail-lav {
    font-size: 14px;
  }
  
  .detail-lav .daycell {
    white-space: nowrap;
    font-weight: 700;
    font-size: 15px;
    color: var(--text);
    min-width: 120px;
  }
  
  .detail-lav .op-name {
    font-weight: 800;
    color: #0369a1;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    font-size: 13px;
  }
  
  .detail-lav .lav {
    color: var(--text);
    margin-top: 6px;
    line-height: 1.5;
  }
  
  .detail-lav .note {
    color: var(--muted);
    font-style: italic;
    margin-top: 4px;
    font-size: 13px;
  }
  
  .detail-lav td,
  .detail-lav th {
    vertical-align: top;
    padding: 14px 16px;
  }

  /* Weekend/Festivi highlight */
  .detail-lav tr.off td {
    background: var(--orange-weak) !important;
  }

  /* Alternanza righe normali */
  .detail-lav tr.alt td {
    background: #fafafa;
  }

  /* Gabbia perimetro giorno */
  .detail-lav tr.gstart td {
    border-top: 2px solid var(--border-strong);
  }
  
  .detail-lav tr.gend td {
    border-bottom: 2px solid var(--border-strong);
  }

  .detail-lav tr.gstart td.daycell,
  .detail-lav tr.gmid td.daycell,
  .detail-lav tr.gend td.daycell {
    border-left: 2px solid var(--border-strong);
  }

  .detail-lav tr.gstart td:last-child,
  .detail-lav tr.gmid td:last-child,
  .detail-lav tr.gend td:last-child {
    border-right: 2px solid var(--border-strong);
  }

  /* Arrotondamenti */
  .detail-lav tr.gstart td.daycell {
    border-top-left-radius: 10px;
  }
  
  .detail-lav tr.gstart td:last-child {
    border-top-right-radius: 10px;
  }
  
  .detail-lav tr.gend td.daycell {
    border-bottom-left-radius: 10px;
  }
  
  .detail-lav tr.gend td:last-child {
    border-bottom-right-radius: 10px;
  }

  /* Tot giorno */
  .detail-lav tr.daytot td {
    font-weight: 800;
    background: var(--hover-bg);
  }
  
  /* Footer azioni */
  .detail-footer {
    padding: 20px 24px;
    border-top: 2px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    background: var(--hover-bg);
  }
  
  /* Empty state */
  .empty-state {
    padding: 60px 24px;
    text-align: center;
    color: var(--muted);
    font-size: 16px;
  }

  /* PDF LAYOUT container */
  .pdf-container {
    display: none;
  }

  @media print {
    body { background: white; }
    .container { padding: 20px; }
  }
</style>
</head>
<body>
<div class="container">
  <h1>üèóÔ∏è Analisi per Cantiere</h1>

  <div class="control-panel">
    <div class="control-row">
      <div class="control-left">
        <button id="prevMonth" title="Mese precedente">‚óÄ</button>
        <input type="month" id="mese" />
        <button id="nextMonth" title="Mese successivo">‚ñ∂</button>
        <button id="btnCarica" class="primary">Carica Dati</button>
        <span id="spin" class="spinner"></span>
      </div>
      <div class="nav">
        <a href="presenze.html">Presenze</a>
        <a href="operaio.html">Analisi per Operaio</a>
        <a class="primary" href="cantiere.html">Analisi per Cantiere</a>
      </div>
    </div>
    <div id="status"></div>
  </div>

  <!-- RIEPILOGO -->
  <div class="table-card">
    <div class="table-title">üìä Riepilogo Mensile</div>
    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>Cantiere</th>
            <th class="num">Ore Totali</th>
            <th class="num">Giorni Lavorati</th>
            <th class="num">Media / Giorno</th>
            <th class="num"># Operai</th>
            <th class="num">Ore Weekend/Festivi</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- DETTAGLIO -->
  <div class="table-card" id="detailCard" style="display:none">
    <div class="table-title" id="detailTitle">üèóÔ∏è Dettaglio Cantiere</div>
    
    <!-- Statistiche generali -->
    <div class="detail-section">
      <div class="section-header">üìà Statistiche Generali</div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label">Ore Totali</div>
          <div class="stat-value" id="statOreTot">0 h</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Giorni Lavorati</div>
          <div class="stat-value" id="statGiorni">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Operai Coinvolti</div>
          <div class="stat-value" id="statOperai">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Media / Giorno</div>
          <div class="stat-value" id="statMedia">0 h</div>
        </div>
      </div>
      
      <!-- Grafico andamento ore -->
      <div style="margin-top: 24px; background: white; padding: 20px; border-radius: 10px; border: 1px solid var(--border);">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700; color: var(--text);">üìä Andamento Ore Mensili</h3>
        <canvas id="chartAndamento" style="max-height: 300px;"></canvas>
      </div>
    </div>

    <!-- Operai -->
    <div class="detail-section">
      <div class="section-header">üë∑ Operai che hanno lavorato</div>
      <div class="operai-table">
        <table>
          <thead>
            <tr>
              <th>Operaio</th>
              <th class="num">Ore Totali</th>
              <th class="num">Giorni Lavorati</th>
              <th class="num">Media / Giorno</th>
            </tr>
          </thead>
          <tbody id="detailOperai"></tbody>
        </table>
      </div>
    </div>

    <!-- Lavorazioni per giorno -->
    <div class="detail-section">
      <div class="section-header">üìÖ Calendario Lavorazioni</div>
      <div class="table-wrap">
        <table id="detailLavorazioniTable" class="detail-lav">
          <thead>
            <tr>
              <th>Giorno</th>
              <th>Operaio</th>
              <th class="num">Ore</th>
              <th>Lavorazioni / Note</th>
            </tr>
          </thead>
          <tbody id="detailLavorazioni"></tbody>
        </table>
      </div>
    </div>

    <div class="detail-footer">
      <button id="btnDetailPDF">üìÑ Esporta PDF</button>
      <button id="btnCloseDetail">‚úï Chiudi Dettaglio</button>
    </div>
  </div>
</div>

<!-- Container nascosto per il PDF -->
<div id="pdfContainer" class="pdf-container"></div>

<!-- Librerie -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ====== CONFIG ====== */
const SHEET_ID = "1WLK8tqQPAddqOm1DkTAOdtG5iFS9nYQFc3pxL0Fdc70";

/* ====== UTIL ====== */
const pad = n => String(n).padStart(2,"0");

function calcEaster(Y){
  const a=Y%19,b=Math.floor(Y/100),c=Y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),
        g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,L=(32+2*e+2*i-h-k)%7,
        m=Math.floor((a+11*h+22*L)/451),month=Math.floor((h+L-7*m+114)/31),day=((h+L-7*m+114)%31)+1;
  return new Date(Y,month-1,day);
}

function italianHolidays(year){
  const set=new Set(),add=(m,d)=>set.add(`${year}-${pad(m)}-${pad(d)}`);
  add(1,1); add(1,6); add(4,25); add(5,1); add(6,2); add(8,15); add(11,1); add(12,8); add(12,25); add(12,26);
  const p=calcEaster(year), q=new Date(p); q.setDate(p.getDate()+1);
  add(p.getMonth()+1,p.getDate()); add(q.getMonth()+1,q.getDate());
  return set;
}

const normalize = s => String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim().toLowerCase();

function parseDateAny(v){
  if(!v) return null;
  if(v instanceof Date) return v;
  const s = String(v).trim();
  if(/^\d{4}-\d{2}-\d{2}/.test(s)){ const [Y,M,D]=s.split("T")[0].split("-").map(Number); return new Date(Y,M-1,D); }
  if(/^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)){ const [d,m,y]=s.split(/[ /]/).map(Number); return new Date(y,m-1,d); }
  const t = new Date(s); return isNaN(t) ? null : t;
}

function pick(row, ...names){
  if(!row) return "";
  const map = new Map(Object.keys(row).map(k => [normalize(k), k]));
  for(const name of names){
    const key = map.get(normalize(name));
    if(key && row[key] != null && row[key] !== "") return row[key];
  }
  return "";
}

function isBlankCantiere(value){
  const s = String(value||"").trim();
  if(!s) return true;
  if (/^[-‚Äì‚Äî]+$/.test(s)) return true;
  if (/^(nd|n\.d\.|n\/d|na|n\.a\.|n\/a|non\s+specificato|sconosciuto|nessuno|undefined|null)$/i.test(s)) return true;
  if (/^\(s.*cantiere\)$/i.test(s)) return true;
  return false;
}

const TIME_RANGE_RE = /\b\d{1,2}[:.]\d{2}\s*-\s*\d{1,2}[:.]\d{2}\b/g;
const stripIntervals = s => s ? String(s).replace(TIME_RANGE_RE,"").replace(/\s{2,}/g," ").trim() : "";

/* ====== STATE & UI refs ====== */
const meseInput = document.getElementById('mese');
const prevBtn   = document.getElementById('prevMonth');
const nextBtn   = document.getElementById('nextMonth');
const btnCarica = document.getElementById('btnCarica');
const spin      = document.getElementById('spin');
const statusEl  = document.getElementById('status');
const tbody     = document.getElementById('tbody');

const detailCard   = document.getElementById('detailCard');
const detailTitle  = document.getElementById('detailTitle');
const btnCloseDetail = document.getElementById('btnCloseDetail');

const state = { Y:null, M:null, holidays:new Set(), byCantiere:{}, cantieri:[], summary:[], currentCant:null, allData:[], chartInstance:null };

function setYM(Y,M){ meseInput.value = `${Y}-${pad(M)}`; }

function getYM(){
  const v = meseInput.value;
  if(/^\d{4}-\d{2}$/.test(v)){ const [Y,M]=v.split('-').map(Number); return [Y,M]; }
  const d=new Date(); return [d.getFullYear(), d.getMonth()+1];
}

function shiftMonth(delta){
  let [Y,M]=getYM(); M+=delta;
  if(M<1){M=12;Y--} if(M>12){M=1;Y++}
  setYM(Y,M); carica();
}

function setLoading(on){
  spin.classList.toggle('show', !!on);
  btnCarica.disabled = !!on; prevBtn.disabled=!!on; nextBtn.disabled=!!on;
}

/* ====== FETCH ====== */
async function fetchRowsFromOpenSheet(sheetId){
  const tabs = ["Presenze", "Storico"];
  const allRows = [];
  const loadedTabs = [];
  
  for(const tab of tabs){
    try{
      const url = `https://opensheet.elk.sh/${sheetId}/${encodeURIComponent(tab)}`;
      const res = await fetch(url, { cache: "no-store" });
      if(res.ok){
        const rows = await res.json();
        if(Array.isArray(rows) && rows.length > 0){
          allRows.push(...rows);
          loadedTabs.push(tab);
        }
      }
    }catch(_e){
      console.warn(`Tab "${tab}" non trovata o errore nel caricamento`);
    }
  }
  
  if(allRows.length === 0){
    throw new Error("Nessun dato trovato nei fogli Presenze e Storico");
  }
  
  statusEl.innerHTML = `<span class="ok">‚úì Dati caricati con successo (${loadedTabs.join(', ')}) - ${allRows.length} righe totali</span>`;
  return allRows;
}

/* ====== RENDER ====== */
function renderSummary(list){
  tbody.innerHTML = '';
  if(list.length===0){
    tbody.innerHTML = `<tr><td colspan="6" class="empty-state">Nessun cantiere con ore registrate in questo mese.</td></tr>`;
    return;
  }
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><a class="cant-link" data-cant="${r.cant}">${r.cant}</a></td>
      <td class="num">${r.tot} h</td>
      <td class="num">${r.days}</td>
      <td class="num">${r.media} h</td>
      <td class="num">${r.operai}</td>
      <td class="num">${r.weekend} h</td>`;
    tbody.appendChild(tr);
  });
}

function groupDayEntries(entries){
  const map = new Map();
  entries.forEach(e=>{
    const op = e.operaio;
    const lav = stripIntervals(e.lavorazione||"");
    const note = stripIntervals(e.note||"");
    const key = `${op}|${lav}|${note}`;
    if(!map.has(key)) map.set(key, {operaio:op, lav, note, ore:0, orari:new Set(), count:0});
    const rec = map.get(key);
    rec.ore += (e.ore||0);
    if(e.orari){ String(e.orari).split(/[,;]+/).map(s=>s.trim()).filter(Boolean).forEach(x=>rec.orari.add(x)); }
    rec.count++;
  });
  return Array.from(map.values()).map(v=>({
    operaio: v.operaio,
    lav: v.lav,
    note: v.note,
    orari: Array.from(v.orari).join(', '),
    ore: +(+v.ore).toFixed(2)
  }));
}

function createAndamentoChart(cant){
  // Distruggi grafico precedente se esiste
  if(state.chartInstance){
    state.chartInstance.destroy();
    state.chartInstance = null;
  }
  
  // Calcola ore per mese per questo cantiere
  const orePerMese = {};
  
  state.allData.forEach(r => {
    const dataVal = pick(r, "Data Presenza", "Data");
    const dt = parseDateAny(dataVal);
    if(!dt) return;
    
    const cantRaw = String(pick(r, "Cantiere")).trim();
    const cantNorm = isBlankCantiere(cantRaw) ? 'NO DATI' : cantRaw.toUpperCase();
    
    if(cantNorm !== cant) return;
    
    const oreV = pick(r, "Ore");
    const ore = (oreV!=="" && oreV!=null) ? Number(String(oreV).replace(",",".")) : 0;
    
    const y = dt.getFullYear();
    const m = dt.getMonth() + 1;
    const key = `${y}-${pad(m)}`;
    
    if(!orePerMese[key]) orePerMese[key] = 0;
    orePerMese[key] += ore;
  });
  
  // Ordina per data e prendi gli ultimi 12 mesi
  const mesi = Object.keys(orePerMese).sort();
  const ultimi12 = mesi.slice(-12);
  
  if(ultimi12.length === 0){
    document.getElementById('chartAndamento').style.display = 'none';
    return;
  }
  
  const labels = ultimi12.map(key => {
    const [y, m] = key.split('-');
    const date = new Date(parseInt(y), parseInt(m) - 1);
    return date.toLocaleDateString('it-IT', { month: 'short', year: '2-digit' });
  });
  
  const data = ultimi12.map(key => orePerMese[key].toFixed(1));
  
  const ctx = document.getElementById('chartAndamento').getContext('2d');
  
  state.chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          type: 'bar',
          label: 'Ore Totali',
          data: data,
          backgroundColor: 'rgba(59, 130, 246, 0.6)',
          borderColor: 'rgb(59, 130, 246)',
          borderWidth: 2,
          borderRadius: 6,
        },
        {
          type: 'line',
          label: 'Andamento',
          data: data,
          borderColor: 'rgb(220, 38, 38)',
          borderWidth: 3,
          pointBackgroundColor: 'rgb(220, 38, 38)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7,
          fill: false,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 3,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.parsed.y + ' ore';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Ore',
            font: {
              weight: 'bold',
              size: 14
            }
          },
          ticks: {
            callback: function(value) {
              return value + ' h';
            }
          }
        },
        x: {
          title: {
            display: true,
            text: 'Mese',
            font: {
              weight: 'bold',
              size: 14
            }
          }
        }
      }
    },
    plugins: [{
      afterDatasetsDraw: function(chart) {
        const ctx = chart.ctx;
        chart.data.datasets[0].data.forEach((value, index) => {
          const meta = chart.getDatasetMeta(0);
          const bar = meta.data[index];
          
          ctx.fillStyle = '#1e293b';
          ctx.font = 'bold 13px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'bottom';
          ctx.fillText(value + ' h', bar.x, bar.y - 5);
        });
      }
    }]
  });
}

function showDetail(cant){
  state.currentCant = cant;
  const [Y,M] = [state.Y, state.M];
  const data = state.byCantiere[cant];
  
  if(!data){
    alert('Nessun dato per questo cantiere');
    return;
  }

  // Calcola statistiche generali
  let totOre = 0;
  const operaiSet = new Set();
  const giorniSet = new Set();
  const operaiOre = {};
  const operaiGiorni = {};

  data.forEach(entry => {
    totOre += (entry.ore || 0);
    operaiSet.add(entry.operaio);
    giorniSet.add(entry.iso);
    
    // Aggregazione per operaio
    if(!operaiOre[entry.operaio]) {
      operaiOre[entry.operaio] = 0;
      operaiGiorni[entry.operaio] = new Set();
    }
    operaiOre[entry.operaio] += (entry.ore || 0);
    operaiGiorni[entry.operaio].add(entry.iso);
  });

  // Statistiche generali
  document.getElementById('statOreTot').textContent = `${totOre.toFixed(1)} h`;
  document.getElementById('statGiorni').textContent = giorniSet.size;
  document.getElementById('statOperai').textContent = operaiSet.size;
  const mediaGiorno = giorniSet.size > 0 ? (totOre / giorniSet.size) : 0;
  document.getElementById('statMedia').textContent = `${mediaGiorno.toFixed(1)} h`;

  // Crea grafico andamento
  createAndamentoChart(cant);

  // Tabella operai
  const detailOperai = document.getElementById('detailOperai');
  detailOperai.innerHTML = '';
  const operaiList = Object.keys(operaiOre).sort((a,b) => operaiOre[b] - operaiOre[a]);
  operaiList.forEach(op => {
    const ore = operaiOre[op];
    const giorni = operaiGiorni[op].size;
    const media = giorni > 0 ? (ore / giorni) : 0;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${op}</td>
      <td class="num">${ore.toFixed(1)} h</td>
      <td class="num">${giorni}</td>
      <td class="num">${media.toFixed(1)} h</td>
    `;
    detailOperai.appendChild(tr);
  });

  // Calendario lavorazioni giorno per giorno
  renderCalendarioLavorazioni(cant, Y, M);

  detailTitle.textContent = `üèóÔ∏è Dettaglio Cantiere ‚Äî ${cant} (${pad(M)}/${Y})`;
  detailCard.style.display = 'block';
  detailCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderCalendarioLavorazioni(cant, Y, M){
  const detailLavorazioni = document.getElementById('detailLavorazioni');
  detailLavorazioni.innerHTML = '';
  
  const daysInMonth = new Date(Y, M, 0).getDate();
  
  // Organizza dati per giorno
  const byDay = {};
  const data = state.byCantiere[cant];
  data.forEach(entry => {
    const d = Number(entry.iso.split('-')[2]);
    if(!byDay[d]) byDay[d] = [];
    byDay[d].push(entry);
  });
  
  let altFlag = false;

  for(let d=1; d<=daysInMonth; d++){
    const list0 = byDay[d] || [];
    const date = new Date(Y, M-1, d);
    const dow = (date.getDay()+6)%7;
    const iso = `${Y}-${pad(M)}-${pad(d)}`;
    const isOff = (dow===5||dow===6) || state.holidays.has(iso);

    const nomeG = date.toLocaleDateString('it-IT',{weekday:'short'});
    const dayLabel = `${pad(d)}/${pad(M)} ${nomeG}`;

    const altClass = (!isOff && altFlag) ? 'alt' : '';

    if(!list0.length){
      const tr = document.createElement('tr');
      tr.className = `${isOff?'off':''} ${altClass} gstart gend`.trim();
      tr.innerHTML = `
        <td class="daycell">${dayLabel}</td>
        <td>‚Äî</td>
        <td class="num"></td>
        <td></td>`;
      detailLavorazioni.appendChild(tr);
      if(!isOff) altFlag = !altFlag;
      continue;
    }

    const list = groupDayEntries(list0);
    const rowspan = list.length;
    let dayTot = 0;

    list.forEach((en, idx) => {
      const tr = document.createElement('tr');
      if(isOff) tr.classList.add('off');
      if(altClass) tr.classList.add('alt');
      if(rowspan===1) tr.classList.add('gstart','gend');
      else if(idx===0) tr.classList.add('gstart');
      else if(idx===rowspan-1) tr.classList.add('gend');
      else tr.classList.add('gmid');

      if(idx === 0){
        const tdDay = document.createElement('td');
        tdDay.className = 'daycell';
        tdDay.rowSpan = rowspan;
        tdDay.textContent = dayLabel;
        tr.appendChild(tdDay);
      }

      const tdOp = document.createElement('td');
      tdOp.innerHTML = `<div class="op-name">${en.operaio}</div>`;

      const tdOrario = document.createElement('td');
      tdOrario.className = 'num';
      tdOrario.innerHTML = `<strong>${en.ore} h</strong>`;

      const tdLav = document.createElement('td');
      const lavHtml = en.lav ? `<div class="lav">${en.lav.replace(/\n/g,'<br>')}</div>` : '';
      const noteHtml = en.note ? `<div class="note">${en.note.replace(/\n/g,'<br>')}</div>` : '';
      tdLav.innerHTML = lavHtml + noteHtml;

      dayTot += (en.ore || 0);

      tr.appendChild(tdOp);
      tr.appendChild(tdOrario);
      tr.appendChild(tdLav);
      detailLavorazioni.appendChild(tr);
    });

    if(list.length > 1){
      const trSub = document.createElement('tr');
      if(isOff) trSub.classList.add('off');
      if(altClass) trSub.classList.add('alt');
      trSub.classList.add('daytot','gend');

      trSub.innerHTML = `
        <td class="daycell"></td>
        <td style="text-align:right;">Tot giorno:</td>
        <td class="num"><strong>${(+dayTot.toFixed(2))} h</strong></td>
        <td></td>`;
      detailLavorazioni.appendChild(trSub);
    }

    if(!isOff) altFlag = !altFlag;
  }
}

/* ====== DATA LOAD ====== */
async function carica(){
  try{
    setLoading(true); statusEl.textContent=""; tbody.innerHTML=''; detailCard.style.display='none';

    const [Y,M]=getYM();
    state.Y=Y; state.M=M; state.holidays = italianHolidays(Y);

    const rows = await fetchRowsFromOpenSheet(SHEET_ID);
    
    // Salva tutti i dati grezzi per il grafico
    state.allData = rows;

    state.byCantiere = {};
    rows.forEach((r)=>{
      const dataVal = pick(r, "Data Presenza", "Data");
      const dt = parseDateAny(dataVal);
      if(!dt) return;
      const y=dt.getFullYear(), m=dt.getMonth()+1, d=dt.getDate();
      if(y!==Y || m!==M) return;

      const op = String(pick(r, "Nome Operaio", "Operaio")).trim();
      if(!op) return;

      const cantRaw = String(pick(r, "Cantiere")).trim();
      const cant = isBlankCantiere(cantRaw) ? 'NO DATI' : cantRaw.toUpperCase();
      
      const orariStr = String(pick(r, "Orari") || "").trim();
      const oreV     = pick(r, "Ore");
      const ore      = (oreV!=="" && oreV!=null) ? Number(String(oreV).replace(",",".")) : 0;
      const lav      = stripIntervals(String(pick(r, "Lavorazione") || ""));
      const note     = stripIntervals(String(pick(r, "Note") || ""));

      const iso = `${Y}-${pad(m)}-${pad(d)}`;
      const date = new Date(Y, m-1, d);
      const dow  = (date.getDay()+6)%7;
      const isOff= (dow===5||dow===6) || state.holidays.has(iso);

      if(!state.byCantiere[cant]) state.byCantiere[cant] = [];
      state.byCantiere[cant].push({ 
        operaio: op, 
        ore, 
        lavorazione: lav, 
        note, 
        orari: orariStr,
        iso,
        isOff
      });
    });

    state.cantieri = Object.keys(state.byCantiere).sort((a,b)=>a.localeCompare(b,'it'));

    state.summary = state.cantieri.map(cant=>{
      const entries = state.byCantiere[cant] || [];
      let tot=0, weekendHours=0;
      const giorniSet = new Set();
      const operaiSet = new Set();

      entries.forEach(en => {
        const h = en.ore || 0;
        tot += h;
        giorniSet.add(en.iso);
        operaiSet.add(en.operaio);
        if(en.isOff) weekendHours += h;
      });

      const days = giorniSet.size;
      const media = days ? +(tot/days).toFixed(2) : 0;
      
      return { 
        cant, 
        tot: +tot.toFixed(2), 
        days, 
        media, 
        operai: operaiSet.size,
        weekend: +weekendHours.toFixed(2)
      };
    }).sort((a,b)=> b.tot - a.tot || a.cant.localeCompare(b.cant,'it'));

    renderSummary(state.summary);
  }catch(e){
    console.error(e);
    statusEl.innerHTML = `<span class="error">‚úó ${e.message || "Errore nel caricamento dati."}</span>`;
  }finally{
    setLoading(false);
  }
}
  
/* ==================== EXPORT PDF A4 VERTICALE - REPORT ELEGANTE V2 ==================== */
async function exportDetailPDF(){
¬† if(detailCard.style.display === 'none'){ alert('Apri prima un dettaglio cantiere.'); return; }
¬† 
¬† // Correzione per GState (mantenuta)
¬† const { jsPDF } = window.jspdf;
¬† const GState = window.GState || window.jspdf.GState; 
¬† 

¬† // --- COLORI & OPACIT√Ä ---
¬† // Verde scurito ~20% (27,158,75)
¬† const GREEN = { r: 27, g: 158, b: 75 };
¬† const ORANGE = { r: 249, g: 115, b: 22 };
¬† const PURPLE = { r: 168, g: 85,¬† b: 247 };
¬† const FILL_GRAY = { r: 226, g: 232, b: 240 };
¬† const WK_BG¬† = { r: 254, g: 243, b: 199 };
¬† const LIGHT_BORDER = { r: 210, g: 214, b: 220 };

¬† // Opacit√† portata al 50%
¬† const gs50 = new (GState || window.jspdf.GState)({ opacity: 0.5 });
¬† // Opacit√† bassa (8%) per il watermark
¬† const gs08 = new (GState || window.jspdf.GState)({ opacity: 0.08 });


¬† // --- PDF ---
¬† const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
¬† const pageW = pdf.internal.pageSize.getWidth();
¬† const pageH = pdf.internal.pageSize.getHeight();
¬† const margin = 8;
¬† let yPos = margin;
¬† let pageNum = 1;

¬† // --- LOGO (watermark, entro margini, meno alto) ---
¬† let logoImg = null;
¬† try {
¬† ¬† const response = await fetch('https://raw.githubusercontent.com/ferra2391/presenze-cantieri/main/Logo.png');
¬† ¬† const blob = await response.blob();
¬† ¬† logoImg = await new Promise(r=>{ const fr=new FileReader(); fr.onloadend=()=>r(fr.result); fr.readAsDataURL(blob); });
¬† } catch(e){ console.warn('Logo non caricato', e); }

¬† function addLogoWatermark(){
¬† ¬† if(!logoImg) return;
¬† ¬† const w = pageW - 2*margin;
¬† ¬† // Altezza ridotta del 20%
¬† ¬† const h = (pageH - 2*margin) * 0.1536; 
¬† ¬† const x = margin;
¬† ¬† const y = (pageH - h) / 2;
¬† ¬† pdf.saveGraphicsState();
¬† ¬† pdf.setGState(gs08); 
¬† ¬† pdf.addImage(logoImg, 'PNG', x, y, w, h);
¬† ¬† pdf.restoreGraphicsState();
¬† }

¬† // Bordo pagina rimosso
¬† function drawPrintMargins(){
¬† ¬† // Funzione svuotata
¬† }

¬† addLogoWatermark();
¬† drawPrintMargins();

¬† // --- DATI BASE ---
¬† const [Y, M] = [state.Y, state.M];
¬† const cant¬† ¬†= state.currentCant;
¬† const data¬† ¬†= state.byCantiere[cant];
¬† if(!data) return;

¬† let totOre = 0;
¬† const operaiSet = new Set();
¬† const giorniSet = new Set();
¬† const operaiOre = {};
¬† const operaiGiorni = {};
¬† data.forEach(e=>{
¬† ¬† totOre += (e.ore||0);
¬† ¬† operaiSet.add(e.operaio);
¬† ¬† giorniSet.add(e.iso);
¬† ¬† if(!operaiOre[e.operaio]){ operaiOre[e.operaio]=0; operaiGiorni[e.operaio]=new Set(); }
¬† ¬† operaiOre[e.operaio]+=(e.ore||0);
¬† ¬† operaiGiorni[e.operaio].add(e.iso);
¬† });

¬† // --- HEADER (verde, 50%, titolo ben centrato verticalmente) ---
¬† const headerH = 20;
¬† pdf.saveGraphicsState(); pdf.setGState(gs50); 
¬† pdf.setFillColor(GREEN.r, GREEN.g, GREEN.b);
¬† pdf.rect(margin, yPos, pageW-2*margin, headerH, 'F');
¬† pdf.restoreGraphicsState();

¬† pdf.setTextColor(255,255,255);
¬† pdf.setFont('helvetica','bold'); pdf.setFontSize(14);
¬† pdf.text(cant, margin+3, yPos + headerH*0.40);
¬† pdf.setFont('helvetica','normal'); pdf.setFontSize(8);
¬† pdf.text(`Report ${String(M).padStart(2,'0')}/${Y}`, margin+3, yPos + headerH*0.78);
¬† pdf.setFont('helvetica','bold'); pdf.setFontSize(18);
¬† pdf.text(`${totOre.toFixed(1)} h`, pageW - margin - 3, yPos + headerH*0.60, { align:'right' });

¬† yPos += headerH + 2;

¬† // --- STATISTICHE (50%) ---
¬† const boxW = (pageW - 2*margin - 9) / 4;
¬† const boxH = 14; 
¬† const weekendHours = data.filter(e=>e.isOff).reduce((s,e)=>s+(e.ore||0),0);
¬† const stats = [
¬† ¬† { label:'Giorni',¬† ¬†value: giorniSet.size,¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† color: PINK },
¬† ¬† { label:'Operai Coinvolti',¬† ¬†value: operaiSet.size,¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† color: YELLOW },
¬† ¬† { label:'Media/gg', value: `${(totOre/(giorniSet.size||1)).toFixed(1)} h`, color: ORANGE },
¬† ¬† { label:'Weekend',¬† value: `${weekendHours.toFixed(1)} h`,¬† ¬† ¬† ¬† color: PURPLE },
¬† ];
¬† stats.forEach((s,i)=>{
¬† ¬† const x = margin + i*(boxW+3);
¬† ¬† pdf.saveGraphicsState(); pdf.setGState(gs50); 
¬† ¬† pdf.setFillColor(s.color.r, s.color.g, s.color.b);
¬† ¬† pdf.rect(x, yPos, boxW, boxH, 'F'); pdf.restoreGraphicsState();
¬† ¬† pdf.setTextColor(255,255,255);
¬† ¬† pdf.setFont('helvetica','bold'); pdf.setFontSize(5);
¬† ¬† pdf.text(s.label.toUpperCase(), x+boxW/2, yPos + boxH*0.35, { align:'center' }); 
¬† ¬† pdf.setFontSize(10);
¬† ¬† pdf.text(String(s.value), x+boxW/2, yPos + boxH*0.75, { align:'center' }); 
¬† });
¬† yPos += boxH + 4;

¬† // --- GRAFICO (nessun cambio colore/opacity) ---
¬† const chartCanvas = document.getElementById('chartAndamento');
¬† if(chartCanvas && state.chartInstance){
¬† ¬† const chartImg = chartCanvas.toDataURL('image/png');
¬† ¬† const chartH = 32;
¬† ¬† pdf.addImage(chartImg, 'PNG', margin, yPos, pageW-2*margin, chartH);
¬† ¬† yPos += chartH + 4;
¬† }

¬† // --- OPERAI CHE HANNO LAVORATO ---
¬† pdf.setFont('helvetica','bold'); pdf.setFontSize(9);
¬† pdf.setTextColor(30,41,59);
¬† pdf.text('OPERAI CHE HANNO LAVORATO', margin, yPos);
¬† yPos += 4;

¬† // Header tabella (verde 50%), testo centrato verticalmente
¬† const tHeadH = 7;
¬† pdf.saveGraphicsState(); pdf.setGState(gs50); 
¬† pdf.setFillColor(GREEN.r, GREEN.g, GREEN.b);
¬† pdf.rect(margin, yPos, pageW-2*margin, tHeadH, 'F'); pdf.restoreGraphicsState();

¬† pdf.setTextColor(255,255,255);
¬† pdf.setFont('helvetica','bold'); pdf.setFontSize(7);
¬† const thY = yPos + tHeadH*0.65;
¬† pdf.text('Operaio',¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†margin + 2, thY);
¬† pdf.text('Ore',¬† ¬† ¬† ¬† pageW - margin - 40, thY, { align:'right' });
¬† pdf.text('Gg',¬† ¬† ¬† ¬† ¬†pageW - margin - 22, thY, { align:'right' });
¬† pdf.text('Media',¬† ¬† ¬† pageW - margin - 2,¬† thY, { align:'right' });
¬† yPos += tHeadH + 1;

¬† // Righe (altezza 5mm, testo centrato verticalmente)
¬† pdf.setFont('helvetica','normal'); pdf.setFontSize(7); pdf.setTextColor(30,41,59);
¬† const operaiList = Object.keys(operaiOre).sort((a,b)=>operaiOre[b]-operaiOre[a]);
¬† const halfPage = pageH / 2;
¬† const rowH = 5;
¬† const maxOperai = Math.floor((halfPage - yPos) / rowH); 

¬† operaiList.slice(0,maxOperai).forEach((op,i)=>{
¬† ¬† const yRowMid = yPos + rowH*0.65;
¬† ¬† if(i % 2 === 0){ pdf.setFillColor(248,250,252); pdf.rect(margin, yPos, pageW-2*margin, rowH, 'F'); } 
¬† ¬† pdf.text(op, margin + 2, yRowMid);
¬† ¬† pdf.setFont('helvetica','bold');
¬† ¬† pdf.text(`${operaiOre[op].toFixed(1)}`, pageW - margin - 40, yRowMid, { align:'right' });
¬† ¬† pdf.setFont('helvetica','normal');
¬† ¬† pdf.text(String(operaiGiorni[op].size), pageW - margin - 22, yRowMid, { align:'right' });
¬† ¬† const media = operaiGiorni[op].size ? (operaiOre[op]/operaiGiorni[op].size) : 0;
¬† ¬† pdf.text(`${media.toFixed(1)}`, pageW - margin - 2, yRowMid, { align:'right' });
¬† ¬† yPos += rowH;
¬† });

¬† // Separatore (verde 50%)
¬† yPos = halfPage;
¬† pdf.saveGraphicsState(); pdf.setGState(gs50); 
¬† pdf.setDrawColor(GREEN.r, GREEN.g, GREEN.b); pdf.setLineWidth(1);
¬† pdf.line(margin, yPos, pageW - margin, yPos);
¬† pdf.restoreGraphicsState();
¬† yPos += 4;

¬† // --- CALENDARIO LAVORAZIONI ---
¬† pdf.setFont('helvetica','bold'); pdf.setFontSize(9); pdf.setTextColor(30,41,59);
¬† pdf.text('CALENDARIO LAVORAZIONI', margin, yPos);
¬† pdf.setFont('helvetica','normal'); pdf.setFontSize(7); pdf.setTextColor(100,116,139);
¬† pdf.text(`Pagina ${pageNum}`, pageW - margin, yPos, { align:'right' });
¬† yPos += 4;

¬† // Header calendario (verde 50%, centrato)
¬† const calHeadH = 7;
¬† pdf.saveGraphicsState(); pdf.setGState(gs50); 
¬† pdf.setFillColor(GREEN.r, GREEN.g, GREEN.b);
¬† pdf.rect(margin, yPos, pageW-2*margin, calHeadH, 'F'); pdf.restoreGraphicsState();

¬† pdf.setTextColor(255,255,255);
¬† pdf.setFont('helvetica','bold'); pdf.setFontSize(7);
¬† const chY = yPos + calHeadH*0.65;
¬† pdf.text('Giorno',¬† ¬† ¬† margin + 2,¬† chY);
¬† pdf.text('Operaio',¬† ¬† ¬†margin + 25, chY);
¬† pdf.text('Ore',¬† ¬† ¬† ¬† ¬†margin + 70, chY, { align:'right' });
¬† pdf.text('Lavorazioni', margin + 75, chY);
¬† yPos += calHeadH + 1;

¬† // Dati per giorno
¬† const daysInMonth = new Date(Y, M, 0).getDate();
¬† const byDay = {};
¬† data.forEach(e=>{ const d=Number(e.iso.split('-')[2]); (byDay[d] ||= []).push(e); });

¬† const pad = n=>String(n).padStart(2,'0');
¬† 
¬† // CORREZIONE: Calcola la larghezza massima del testo per Lavorazioni per non superare il margine destro
¬† const lavStartX = margin + 75; // Posizione X di inizio colonna Lavorazioni
¬† const lavEndX = pageW - margin; // Posizione X del margine destro
¬† const maxW = lavEndX - lavStartX;
¬† 
¬† const textLineHeight = 3.5; 
¬† const rowPadding = 1.5; 
¬† const barH = 4; 

¬† function newPage(){
¬† ¬† pdf.addPage(); addLogoWatermark(); drawPrintMargins(); pageNum++; yPos = margin + 2;
¬† ¬† pdf.setFont('helvetica','bold'); pdf.setFontSize(9); pdf.setTextColor(30,41,59);
¬† ¬† pdf.text('CALENDARIO LAVORAZIONI (continua)', margin, yPos);
¬† ¬† pdf.setFont('helvetica','normal'); pdf.setFontSize(7); pdf.setTextColor(100,116,139);
¬† ¬† pdf.text(`Pagina ${pageNum}`, pageW - margin, yPos, { align:'right' });
¬† ¬† yPos += 4;
¬† ¬† pdf.saveGraphicsState(); pdf.setGState(gs50); 
¬† ¬† pdf.setFillColor(GREEN.r, GREEN.g, GREEN.b);
¬† ¬† pdf.rect(margin, yPos, pageW-2*margin, calHeadH, 'F'); pdf.restoreGraphicsState();
¬† ¬† pdf.setTextColor(255,255,255);
¬† ¬† pdf.setFont('helvetica','bold'); pdf.setFontSize(7);
¬† ¬† const chY2 = yPos + calHeadH*0.65;
¬† ¬† pdf.text('Giorno', margin + 2, chY2);
¬† ¬† pdf.text('Operaio', margin + 25, chY2);
¬† ¬† pdf.text('Ore', margin + 70, chY2, { align:'right' });
¬† ¬† pdf.text('Lavorazioni', margin + 75, chY2);
¬† ¬† yPos += calHeadH + 1;
¬† }

¬† function splitLav(text){ return pdf.splitTextToSize(text || '', maxW); }

¬† for(let d=1; d<=daysInMonth; d++){
¬† ¬† const list0 = byDay[d] || [];
¬† ¬† if(!list0.length) continue;

¬† ¬† const dt = new Date(Y, M-1, d);
¬† ¬† const dow = (dt.getDay()+6)%7;
¬† ¬† const iso = `${Y}-${pad(M)}-${pad(d)}`;
¬† ¬† const isOff = (dow===5||dow===6) || state.holidays.has(iso);
¬† ¬† const nomeG = dt.toLocaleDateString('it-IT',{weekday:'short'}).toUpperCase();
¬† ¬† const dayLabel = `${pad(d)}/${pad(M)} ${nomeG}`;

¬† ¬† // Aggrega per operaio/lavorazione
¬† ¬† const map = new Map();
¬† ¬† list0.forEach(e=>{
¬† ¬† ¬† const key = `${e.operaio}|${e.lavorazione||''}|${e.note||''}`;
¬† ¬† ¬† if(!map.has(key)) map.set(key,{operaio:e.operaio,lav:e.lavorazione||'',ore:0, note:e.note||''});
¬† ¬† ¬† map.get(key).ore += (e.ore||0);
¬† ¬† });
¬† ¬† const list = Array.from(map.values()).map(v=>({ ...v, ore:+(+v.ore).toFixed(1) })); 

¬† ¬† // Spazio necessario
¬† ¬† let totalHeight = 0;
¬† ¬† list.forEach(en => {
¬† ¬† ¬† const textToSplit = (en.lav + (en.note ? ('\nNote: ' + en.note) : '')).trim();
¬† ¬† ¬† const lines = splitLav(textToSplit).length;
¬† ¬† ¬† // Altezza riga: (Linee * Altezza riga testo) + (Padding sopra e sotto)
¬† ¬† ¬† totalHeight += Math.max(textLineHeight + rowPadding * 2, lines * textLineHeight + rowPadding * 2); 
¬† ¬† });
¬† ¬† 
¬† ¬† if(list.length>1){
¬† ¬† ¬† totalHeight += barH + 0.5; // Spazio per la barra totale e un piccolo margine
¬† ¬† } else {
¬† ¬† ¬† totalHeight += 0.5; // Spazio dopo la singola riga
¬† ¬† }

¬† ¬† if(yPos + totalHeight > pageH - 8) newPage(); 

¬† ¬† list.forEach((en, idx) => {
¬† ¬† ¬† // Combina lavorazione e nota per l'output multilinea
¬† ¬† ¬† const textToSplit = (en.lav + (en.note ? ('\n' + en.note) : '')).trim();
¬† ¬† ¬† const lavLines = splitLav(textToSplit);
¬† ¬† ¬† 
¬† ¬† ¬† // Ricalcola rowH2 (Altezza dinamica)
¬† ¬† ¬† const lines = lavLines.length;
¬† ¬† ¬† const rowH2 = Math.max(textLineHeight + rowPadding * 2, lines * textLineHeight + rowPadding * 2);

¬† ¬† ¬† // Sfondo weekend
¬† ¬† ¬† if(isOff){ pdf.saveGraphicsState(); pdf.setGState(gs50); 
¬† ¬† ¬† ¬† pdf.setFillColor(WK_BG.r, WK_BG.g, WK_BG.b);
¬† ¬† ¬† ¬† pdf.rect(margin, yPos, pageW-2*margin, rowH2, 'F'); pdf.restoreGraphicsState(); } 

¬† ¬† ¬† // Calcola il punto medio per l'allineamento verticale (per Operaio/Ore)
¬† ¬† ¬† const yRowMid = yPos + rowH2 * 0.5;
¬† ¬† ¬† const yBaselineCentered = yRowMid + 0.4; 
¬† ¬† ¬† 
¬† ¬† ¬† // Correzione allineamento Lavorazioni
¬† ¬† ¬† const textBlockHeight = lines * textLineHeight;
¬† ¬† ¬† const paddingToCenter = (rowH2 - textBlockHeight) / 2;
¬† ¬† ¬† const yLavBaseline = yPos + paddingToCenter + (textLineHeight * 0.75);


¬† ¬† ¬† // Giorno (solo prima riga)
¬† ¬† ¬† if(idx===0){ pdf.setFont('helvetica','bold'); pdf.setFontSize(7); pdf.setTextColor(30,41,59);
¬† ¬† ¬† ¬† pdf.text(dayLabel, margin+2, yBaselineCentered); } 

¬† ¬† ¬† // Operaio: NERO GRASSETTO
¬† ¬† ¬† pdf.setFont('helvetica','bold'); pdf.setFontSize(7); pdf.setTextColor(0,0,0);
¬† ¬† ¬† pdf.text(en.operaio, margin + 25, yBaselineCentered); 

¬† ¬† ¬† // Ore (allineate a destra, centrate verticalmente)
¬† ¬† ¬† pdf.setFont('helvetica','bold'); pdf.setFontSize(7); pdf.setTextColor(15,23,42);
¬† ¬† ¬† pdf.text(`${en.ore.toFixed(1)} h`, margin + 70, yBaselineCentered, { align:'right' }); 

¬† ¬† ¬† // Lavorazioni: Allineato verticalmente al centro
¬† ¬† ¬† pdf.setFont('helvetica','normal'); pdf.setFontSize(7); pdf.setTextColor(30,41,59);
¬† ¬† ¬† pdf.text(lavLines, margin + 75, yLavBaseline); 

¬† ¬† ¬† yPos += rowH2;
¬† ¬† });

¬† ¬† // TOTALE GIORNO (barra grigia)
¬† ¬† if(list.length>1){
¬† ¬† ¬† const dayTot = list.reduce((s,en)=>s+(en.ore||0),0);
¬† ¬† ¬† const barY = yPos;
¬† ¬† ¬† pdf.setFillColor(FILL_GRAY.r, FILL_GRAY.g, FILL_GRAY.b);
¬† ¬† ¬† pdf.rect(margin, barY, pageW-2*margin, barH, 'F');

¬† ¬† ¬† const yMid = barY + barH*0.6; 
¬† ¬† ¬† pdf.setFont('helvetica','bold'); pdf.setFontSize(7); pdf.setTextColor(15,23,42);
¬† ¬† ¬† pdf.text(`TOT: ${dayTot.toFixed(1)} h`, margin + 70, yMid, { align:'right' });

¬† ¬† ¬† yPos += barH + 0.5; 
¬† ¬† } else {
¬† ¬† ¬† yPos += 0.5; 
¬† ¬† }
¬† }

¬† // Footer
¬† pdf.setFont('helvetica','italic'); pdf.setFontSize(6); pdf.setTextColor(150,150,150);
¬† pdf.text(`Report generato il ${new Date().toLocaleDateString('it-IT')}`, pageW/2, pageH-5, { align:'center' });

¬† pdf.save(`Analisi_Cantiere_${cant.replace(/\s+/g,'_')}_${String(M).padStart(2,'0')}_${Y}.pdf`);
}
/* ====== INIT ====== */
(function init(){
  const now = new Date();
  setYM(now.getFullYear(), now.getMonth() + 1);

  btnCarica.addEventListener('click', carica);
  prevBtn.addEventListener('click', () => shiftMonth(-1));
  nextBtn.addEventListener('click', () => shiftMonth(+1));
  meseInput.addEventListener('change', carica);

  tbody.addEventListener('click', (e) => {
    const a = e.target.closest('.cant-link');
    if(a && a.dataset.cant) {
      showDetail(a.dataset.cant);
    }
  });

  document.getElementById('btnDetailPDF').addEventListener('click', exportDetailPDF);
  btnCloseDetail.addEventListener('click', () => {
    detailCard.style.display = 'none';
    if(state.chartInstance){
      state.chartInstance.destroy();
      state.chartInstance = null;
    }
  });

  carica();
})();
</script>
</body>
</html>
