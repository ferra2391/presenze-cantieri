<script>
async function exportDetailPDF(){
  if(detailCard.style.display === 'none'){
    alert('Apri prima un dettaglio cantiere.');
    return;
  }

  const { jsPDF } = window.jspdf;
  const [Y, M] = [state.Y, state.M];
  const cant = state.currentCant;
  const data = state.byCantiere[cant];
  if(!data) return;

  // === UTILS COLORI/OPACITÀ ===
  const GREEN = { r: 34, g: 197, b: 94 };        // verde (ex blu)
  const ORANGE = { r: 249, g: 115, b: 22 };
  const PURPLE = { r: 168, g: 85,  b: 247 };
  const TEAL   = { r: 16,  g: 185, b: 129 };     // testi accentati (ex blu)
  const FILL_GRAY = { r: 226, g: 232, b: 240 };  // evidenziatore tot giorno
  const WK_BG  = { r: 254, g: 243, b: 199 };     // weekend/off

  const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const margin = 8;
  let yPos = margin;
  let pageNum = 1;

  // Helper opacità 70% per riempimenti/linee/testi colorati
  const gs70 = new pdf.GState({ opacity: 0.7 });

  // === LOGO (WATERMARK) ===
  let logoImg = null;
  try {
    const logoUrl = 'https://raw.githubusercontent.com/ferra2391/presenze-cantieri/main/Logo.png';
    const response = await fetch(logoUrl);
    const blob = await response.blob();
    logoImg = await new Promise((resolve) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  } catch(e) { console.warn('Logo non caricato:', e); }

  function addLogoWatermark(){
    if(!logoImg) return;
    // Larghezza = larghezza utile entro i margini; altezza leggermente ridotta
    const w = pageW - 2*margin;
    const h = (pageH - 2*margin) * 0.25; // "leggermente meno alto"
    const x = margin;
    const y = (pageH - h) / 2;

    pdf.saveGraphicsState();
    pdf.setGState(new pdf.GState({ opacity: 0.08 }));
    pdf.addImage(logoImg, 'PNG', x, y, w, h);
    pdf.restoreGraphicsState();
  }
  addLogoWatermark();

  // === TOTALI/STAT ===
  let totOre = 0;
  const operaiSet = new Set();
  const giorniSet = new Set();
  const operaiOre = {};
  const operaiGiorni = {};

  data.forEach(entry => {
    totOre += (entry.ore || 0);
    operaiSet.add(entry.operaio);
    giorniSet.add(entry.iso);
    if(!operaiOre[entry.operaio]) { operaiOre[entry.operaio] = 0; operaiGiorni[entry.operaio] = new Set(); }
    operaiOre[entry.operaio] += (entry.ore || 0);
    operaiGiorni[entry.operaio].add(entry.iso);
  });

  // === HEADER (ex blu → verde, opacità 70%, titolo centrato meglio) ===
  const headerH = 20; // leggermente più alto per margini verticali
  pdf.saveGraphicsState();
  pdf.setGState(gs70);
  pdf.setFillColor(GREEN.r, GREEN.g, GREEN.b);
  pdf.rect(margin, yPos, pageW - 2*margin, headerH, 'F');
  pdf.restoreGraphicsState();

  // Testi header
  pdf.setTextColor(255,255,255);
  pdf.setFont('helvetica','bold'); pdf.setFontSize(14);
  pdf.text(cant, margin + 3, yPos + 8);
  pdf.setFont('helvetica','normal'); pdf.setFontSize(8);
  pdf.text(`Report ${String(M).padStart(2,'0')}/${Y}`, margin + 3, yPos + 14.5);
  pdf.setFont('helvetica','bold'); pdf.setFontSize(18);
  pdf.text(`${totOre.toFixed(1)} h`, pageW - margin - 3, yPos + 12, { align:'right' });

  yPos += headerH + 2;

  // === STATISTICHE (opacità 70%) ===
  const boxW = (pageW - 2*margin - 9) / 4;
  const boxH = 14;
  const weekendHours = data.filter(e=>e.isOff).reduce((sum,e)=>sum+(e.ore||0),0);
  const stats = [
    { label:'Giorni',   value: giorniSet.size,                color: GREEN },
    { label:'Operai',   value: operaiSet.size,                color: TEAL  },
    { label:'Media/gg', value: `${(totOre/(giorniSet.size||1)).toFixed(1)} h`, color: ORANGE },
    { label:'Weekend',  value: `${weekendHours.toFixed(1)} h`, color: PURPLE },
  ];

  stats.forEach((s,i)=>{
    const x = margin + i*(boxW+3);
    pdf.saveGraphicsState();
    pdf.setGState(gs70);
    pdf.setFillColor(s.color.r, s.color.g, s.color.b);
    pdf.rect(x, yPos, boxW, boxH, 'F');
    pdf.restoreGraphicsState();

    pdf.setTextColor(255,255,255);
    pdf.setFont('helvetica','bold'); pdf.setFontSize(5);
    pdf.text(s.label.toUpperCase(), x + boxW/2, yPos + 4.5, { align:'center' });
    pdf.setFontSize(10);
    pdf.text(String(s.value), x + boxW/2, yPos + 10.5, { align:'center' });
  });
  yPos += boxH + 4;

  // === GRAFICO (no trasparenze/modifiche colore) ===
  const chartCanvas = document.getElementById('chartAndamento');
  if(chartCanvas && state.chartInstance){
    const chartImg = chartCanvas.toDataURL('image/png');
    const chartH = 32;
    pdf.addImage(chartImg, 'PNG', margin, yPos, pageW - 2*margin, chartH);
    yPos += chartH + 4;
  }

  // === OPERAI CHE HANNO LAVORATO (barra header ex blu → verde con opacità 70% + testo meglio centrato) ===
  pdf.setFont('helvetica','bold'); pdf.setFontSize(9);
  pdf.setTextColor(30,41,59);
  pdf.text('OPERAI CHE HANNO LAVORATO', margin, yPos);
  yPos += 4;

  const headerH1 = 7;
  pdf.saveGraphicsState();
  pdf.setGState(gs70);
  pdf.setFillColor(GREEN.r, GREEN.g, GREEN.b);
  pdf.rect(margin, yPos, pageW - 2*margin, headerH1, 'F');
  pdf.restoreGraphicsState();

  pdf.setTextColor(255,255,255);
  pdf.setFont('helvetica','bold'); pdf.setFontSize(7);
  const baseY1 = yPos + 4.5; // baseline migliorata
  pdf.text('Operaio',               margin + 2, baseY1);
  pdf.text('Ore',        pageW - margin - 40, baseY1, { align:'right' });
  pdf.text('Gg',         pageW - margin - 22, baseY1, { align:'right' });
  pdf.text('Media',      pageW - margin - 2,  baseY1, { align:'right' });
  yPos += headerH1 + 1;

  // Righe operai
  const operaiList = Object.keys(operaiOre).sort((a,b) => operaiOre[b] - operaiOre[a]);
  const halfPage = pageH / 2;
  const maxOperai = Math.floor((halfPage - yPos - 12) / 5);

  pdf.setFont('helvetica','normal'); pdf.setFontSize(7);
  pdf.setTextColor(30,41,59);
  operaiList.slice(0, maxOperai).forEach((op, i) => {
    const ore = operaiOre[op];
    const giorni = operaiGiorni[op].size;
    const media = giorni > 0 ? (ore / giorni) : 0;

    if(i % 2 === 0){
      pdf.setFillColor(248,250,252);
      pdf.rect(margin, yPos - 3, pageW - 2*margin, 5, 'F');
    }
    pdf.text(op, margin + 2, yPos + 1.5);
    pdf.setFont('helvetica','bold');
    pdf.text(`${ore.toFixed(1)}`, pageW - margin - 40, yPos + 1.5, { align:'right' });
    pdf.setFont('helvetica','normal');
    pdf.text(String(giorni), pageW - margin - 22, yPos + 1.5, { align:'right' });
    pdf.text(`${media.toFixed(1)}`, pageW - margin - 2, yPos + 1.5, { align:'right' });
    yPos += 5;
  });

  // Separatore (ex blu → verde, opacità 70%)
  yPos = halfPage;
  pdf.saveGraphicsState();
  pdf.setGState(gs70);
  pdf.setDrawColor(GREEN.r, GREEN.g, GREEN.b);
  pdf.setLineWidth(1);
  pdf.line(margin, yPos, pageW - margin, yPos);
  pdf.restoreGraphicsState();
  yPos += 4;

  // === CALENDARIO LAVORAZIONI ===
  pdf.setFont('helvetica','bold'); pdf.setFontSize(9);
  pdf.setTextColor(30,41,59);
  pdf.text('CALENDARIO LAVORAZIONI', margin, yPos);
  pdf.setFont('helvetica','normal'); pdf.setFontSize(7);
  pdf.setTextColor(100,116,139);
  pdf.text(`Pagina ${pageNum}`, pageW - margin, yPos, { align:'right' });
  yPos += 4;

  // Header calendario (ex blu → verde, opacità 70%, centrato meglio)
  const headerH2 = 7;
  pdf.saveGraphicsState();
  pdf.setGState(gs70);
  pdf.setFillColor(GREEN.r, GREEN.g, GREEN.b);
  pdf.rect(margin, yPos, pageW - 2*margin, headerH2, 'F');
  pdf.restoreGraphicsState();

  pdf.setTextColor(255,255,255);
  pdf.setFont('helvetica','bold'); pdf.setFontSize(7);
  const baseY2 = yPos + 4.5;
  pdf.text('Giorno',      margin + 2,  baseY2);
  pdf.text('Operaio',     margin + 25, baseY2);
  pdf.text('Ore',         margin + 70, baseY2, { align:'right' });
  pdf.text('Lavorazioni', margin + 75, baseY2);
  yPos += headerH2 + 1;

  // Organizza per giorno
  const daysInMonth = new Date(Y, M, 0).getDate();
  const byDay = {};
  data.forEach(entry => {
    const d = Number(entry.iso.split('-')[2]);
    if(!byDay[d]) byDay[d] = [];
    byDay[d].push(entry);
  });

  function splitLav(text, maxW){
    return pdf.splitTextToSize(text || '', maxW);
  }

  for(let d=1; d<=daysInMonth; d++){
    const list0 = byDay[d] || [];
    if(!list0.length) continue;

    const date = new Date(Y, M-1, d);
    const dow = (date.getDay()+6)%7;
    const iso = `${Y}-${String(M).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isOff = (dow===5||dow===6) || state.holidays.has(iso);
    const nomeG = date.toLocaleDateString('it-IT',{weekday:'short'}).toUpperCase();
    const dayLabel = `${String(d).padStart(2,'0')}/${String(M).padStart(2,'0')} ${nomeG}`;

    const list = (function groupDayEntries(entries){
      const map = new Map();
      entries.forEach(e=>{
        const op = e.operaio;
        const lav = (e.lavorazione||'');
        const note = (e.note||'');
        const key = `${op}|${lav}|${note}`;
        if(!map.has(key)) map.set(key,{operaio:op,lav,note,ore:0});
        const rec = map.get(key);
        rec.ore += (e.ore||0);
      });
      return Array.from(map.values()).map(v=>({ operaio:v.operaio, lav:v.lav, note:v.note, ore:+(+v.ore).toFixed(2)}));
    })(list0);

    // Calcolo spazio necessario
    let totalRowsNeeded = 0;
    const maxW = pageW - margin - 80;
    list.forEach(en => totalRowsNeeded += splitLav(en.lav, maxW).length);
    totalRowsNeeded += (list.length > 1 ? 1 : 0);
    const spaceNeeded = totalRowsNeeded * 5 + list.length * 2;

    // Nuova pagina se serve
    if(yPos + spaceNeeded > pageH - 10){
      pdf.addPage();
      addLogoWatermark();
      pageNum++;
      yPos = margin + 2;

      pdf.setFont('helvetica','bold'); pdf.setFontSize(9);
      pdf.setTextColor(30,41,59);
      pdf.text('CALENDARIO LAVORAZIONI (continua)', margin, yPos);
      pdf.setFont('helvetica','normal'); pdf.setFontSize(7);
      pdf.setTextColor(100,116,139);
      pdf.text(`Pagina ${pageNum}`, pageW - margin, yPos, { align:'right' });
      yPos += 4;

      // Header calendario (verde, 70%)
      pdf.saveGraphicsState();
      pdf.setGState(gs70);
      pdf.setFillColor(GREEN.r, GREEN.g, GREEN.b);
      pdf.rect(margin, yPos, pageW - 2*margin, headerH2, 'F');
      pdf.restoreGraphicsState();

      pdf.setTextColor(255,255,255);
      pdf.setFont('helvetica','bold'); pdf.setFontSize(7);
      const baseY2b = yPos + 4.5;
      pdf.text('Giorno',      margin + 2,  baseY2b);
      pdf.text('Operaio',     margin + 25, baseY2b);
      pdf.text('Ore',         margin + 70, baseY2b, { align:'right' });
      pdf.text('Lavorazioni', margin + 75, baseY2b);
      yPos += headerH2 + 1;
    }

    list.forEach((en, idx) => {
      const lavLines = splitLav(en.lav, maxW);
      const rowHeight = Math.max(5, lavLines.length * 4);

      if(isOff){
        pdf.saveGraphicsState();
        pdf.setGState(gs70);
        pdf.setFillColor(WK_BG.r, WK_BG.g, WK_BG.b);
        pdf.rect(margin, yPos - 3, pageW - 2*margin, rowHeight, 'F');
        pdf.restoreGraphicsState();
      }

      // Giorno (solo prima riga)
      if(idx === 0){
        pdf.setFont('helvetica','bold'); pdf.setFontSize(7);
        pdf.setTextColor(30,41,59);
        pdf.text(dayLabel, margin + 2, yPos + 1.5);
      }

      // Operaio (ex blu → verde, opacità 70%)
      pdf.saveGraphicsState();
      pdf.setGState(gs70);
      pdf.setTextColor(TEAL.r, TEAL.g, TEAL.b);
      pdf.setFont('helvetica','bold'); pdf.setFontSize(7);
      pdf.text(en.operaio, margin + 25, yPos + 1.5);
      pdf.restoreGraphicsState();

      // Ore
      pdf.setFont('helvetica','bold'); pdf.setFontSize(7);
      pdf.setTextColor(15,23,42);
      pdf.text(`${en.ore} h`, margin + 70, yPos + 1.5, { align:'right' });

      // Lavorazioni
      pdf.setFont('helvetica','normal'); pdf.setFontSize(7);
      pdf.setTextColor(30,41,59);
      pdf.text(lavLines, margin + 75, yPos + 1.5);

      yPos += rowHeight;
    });

    // === TOTALE GIORNO (highlight più basso + testo centrato) ===
    if(list.length > 1){
      const dayTot = list.reduce((sum, en) => sum + (en.ore || 0), 0);
      const barH = 4; // più basso
      pdf.setFillColor(FILL_GRAY.r, FILL_GRAY.g, FILL_GRAY.b);
      pdf.rect(margin, yPos - 3, pageW - 2*margin, barH, 'F');

      const totText = `TOT: ${dayTot.toFixed(1)} h`;
      pdf.setFont('helvetica','bold'); pdf.setFontSize(7);
      pdf.setTextColor(15,23,42);
      pdf.text(totText, pageW/2, yPos + 1.2, { align:'center' }); // centrato
      yPos += barH;
    }
  }

  // Footer
  pdf.setFont('helvetica','italic'); pdf.setFontSize(6);
  pdf.setTextColor(150,150,150);
  pdf.text(`Report generato il ${new Date().toLocaleDateString('it-IT')}`, pageW/2, pageH - 5, { align:'center' });

  pdf.save(`Analisi_Cantiere_${cant.replace(/\s+/g,'_')}_${String(M).padStart(2,'0')}_${Y}.pdf`);
}
</script>
