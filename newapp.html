<!DOCTYPE html>
<html lang="it">
<head>
Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  <title>Presenze Cantiere</title>
Â  <style>
Â  Â  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
Â  Â  :root{
Â  Â  Â  --primary:#FF6B35;--primary-dark:#E55A2B;--secondary:#004E89;--secondary-light:#1A659E;
Â  Â  Â  --accent:#F7B801;--success:#06D6A0;--bg:#0A0E27;--bg-light:#1a1f3a;
Â  Â  Â  --card-bg:rgba(255,255,255,.05);--text:#fff;--text-secondary:#B8C5D6;--border:rgba(255,255,255,.1);
Â  Â  Â  --zoom: 1;
Â  Â  Â  --morning-grad: linear-gradient(135deg,#4da3ff,#5bc0eb);
Â  Â  Â  --afternoon-grad: linear-gradient(135deg,var(--primary),var(--accent));
Â  Â  Â  --slot-h: 180px;
Â  Â  }
Â  Â  body{
Â  Â  Â  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
Â  Â  Â  background:var(--bg);color:var(--text);overflow-x:hidden;min-height:100vh;position:relative;
Â  Â  Â  padding-bottom: env(safe-area-inset-bottom, 0);touch-action: manipulation;
Â  Â  }
Â  Â  body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;
Â  Â  Â  background:
Â  Â  Â  Â  radial-gradient(circle at 20% 50%,rgba(255,107,53,.15)0%,transparent 50%),
Â  Â  Â  Â  radial-gradient(circle at 80% 80%,rgba(0,78,137,.15)0%,transparent 50%),
Â  Â  Â  Â  radial-gradient(circle at 40% 20%,rgba(247,184,1,.1)0%,transparent 50%);
Â  Â  Â  animation:drift 20s ease-in-out infinite;z-index:0}
Â  Â  @keyframes drift{0%,100%{transform:translate(0,0) rotate(0)}33%{transform:translate(30px,-30px) rotate(5deg)}66%{transform:translate(-20px,20px) rotate(-5deg)}}

Â  Â  .container{
Â  Â  Â  position:relative;z-index:1;max-width:480px;margin:0 auto;min-height:100vh;
Â  Â  Â  transform: scale(var(--zoom));transform-origin: top center;
Â  Â  Â  width: calc(100vw / var(--zoom));min-height: calc(100vh / var(--zoom));
Â  Â  Â  will-change: transform,width;
Â  Â  }
Â  Â  .header{background:linear-gradient(135deg,var(--primary)0%,var(--primary-dark)100%);padding:60px 24px 40px;border-radius:0 0 32px 32px;box-shadow:0 10px 40px rgba(255,107,53,.3);position:relative;overflow:hidden}
Â  Â  .header::before{content:'';position:absolute;top:-50%;right:-20%;width:200px;height:200px;background:rgba(255,255,255,.1);border-radius:50%;animation:float 6s ease-in-out infinite}
Â  Â  @keyframes float{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-20px) scale(1.1)}}
Â  Â  .header h1{font-size:28px;font-weight:800;margin-bottom:8px}
Â  Â  .header .subtitle{color:rgba(255,255,255,.9);font-size:16px;font-weight:500}
Â  Â  .user-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);padding:8px 16px;border-radius:20px;margin-top:16px;font-size:14px;font-weight:600}
Â  Â  .content{padding:24px}
Â  Â  .step-indicator{display:flex;justify-content:space-between;margin-bottom:32px;padding:0 8px}
Â  Â  .step{flex:1;height:4px;background:var(--card-bg);border-radius:4px;margin:0 4px;position:relative;overflow:hidden;transition:.3s}
Â  Â  .step.active{background:linear-gradient(90deg,var(--primary),var(--accent))}
Â  Â  .step.active::after{content:'';position:absolute;top:0;left:0;height:100%;width:30%;background:rgba(255,255,255,.5);animation:shimmer 1.5s infinite}
Â  Â  @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(400%)}}
Â  Â  .card{background:var(--card-bg);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:24px;padding:24px;margin-bottom:20px;box-shadow:0 8px 32px rgba(0,0,0,.2);transition:.3s cubic-bezier(.4,0,.2,1)}
Â  Â  .card-title{font-size:18px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px}
Â  Â  .card-title .icon{font-size:24px}
Â  Â  .date-selector{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:16px}
Â  Â  .date-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--card-bg);border:2px solid transparent;border-radius:12px;cursor:pointer;transition:.3s;font-size:14px}
Â  Â  .date-day .day-name{font-size:10px;color:var(--text-secondary);margin-bottom:4px;text-transform:uppercase;font-weight:600}
Â  Â  .date-day .day-num{font-size:16px;font-weight:700}
Â  Â  .date-day:hover{border-color:var(--primary);transform:scale(1.05)}
Â  Â  .date-day.selected{background:linear-gradient(135deg,var(--primary),var(--accent));border-color:transparent;transform:scale(1.05);box-shadow:0 4px 20px rgba(255,107,53,.4)}
Â  Â  .date-day.today{border-color:var(--success)}
Â  Â  .date-day.weekend:not(.selected), .date-day.holiday:not(.selected){background: rgba(220, 38, 38, 0.12); border-color: rgba(220, 38, 38, 0.35);}
Â  Â  /* ORARI: allineamento corretto */
Â  Â  .time-picker{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;align-items:stretch}
Â  Â  .time-slot{position:relative;overflow:hidden;border-radius:20px;border:2px solid var(--border);box-shadow:0 8px 24px rgba(0,0,0,.15);display:flex}
Â  Â  .time-slot.morning .slot-bg{background:var(--morning-grad)}
Â  Â  .time-slot.afternoon .slot-bg{background:var(--afternoon-grad)}
Â  Â  .slot-bg{position:absolute;inset:0;opacity:.9;border-radius:20px}
Â  Â  .slot-inner{position:relative;z-index:1;display:flex;flex-direction:column;gap:10px;padding:16px;width:100%}
Â  Â  .slot-head{display:flex;align-items:center;gap:10px}
Â  Â  .slot-head .icon{font-size:28px}
Â  Â  .slot-head .label{font-size:14px;font-weight:700;letter-spacing:.2px}
Â  Â  .slot-time{font-size:20px;font-weight:800;flex-grow:1;display:flex;align-items:center;justify-content:center}
Â  Â  .time-inputs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
Â  Â  .time-inputs input[type="time"]{width:100%;background:rgba(0,0,0,.25);border:2px solid rgba(255,255,255,.35);color:#fff;border-radius:12px;padding:10px 12px;font-size:16px;outline:none;transition:.2s;box-sizing:border-box}
Â  Â  .time-inputs input[type="time"]:focus{border-color:#fff;box-shadow:0 0 0 3px rgba(255,255,255,.25)}
Â  Â  .time-inputs input[type="time"]::-webkit-calendar-picker-indicator{cursor:pointer; background-color: rgba(255,255,255,0.2); border-radius: 4px;}
Â  Â  .input-group{position:relative;margin-top:16px}
Â  Â  .input-group input,.input-group textarea,.input-group select{width:100%;background:var(--bg-light);border:2px solid var(--border);border-radius:16px;padding:16px 20px 16px 50px;font-size:16px;color:var(--text);font-family:inherit;transition:.3s}
Â  Â  .input-group select{padding-left:50px;appearance:none}
Â  Â  .input-group textarea{resize:vertical;min-height:100px}
Â  Â  .input-group input:focus,.input-group textarea:focus,.input-group select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(255,107,53,.1)}
Â  Â  .input-group .input-icon{position:absolute;left:18px;top:50%;transform:translateY(-50%);font-size:20px;color:var(--text-secondary)}
Â  Â  .input-group textarea + .input-icon{top:20px;transform:none}
Â  Â  .btn-group{display:flex;gap:12px;margin-top:24px}
Â  Â  .btn{flex:1;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border:none;border-radius:16px;padding:18px;font-size:16px;font-weight:700;color:var(--text);cursor:pointer;transition:.3s cubic-bezier(.4,0,.2,1);box-shadow:0 4px 16px rgba(255,107,53,.3);display:flex;align-items:center;justify-content:center;gap:8px}
Â  Â  .btn-secondary{background:var(--card-bg);border:2px solid var(--border);box-shadow:none}
Â  Â  .btn-success{background:linear-gradient(135deg,var(--success),#05b78b)}
Â  Â  .btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(255,255,255,.4)}
Â  Â  .summary-card{background:linear-gradient(135deg,var(--secondary),var(--secondary-light));border:none;padding:28px}
Â  Â  .summary-row{display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid rgba(255,255,255,.1)}
Â  Â  .summary-row:last-child{border-bottom:none;padding-bottom:0}
Â  Â  .summary-label{font-size:14px;color:var(--text-secondary);font-weight:600}
Â  Â  .summary-value{font-size:18px;font-weight:700;text-align:right}
Â  Â  .success-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,14,39,.95);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .3s ease}
Â  Â  .success-overlay.show{display:flex}
Â  Â  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
Â  Â  .success-content{text-align:center;animation:popIn .5s cubic-bezier(.68,-.55,.265,1.55)}
Â  Â  @keyframes popIn{0%{transform:scale(0);opacity:0}100%{transform:scale(1);opacity:1}}
Â  Â  .success-icon{font-size:80px;margin-bottom:20px;animation:bounce 1s ease}
Â  Â  @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-30px)}60%{transform:translateY(-15px)}}
Â  Â  .success-title{font-size:28px;font-weight:800;margin-bottom:12px}
Â  Â  .success-message{font-size:16px;color:var(--text-secondary)}
Â  Â  .page{display:none}
Â  Â  .page.active{display:block;animation:fadeIn .3s ease}
Â  Â  .month-toggle{display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--card-bg);border:1px dashed var(--border);border-radius:16px;padding:14px 16px;cursor:pointer}
Â  Â  .month-toggle span{font-weight:700}
Â  Â  .month-list{display:none;flex-direction:column;gap:12px;margin-top:12px}
Â  Â  .month-list.open{display:flex}
Â  Â  .month-item{display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--bg-light);border:1px solid var(--border);border-radius:16px;padding:12px 14px}
Â  Â  .mi-left{display:flex;align-items:center;gap:12px}
Â  Â  .mi-date{min-width:54px;text-align:center;font-weight:800;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:12px;padding:6px 8px}
Â  Â  .mi-main{display:flex;flex-direction:column}
Â  Â  .mi-cant{font-weight:700}
Â  Â  .mi-lav{font-size:13px;color:var(--text-secondary)}
Â  Â  .mi-ore{font-weight:800}
Â  Â  .mi-btn{background:linear-gradient(135deg,var(--secondary),var(--secondary-light));border:none;border-radius:12px;color:#fff;padding:8px 12px;cursor:pointer}
Â  Â  .month-item.weekend, .month-item.holiday{background: linear-gradient(0deg, rgba(220, 38, 38, 0.12), rgba(220, 38, 38, 0.12)), var(--bg-light); border-color: rgba(220, 38, 38, 0.35);}
Â  Â  .work-item{background:var(--card-bg);border:1px solid var(--border);border-radius:16px;padding:14px;margin-top:12px}
Â  Â  .work-item-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
Â  Â  .work-item-title{font-weight:800;font-size:14px;color:#fff}
Â  Â  .work-item-remove{background:transparent;border:1px solid var(--border);color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;font-size:12px}
Â  Â  .add-work-btn{margin-top:12px;width:100%;background:linear-gradient(135deg,var(--secondary),var(--secondary-light));color:#fff;border:none;border-radius:14px;padding:12px;font-weight:800;cursor:pointer}
Â  Â  .work-item .input-group{margin-top:10px}
Â  Â  .summary-works{display:flex;flex-direction:column;gap:10px}
Â  Â  .summary-work{display:flex;flex-direction:column;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:10px}
Â  Â  .summary-work .line{display:flex;justify-content:space-between;gap:8px}
Â  Â  .summary-work .label{color:var(--text-secondary);font-size:12px}
Â  Â  .summary-work .value{font-weight:700}
Â  </style>
</head>
<body>
Â  <div class="container">
Â  Â  <div class="header">
Â  Â  Â  <h1>âš¡ Presenze Cantiere</h1>
Â  Â  Â  <p class="subtitle">Registra la tua giornata lavorativa</p>
Â  Â  Â  <div class="user-badge"><span>ğŸ‘·</span><span id="userName">Mario Rossi</span></div>
Â  Â  </div>

Â  Â  <div class="content">
Â  Â  Â  <div class="step-indicator"><div class="step active"></div><div class="step"></div><div class="step"></div><div class="step"></div></div>

Â  Â  Â  Â  Â  Â  <div class="page active" id="page1">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div class="card-title"><span class="icon">ğŸ“…</span><span>Seleziona la data</span></div>
Â  Â  Â  Â  Â  <div class="date-selector" id="dateSelector"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div class="month-toggle" id="monthToggle">
Â  Â  Â  Â  Â  Â  <span id="monthTitle">ğŸ“† Presenze del mese</span>
Â  Â  Â  Â  Â  Â  <strong id="monthToggleArrow">â–¼</strong>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="monthList" class="month-list"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  Â  <button class="btn" onclick="nextPage(2)">Avanti <span>â†’</span></button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="page" id="page2">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div class="card-title"><span class="icon">â°</span><span>Orario di lavoro</span></div>
Â  Â  Â  Â  Â  <div class="time-picker">
Â  Â  Â  Â  Â  Â  <div class="time-slot morning">
Â  Â  Â  Â  Â  Â  Â  <div class="slot-bg"></div>
Â  Â  Â  Â  Â  Â  Â  <div class="slot-inner">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="slot-head"><span class="icon">â˜€ï¸</span><div class="label">Mattina</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="slot-time" id="morningText">08:00 - 12:00</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-inputs">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="mStart" value="08:00" oninput="updateTimes()" step="1800" min="07:00" max="15:00">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="mEnd" value="12:00" oninput="updateTimes()" step="1800" min="07:00" max="15:00">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="time-slot afternoon">
Â  Â  Â  Â  Â  Â  Â  <div class="slot-bg"></div>
Â  Â  Â  Â  Â  Â  Â  <div class="slot-inner">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="slot-head"><span class="icon">ğŸŒ™</span><div class="label">Pomeriggio</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="slot-time" id="afternoonText">13:00 - 17:00</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-inputs">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="pStart" value="13:00" oninput="updateTimes()" step="1800" min="12:00" max="20:00">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="pEnd" value="17:00" oninput="updateTimes()" step="1800" min="12:00" max="20:00">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="margin-top:16px;padding:16px;background:var(--bg-light);border-radius:16px;text-align:center;">
Â  Â  Â  Â  Â  Â  <div style="color:var(--text-secondary);font-size:14px;margin-bottom:4px;">Ore totali</div>
Â  Â  Â  Â  Â  Â  <div style="font-size:32px;font-weight:800;color:var(--accent);" id="totalHours">8.0h</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  Â  <button class="btn btn-secondary" onclick="prevPage(1)"><span>â†</span>Indietro</button>
Â  Â  Â  Â  Â  <button class="btn" onclick="nextPage(3)">Avanti <span>â†’</span></button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="page" id="page3">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div class="card-title"><span class="icon">ğŸ—ï¸</span><span>Cantieri</span></div>
Â  Â  Â  Â  Â  <div id="workItems"></div>
Â  Â  Â  Â  Â  <button class="add-work-btn" id="addWorkBtn" onclick="addWorkItem()">+ Aggiungi cantiere (max 3)</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div class="card-title"><span class="icon">ğŸ—’ï¸</span><span>Note aggiuntive</span></div>
Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  <textarea placeholder="Aggiungi dettagli, problemi o informazioni utili..." id="notesInput" oninput="onNotesChange(this.value)"></textarea>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  Â  <button class="btn btn-secondary" onclick="prevPage(2)"><span>â†</span>Indietro</button>
Â  Â  Â  Â  Â  <button class="btn" onclick="nextPage(4)">Avanti <span>â†’</span></button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="page" id="page4">
Â  Â  Â  Â  <div class="card summary-card">
Â  Â  Â  Â  Â  <div class="card-title" style="color:#fff;margin-bottom:20px;"><span class="icon">ğŸ“‹</span><span>Riepilogo</span></div>
Â  Â  Â  Â  Â  <div class="summary-row"><span class="summary-label">Data</span><span class="summary-value" id="summaryDate">Oggi</span></div>
Â  Â  Â  Â  Â  <div class="summary-row"><span class="summary-label">Orario</span><span class="summary-value" id="summaryTime">08:00 - 17:00</span></div>
Â  Â  Â  Â  Â  <div class="summary-row" style="border:none;display:block;padding-top:10px;">
Â  Â  Â  Â  Â  Â  <div class="summary-label" style="margin-bottom:8px">Cantieri & lavorazioni</div>
Â  Â  Â  Â  Â  Â  <div class="summary-works" id="summaryWorks"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="summary-row"><span class="summary-label">Note</span><span class="summary-value" id="summaryNotes">-</span></div>
Â  Â  Â  Â  Â  <div class="summary-row"><span class="summary-label">Ore totali</span><span class="summary-value" style="color:var(--accent);" id="summaryHours">8.0h</span></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  Â  <button class="btn btn-secondary" onclick="prevPage(3)"><span>â†</span>Indietro</button>
Â  Â  Â  Â  Â  <button class="btn btn-success" onclick="submitPresence()"><span>âœ“</span>Conferma</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="success-overlay" id="successOverlay">
Â  Â  <div class="success-content">
Â  Â  Â  <div class="success-icon">âœ¨</div>
Â  Â  Â  <div class="success-title">Presenza registrata!</div>
Â  Â  Â  <div class="success-message">La tua giornata Ã¨ stata salvata con successo</div>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  /* --- GESTIONE STATO E DATI --- */

Â  Â  // Stato globale dell'applicazione
Â  Â  let currentPage = 1;
Â  Â  let selectedDate = new Date();
Â  Â  let noteText = '';
Â  Â  // Array che contiene gli oggetti dei cantieri/lavorazioni inseriti. Max 3.
Â  Â  // Ogni item: { id, siteSelect:'', siteManual:'', work:'' }
Â  Â  let workState = [];

Â  Â  // Dati predefiniti (potrebbero venire da un server)
Â  Â  const SITE_OPTIONS = [
Â  Â  Â  'Condominio Aurora', 'Scuola Media Verdi', 'Capannone Logistica B12',
Â  Â  Â  'Villa Colli Sud', 'Ristrutturazione Via Roma 21'
Â  Â  ];

Â  Â  /* --- UTILITIES E FUNZIONI DI SUPPORTO --- */

Â  Â  /**
Â  Â  Â * Funzioni per il calcolo e la gestione di date e orari.
Â  Â  Â */
Â  Â  function toMinutes(hhmm){ if(!hhmm) return 0; const [h,m]=hhmm.split(':').map(Number); return h*60+m; }
Â  Â  function diffHours(s,e){ const a=toMinutes(s), b=toMinutes(e); return Math.max(0,(b-a))/60; }
Â  Â  function pad2(n){return String(n).padStart(2,'0');}
Â  Â  function fmtDateHuman(d){ return d.toLocaleDateString('it-IT',{day:'numeric',month:'short'}); }
Â  Â  function fmtISO(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }

Â  Â  /**
Â  Â  Â * Funzioni per determinare se un giorno Ã¨ weekend o festivitÃ  italiana.
Â  Â  Â * Usa un algoritmo per il calcolo della Pasqua.
Â  Â  Â */
Â  Â  function isWeekend(d){ const day=d.getDay(); return day===0 || day===6; }
Â  Â  function easterDate(year){ const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1; return new Date(year,month-1,day);}
Â  Â  function addDays(date,n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
Â  Â  function sameYMD(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
Â  Â  function isItalianHoliday(d){
Â  Â  Â  const y=d.getFullYear();
Â  Â  Â  const fixed=[[1,1],[1,6],[4,25],[5,1],[6,2],[8,15],[11,1],[12,8],[12,25],[12,26]];
Â  Â  Â  for(const [mm,dd] of fixed){ if(sameYMD(d,new Date(y,mm-1,dd))) return true; }
Â  Â  Â  const easter=easterDate(y); const monday=addDays(easter,1);
Â  Â  Â  return sameYMD(d,monday);
Â  Â  }

Â  Â  /* --- UI & RENDERING --- */

Â  Â  /**
Â  Â  Â * Applica uno zoom dinamico all'interfaccia per adattarla
Â  Â  Â * alla larghezza dello schermo del dispositivo.
Â  Â  Â */
Â  Â  function applyAutoScale(){
Â  Â  Â  const base=420, w=Math.max(320, Math.min(window.innerWidth,1024));
Â  Â  Â  const scale=Math.max(1, Math.min(1.35, w/base));
Â  Â  Â  document.documentElement.style.setProperty('--zoom', scale.toFixed(3));
Â  Â  }

Â  Â  /**
Â  Â  Â * Inizializza il selettore di date, mostrando gli ultimi 14 giorni.
Â  Â  Â * Evidenzia weekend, festivi e il giorno corrente.
Â  Â  Â */
Â  Â  function initDateSelector(){
Â  Â  Â  const selector=document.getElementById('dateSelector'); selector.innerHTML='';
Â  Â  Â  const today=new Date(); const dayLetter=['D','L','M','M','G','V','S'];
Â  Â  Â  for(let i=13;i>=0;i--){
Â  Â  Â  Â  const d=new Date(today); d.setDate(today.getDate()-i);
Â  Â  Â  Â  const dayDiv=document.createElement('div');
Â  Â  Â  Â  dayDiv.className='date-day'; dayDiv.dataset.date=fmtISO(d);
Â  Â  Â  Â  if(isWeekend(d)) dayDiv.classList.add('weekend');
Â  Â  Â  Â  if(isItalianHoliday(d)) dayDiv.classList.add('holiday');
Â  Â  Â  Â  if(i===0){ dayDiv.classList.add('today','selected'); selectedDate=today; }
Â  Â  Â  Â  dayDiv.innerHTML=`<div class="day-name">${dayLetter[d.getDay()]}</div><div class="day-num">${d.getDate()}</div>`;
Â  Â  Â  Â  dayDiv.onclick=()=>selectDate(dayDiv,d);
Â  Â  Â  Â  selector.appendChild(dayDiv);
Â  Â  Â  }
Â  Â  Â  const last=selector.lastElementChild; if(last && last.scrollIntoView){ last.scrollIntoView({behavior:'instant',block:'nearest',inline:'end'}); }
Â  Â  Â  updateSummary();
Â  Â  }
Â  Â  function selectDate(el,date){
Â  Â  Â  document.querySelectorAll('.date-day').forEach(d=>d.classList.remove('selected'));
Â  Â  Â  el.classList.add('selected'); selectedDate=date; updateSummary();
Â  Â  }

Â  Â  /**
Â  Â  Â * Aggiorna il testo degli orari e ricalcola le ore totali.
Â  Â  Â */
Â  Â  function updateTimes(){
Â  Â  Â  const ms=document.getElementById('mStart').value, me=document.getElementById('mEnd').value;
Â  Â  Â  const ps=document.getElementById('pStart').value, pe=document.getElementById('pEnd').value;
Â  Â  Â  document.getElementById('morningText').textContent=`${ms} - ${me}`;
Â  Â  Â  document.getElementById('afternoonText').textContent=`${ps} - ${pe}`;
Â  Â  Â  let hours=0; hours+=diffHours(ms,me); hours+=diffHours(ps,pe);
Â  Â  Â  document.getElementById('totalHours').textContent=hours.toFixed(1)+'h';
Â  Â  Â  updateSummary();
Â  Â  }
Â  Â  function buildOrariString(){
Â  Â  Â  const ms=document.getElementById('mStart').value, me=document.getElementById('mEnd').value;
Â  Â  Â  const ps=document.getElementById('pStart').value, pe=document.getElementById('pEnd').value;
Â  Â  Â  return `${ms}-${me} + ${ps}-${pe}`;
Â  Â  }

Â  Â  /**
Â  Â  Â * Funzioni per la gestione dinamica dei cantieri (aggiunta, rimozione, rendering).
Â  Â  Â */
Â  Â  function newWorkItem(){ return { id:crypto.randomUUID(), siteSelect:'', siteManual:'', work:'' }; }
Â  Â  function renderWorkItems(){
Â  Â  Â  const wrap = document.getElementById('workItems');
Â  Â  Â  wrap.innerHTML = '';
Â  Â  Â  workState.forEach((item, idx) => {
Â  Â  Â  Â  const el = document.createElement('div');
Â  Â  Â  Â  el.className = 'work-item'; el.dataset.id = item.id;
Â  Â  Â  Â  el.innerHTML = `
Â  Â  Â  Â  Â  <div class="work-item-head">
Â  Â  Â  Â  Â  Â  <div class="work-item-title">Cantiere ${idx+1}</div>
Â  Â  Â  Â  Â  Â  ${idx>0 ? '<button class="work-item-remove" onclick="removeWorkItem(\''+item.id+'\')">Rimuovi</button>' : ''}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  <span class="input-icon">ğŸ·ï¸</span>
Â  Â  Â  Â  Â  Â  <select onchange="onWorkSelectChange('${item.id}', this.value)">
Â  Â  Â  Â  Â  Â  Â  <option value="">â€” Seleziona cantiere â€”</option>
Â  Â  Â  Â  Â  Â  Â  ${SITE_OPTIONS.map(s=>`<option ${item.siteSelect===s?'selected':''}>${s}</option>`).join('')}
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  <span class="input-icon">ğŸ”</span>
Â  Â  Â  Â  Â  Â  <input type="text" placeholder="Oppure scrivi il nome del cantiere..." value="${item.siteManual.replace(/"/g,'&quot;')}" oninput="onWorkManualChange('${item.id}', this.value)">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  <span class="input-icon">ğŸ“</span>
Â  Â  Â  Â  Â  Â  <textarea placeholder="Descrivi la lavorazione..." oninput="onWorkTextChange('${item.id}', this.value)">${item.work}</textarea>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  wrap.appendChild(el);
Â  Â  Â  });
Â  Â  Â  document.getElementById('addWorkBtn').disabled = (workState.length>=3);
Â  Â  Â  updateSummary();
Â  Â  }
Â  Â  function addWorkItem(){ if(workState.length>=3) return; workState.push(newWorkItem()); renderWorkItems(); }
Â  Â  function removeWorkItem(id){ workState = workState.filter(w => w.id !== id); if(workState.length===0) workState.push(newWorkItem()); renderWorkItems(); }
Â  Â  function onWorkSelectChange(id, val){ const it=workState.find(w=>w.id===id); if(!it)return; it.siteSelect=val||''; if(val)it.siteManual=''; updateSummary(); renderWorkItems(); }
Â  Â  function onWorkManualChange(id, val){ const it=workState.find(w=>w.id===id); if(!it)return; it.siteManual=val; if(val.trim())it.siteSelect=''; updateSummary(); renderWorkItems(); }
Â  Â  function onWorkTextChange(id, val){ const it=workState.find(w=>w.id===id); if(!it)return; it.work=val; updateSummary(); }
Â  Â  function onNotesChange(val){ noteText = val; updateSummary(); }

Â  Â  /**
Â  Â  Â * Aggiorna la card di riepilogo finale con tutti i dati inseriti.
Â  Â  Â */
Â  Â  function updateSummary(){
Â  Â  Â  document.getElementById('summaryDate').textContent=fmtDateHuman(selectedDate);
Â  Â  Â  document.getElementById('summaryTime').textContent=buildOrariString();
Â  Â  Â  const box=document.getElementById('summaryWorks'); box.innerHTML = '';
Â  Â  Â  workState.forEach((it, idx)=>{
Â  Â  Â  Â  const name = (it.siteSelect || it.siteManual || '-').trim() || '-';
Â  Â  Â  Â  const work = (it.work || '-').trim() || '-';
Â  Â  Â  Â  const div = document.createElement('div'); div.className='summary-work';
Â  Â  Â  Â  div.innerHTML = `<div class="line"><span class="label">Cantiere ${idx+1}</span><span class="value">${name}</span></div><div class="line"><span class="label">Lavorazione</span><span class="value">${work}</span></div>`;
Â  Â  Â  Â  box.appendChild(div);
Â  Â  Â  });
Â  Â  Â  document.getElementById('summaryNotes').textContent = noteText.trim() || '-';
Â  Â  Â  const ms=document.getElementById('mStart').value, me=document.getElementById('mEnd').value;
Â  Â  Â  const ps=document.getElementById('pStart').value, pe=document.getElementById('pEnd').value;
Â  Â  Â  let hours=0; hours+=diffHours(ms,me); hours+=diffHours(ps,pe);
Â  Â  Â  document.getElementById('summaryHours').textContent=hours.toFixed(1)+'h';
Â  Â  }

Â  Â  /**
Â  Â  Â * Gestisce la navigazione tra le pagine dell'interfaccia.
Â  Â  Â */
Â  Â  function nextPage(p){
Â  Â  Â  document.querySelector('.page.active').classList.remove('active');
Â  Â  Â  document.getElementById(`page${p}`).classList.add('active');
Â  Â  Â  currentPage=p;
Â  Â  Â  document.querySelectorAll('.step').forEach((s,i)=> s.classList.toggle('active', i<=p-1));
Â  Â  Â  window.scrollTo({top:0,behavior:'smooth'}); updateSummary();
Â  Â  }
Â  Â  function prevPage(p){ nextPage(p); }

Â  Â  /**
Â  Â  Â * Funzioni per la gestione della lista delle presenze del mese (dati mock).
Â  Â  Â */
Â  Â  function genMonthMock(){
Â  Â  Â  const base=new Date(); const out=[];
Â  Â  Â  const samples=[
Â  Â  Â  Â  {c:'Condominio Aurora', l:'Muratura pareti interne', or:'08:00-12:00 + 13:00-17:00', h:8.0},
Â  Â  Â  Â  {c:'Scuola Media Verdi', l:'Scalcinatura e rete', or:'07:30-12:30 + 13:30-17:15', h:8.8},
Â  Â  Â  Â  {c:'Capannone Logistica B12', l:'Impianto elettrico canaline', or:'08:00-12:00 + 13:00-16:30', h:7.5},
Â  Â  Â  Â  {c:'Villa Colli Sud', l:'Pittura primer', or:'08:00-12:30 + 13:30-17:45', h:9.3},
Â  Â  Â  Â  {c:'Ristrutturazione Via Roma 21', l:'Posa sottofondi', or:'08:00-12:00 + 13:00-17:00', h:8.0},
Â  Â  Â  Â  {c:'Condominio Aurora', l:'Serramenti â€“ rilievi', or:'09:00-12:00 + 13:00-17:30', h:7.5}
Â  Â  Â  ];
Â  Â  Â  for(let i=0;i<6;i++){ const d=new Date(base); d.setDate(base.getDate()-(i+1));
Â  Â  Â  Â  out.push({dataISO:fmtISO(d), cantiere:samples[i].c, lavorazione:samples[i].l, orari:samples[i].or, ore:String(samples[i].h)}); }
Â  Â  Â  return out.reverse();
Â  Â  }
Â  Â  function renderMonthList(){
Â  Â  Â  const list=document.getElementById('monthList'); list.innerHTML='';
Â  Â  Â  const rows=genMonthMock();
Â  Â  Â  const today=new Date(); const mese=today.toLocaleDateString('it-IT',{month:'long'});
Â  Â  Â  document.getElementById('monthTitle').textContent=`ğŸ“† Presenze mese ${mese}`;
Â  Â  Â  rows.forEach(r=>{
Â  Â  Â  Â  const d=new Date(r.dataISO);
Â  Â  Â  Â  const item=document.createElement('div');
Â  Â  Â  Â  const cls=['month-item']; if(isWeekend(d)) cls.push('weekend'); if(isItalianHoliday(d)) cls.push('holiday');
Â  Â  Â  Â  item.className=cls.join(' ');
Â  Â  Â  Â  item.innerHTML=`
Â  Â  Â  Â  Â  <div class="mi-left">
Â  Â  Â  Â  Â  Â  <div class="mi-date"><div>${pad2(d.getDate())}</div><div style="font-size:11px;color:var(--text-secondary)">${d.toLocaleDateString('it-IT',{month:'short'})}</div></div>
Â  Â  Â  Â  Â  Â  <div class="mi-main"><div class="mi-cant">${r.cantiere}</div><div class="mi-lav">${r.lavorazione}</div></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="display:flex;align-items:center;gap:10px"><div class="mi-ore">${r.ore}h</div><button class="mi-btn">Usa</button></div>`;
Â  Â  Â  Â  item.querySelector('.mi-btn').onclick=()=>applyTemplateFromMonth(r);
Â  Â  Â  Â  list.appendChild(item);
Â  Â  Â  });
Â  Â  }
Â  Â  function setupMonthToggle(){
Â  Â  Â  const toggle=document.getElementById('monthToggle'), arrow=document.getElementById('monthToggleArrow'), list=document.getElementById('monthList');
Â  Â  Â  list.classList.remove('open');
Â  Â  Â  toggle.addEventListener('click', ()=>{ const isOpen=list.classList.toggle('open'); arrow.textContent=isOpen?'â–²':'â–¼'; });
Â  Â  }

Â  Â  /**
Â  Â  Â * Applica un template (presenza passata) all'interfaccia corrente.
Â  Â  Â */
Â  Â  function applyTemplateFromMonth(r){
Â  Â  Â  const dParts=r.dataISO.split('-'); const d=new Date(+dParts[0],+dParts[1]-1,+dParts[2]);
Â  Â  Â  selectedDate=d;
Â  Â  Â  document.querySelectorAll('.date-day').forEach(dd=>dd.classList.toggle('selected', dd.dataset.date===r.dataISO));
Â  Â  Â  const parts=r.orari.split('+').map(s=>s.trim()); const [m,p]=parts;
Â  Â  Â  if(m){ const [ms,me]=m.split('-'); document.getElementById('mStart').value=ms; document.getElementById('mEnd').value=me; }
Â  Â  Â  if(p){ const [ps,pe]=p.split('-'); document.getElementById('pStart').value=ps; document.getElementById('pEnd').value=pe; }
Â  Â  Â  updateTimes();
Â  Â  Â  workState = [ newWorkItem() ];
Â  Â  Â  workState[0].siteSelect = SITE_OPTIONS.includes(r.cantiere) ? r.cantiere : '';
Â  Â  Â  workState[0].siteManual = SITE_OPTIONS.includes(r.cantiere) ? '' : r.cantiere;
Â  Â  Â  workState[0].work = r.lavorazione;
Â  Â  Â  noteText = ''; document.getElementById('notesInput').value = '';
Â  Â  Â  renderWorkItems();
Â  Â  Â  nextPage(2);
Â  Â  }

Â  Â  /**
Â  Â  Â * Raccoglie tutti i dati, li salva in localStorage e mostra un messaggio di successo.
Â  Â  Â */
Â  Â  function submitPresence(){
Â  Â  Â  const payload={
Â  Â  Â  Â  dataISO:fmtISO(selectedDate),
Â  Â  Â  Â  orari: buildOrariString(),
Â  Â  Â  Â  ore: document.getElementById('summaryHours').textContent.replace('h',''),
Â  Â  Â  Â  note: noteText,
Â  Â  Â  Â  lavori: workState.map(w=>({
Â  Â  Â  Â  Â  cantiere: (w.siteSelect || w.siteManual || '-'),
Â  Â  Â  Â  Â  lavorazione: (w.work || '-')
Â  Â  Â  Â  }))
Â  Â  Â  };
Â  Â  Â  // Qui i dati verrebbero inviati a un server. Per ora li salviamo localmente.
Â  Â  Â  localStorage.setItem('ultimaPresenza', JSON.stringify(payload));
Â  Â  Â  document.getElementById('successOverlay').classList.add('show');
Â  Â  Â  setTimeout(()=>{
Â  Â  Â  Â  document.getElementById('successOverlay').classList.remove('show');
Â  Â  Â  Â  nextPage(1);
Â  Â  Â  },1200);
Â  Â  }

Â  Â  /**
Â  Â  Â * Funzione di inizializzazione che viene eseguita al caricamento della pagina.
Â  Â  Â */
Â  Â  document.addEventListener('DOMContentLoaded',()=>{
Â  Â  Â  initDateSelector();
Â  Â  Â  renderMonthList();
Â  Â  Â  setupMonthToggle();
Â  Â  Â  applyAutoScale();
Â  Â  Â  // Inizia sempre con un cantiere vuoto
Â  Â  Â  workState = [ newWorkItem() ];
Â  Â  Â  renderWorkItems();
Â  Â  Â  updateTimes();
Â  Â  });
Â  </script>
</body>
</html>
