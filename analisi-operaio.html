<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Analisi per operaio</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --primary: hsl(210,100%,40%);
    --text: hsl(210,10%,20%);
    --muted: hsl(210,6%,45%);
    --bg: hsl(210,20%,98%);
    --card: #fff;
    --border: hsl(210,15%,85%);
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text);
       font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .container{width:100%; max-width:1200px; margin:0 auto; padding:18px}
  h1{margin:0 0 12px; font-size:20px}

  .panel{
    background:var(--card); border:1px solid var(--border); border-radius:12px;
    padding:14px; box-shadow:0 2px 8px rgba(0,0,0,.04); margin-bottom:16px;
  }
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .nav a{
    padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:#fff;
    text-decoration:none; font-weight:700; color:var(--text)
  }
  .nav a.primary{background:var(--primary); color:#fff; border-color:var(--primary)}
  input[type="month"]{padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff}
  .spinner{display:none}
  .spinner.show{display:inline-block; width:16px; height:16px; border:2px solid #ddd;
    border-top-color:var(--primary); border-radius:50%; animation:spin .9s linear infinite; vertical-align:-3px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .ok{color:#0b7a0b; font-weight:700}
  .error{color:#b00020; font-weight:700}

  .table-card{
    background:var(--card); border:1px solid var(--border); border-radius:12px;
    box-shadow:0 2px 8px rgba(0,0,0,.04); overflow:auto;
  }
  .table-title{padding:10px 12px; border-bottom:1px solid var(--border); font-weight:700}
  .table-wrap{width:100%; overflow:auto}

  table{border-collapse:separate; border-spacing:0; width:100%; font-size:13px}
  thead th{background:#fff; border-bottom:1px solid var(--border); padding:8px 10px; text-align:left; white-space:nowrap}
  tbody td{border-top:1px solid var(--border); padding:8px 10px; white-space:nowrap}
  td.num{text-align:right}
</style>
</head>
<body>
<div class="container">
  <h1>Analisi per operaio</h1>

  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="prevMonth" title="Mese precedente">◀</button>
        <input type="month" id="mese">
        <button id="nextMonth" title="Mese successivo">▶</button>
        <button id="btnCarica">Carica</button>
        <span id="spin" class="spinner"></span>
      </div>
      <div class="row nav">
        <a href="gestione.html">Presenze</a>
        <a class="primary" href="analisi-operaio.html">Analisi per operaio</a>
        <a href="analisi-cantiere.html">Analisi per cantiere</a>
      </div>
    </div>
    <div id="status" style="margin-top:6px"></div>
  </div>

  <div class="table-card">
    <div class="table-title">Riepilogo mese corrente</div>
    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>Operaio</th>
            <th class="num">Ore totali</th>
            <th class="num">Giorni</th>
            <th class="num">Media / giorno</th>
            <th class="num">Ore weekend/festivi</th>
            <th class="num">GG “NO DATI” (feriali)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const SHEET_ID = "1glvkWLOpUhdBUmY4j-2DJoXQvY6dnQD_OQkYYCaXXEQ";

/* ====== UTIL ====== */
const pad = n => String(n).padStart(2,"0");
function calcEaster(Y){
  const a=Y%19,b=Math.floor(Y/100),c=Y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),
        g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,L=(32+2*e+2*i-h-k)%7,
        m=Math.floor((a+11*h+22*L)/451),month=Math.floor((h+L-7*m+114)/31),day=((h+L-7*m+114)%31)+1;
  return new Date(Y,month-1,day);
}
function italianHolidays(year){
  const set=new Set(),add=(m,d)=>set.add(`${year}-${pad(m)}-${pad(d)}`);
  add(1,1); add(1,6); add(4,25); add(5,1); add(6,2); add(8,15); add(11,1); add(12,8); add(12,25); add(12,26);
  const p=calcEaster(year), q=new Date(p); q.setDate(p.getDate()+1);
  add(p.getMonth()+1,p.getDate()); add(q.getMonth()+1,q.getDate());
  return set;
}
const normalize = s => String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim().toLowerCase();
function getFieldSmart(row, candidates){
  for(const k of candidates){ if(row.hasOwnProperty(k) && row[k] != null && row[k] !== "") return row[k]; }
  const keys = Object.keys(row);
  const normMap = new Map(keys.map(k => [normalize(k), k]));
  for(const cand of candidates){
    const n = normalize(cand);
    if(normMap.has(n)){
      const realKey = normMap.get(n);
      if(row[realKey] != null && row[realKey] !== "") return row[realKey];
    }
  }
  const targets = candidates.map(normalize);
  for(const k of keys){
    const nk = normalize(k);
    if(targets.some(t => nk.includes(t))){
      if(row[k] != null && row[k] !== "") return row[k];
    }
  }
  for(const k of candidates){ if(row[k] != null && row[k] !== "") return row[k]; }
  return "";
}
function isBlankCantiere(value){
  const s = String(value||"").trim();
  if(!s) return true;
  if (/^[-–—]+$/.test(s)) return true;
  if (/^(nd|n\.d\.|n\/d|na|n\.a\.|n\/a|non\s+specificato|sconosciuto|nessuno|undefined|null)$/i.test(s)) return true;
  if (/^\(s.*cantiere\)$/i.test(s)) return true;
  return false;
}

/* ====== UI refs ====== */
const meseInput = document.getElementById('mese');
const prevBtn   = document.getElementById('prevMonth');
const nextBtn   = document.getElementById('nextMonth');
const btnCarica = document.getElementById('btnCarica');
const spin      = document.getElementById('spin');
const statusEl  = document.getElementById('status');
const tbody     = document.getElementById('tbody');

function setYM(Y,M){ meseInput.value = `${Y}-${pad(M)}`; }
function getYM(){
  const v = meseInput.value;
  if(/^\d{4}-\d{2}$/.test(v)){ const [Y,M]=v.split('-').map(Number); return [Y,M]; }
  const d=new Date(); return [d.getFullYear(), d.getMonth()+1];
}
function shiftMonth(delta){
  let [Y,M]=getYM(); M+=delta;
  if(M<1){M=12;Y--} if(M>12){M=1;Y++}
  setYM(Y,M); carica();
}

/* ====== DATA & RENDER ====== */
function setLoading(on){
  spin.classList.toggle('show', !!on);
  btnCarica.disabled = !!on; prevBtn.disabled=!!on; nextBtn.disabled=!!on;
}

async function carica(){
  try{
    setLoading(true); statusEl.textContent=""; tbody.innerHTML="";
    const [Y,M]=getYM();
    const holidays = italianHolidays(Y);

    const res = await fetch(`https://opensheet.elk.sh/${SHEET_ID}/Foglio1`);
    const rows = await res.json();

    // by operaio & day
    const byOpDay = {};  // {op: { d: [ {ore, cantiere} ] } }

    rows.forEach((r)=>{
      const dataVal = getFieldSmart(r, ["Data","A","DATA","data"]);
      if(!dataVal) return;
      const s = String(dataVal).trim();
      let y,m,d;
      if(/^\d{4}-\d{2}-\d{2}/.test(s)){ [y,m,d]=s.split("T")[0].split("-").map(Number); }
      else if(/^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)){ const [dd,mm,yy]=s.split(/[ /]/).map(Number); y=yy;m=mm;d=dd; }
      else { const t=new Date(s); if(isNaN(t)) return; y=t.getFullYear(); m=t.getMonth()+1; d=t.getDate(); }
      if(y!==Y || m!==M) return;

      const op   = String(getFieldSmart(r, ["Operaio","C","OPERAIO","operaio"])).trim();
      if(!op) return;
      const cant = String(getFieldSmart(r, ["Cantiere","E","CANTIERE","cantiere"])).trim();
      const oreV = getFieldSmart(r, ["Ore","H","ORE","ore"]);
      const ore  = (oreV!=="" && oreV!=null) ? Number(String(oreV).replace(",",".")) : 0;

      (byOpDay[op] ||= {});
      (byOpDay[op][d] ||= []);
      byOpDay[op][d].push({ore, cantiere:cant});
    });

    const operai = Object.keys(byOpDay).sort((a,b)=>a.localeCompare(b,'it'));

    const out = operai.map(op=>{
      let tot=0, daysWorked=0, weekendHours=0, noDataDays=0;
      const days = byOpDay[op] || {};

      Object.keys(days).forEach(sd=>{
        const d = Number(sd);
        const list = days[d] || [];
        if(list.length===0) return;

        let dayH=0, hasNoCant=false;
        const date = new Date(Y, M-1, d);
        const dow  = (date.getDay()+6)%7;
        const iso  = `${Y}-${pad(M)}-${pad(d)}`;
        const isOff= (dow===5||dow===6) || holidays.has(iso);

        list.forEach(en=>{
          const h = (en.ore!=null && !isNaN(en.ore)) ? Number(en.ore) : 0;
          dayH += h;
          if(isBlankCantiere(en.cantiere)) hasNoCant = true;
        });

        if(dayH>0){
          daysWorked++;
          tot += dayH;
          if(isOff) weekendHours += dayH;
        }
        if(hasNoCant && !isOff) noDataDays++;
      });

      const media = daysWorked ? +(tot/daysWorked).toFixed(2) : 0;
      return { op, tot:+tot.toFixed(2), days:daysWorked, media, weekend:+weekendHours.toFixed(2), nodati:noDataDays };
    }).sort((a,b)=> b.tot - a.tot || a.op.localeCompare(b.op,'it'));

    if(out.length===0){
      tbody.innerHTML = `<tr><td colspan="6" style="padding:16px; color:#999; text-align:center">Nessun operaio con ore nel mese.</td></tr>`;
    }else{
      out.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${r.op}</td>
          <td class="num">${r.tot}</td>
          <td class="num">${r.days}</td>
          <td class="num">${r.media}</td>
          <td class="num">${r.weekend}</td>
          <td class="num">${r.nodati}</td>`;
        tbody.appendChild(tr);
      });
    }
    statusEl.innerHTML = `<span class="ok">Analisi aggiornata</span>`;
  }catch(e){
    console.error(e);
    statusEl.innerHTML = `<span class="error">Errore nel caricamento dati.</span>`;
  }finally{
    setLoading(false);
  }
}

/* ====== INIT ====== */
(function init(){
  const now=new Date(); setYM(now.getFullYear(), now.getMonth()+1);
  document.getElementById('btnCarica').addEventListener('click', carica);
  prevBtn.addEventListener('click', ()=>shiftMonth(-1));
  nextBtn.addEventListener('click', ()=>shiftMonth(+1));
  meseInput.addEventListener('change', carica);
  carica();
})();
</script>
</body>
</html>
