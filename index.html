<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Presenze Cantiere</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: hsl(210, 100%, 40%);
      --color-primary-dark: hsl(210, 100%, 30%);
      --color-accent: hsl(140, 60%, 40%);
      --color-accent-dark: hsl(140, 60%, 30%);
      --color-warning: hsl(40, 90%, 60%);
      --color-text-dark: hsl(210, 10%, 20%);
      --color-text-light: hsl(210, 5%, 50%);
      --color-bg-light: hsl(210, 20%, 98%);
      --color-bg-alt: hsl(210, 10%, 95%);
      --color-border: hsl(210, 15%, 85%);
      --color-success-bg: hsl(140, 60%, 95%);
      --color-success-border: hsl(140, 60%, 75%);
      --color-warning-bg: hsl(40, 90%, 95%);
      --color-warning-border: hsl(40, 90%, 80%);
      --border-radius-base: 8px;
      --shadow-light: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-medium: 0 4px 8px rgba(0,0,0,0.1);
      --shadow-strong: 0 8px 16px rgba(0,0,0,0.15);
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: var(--color-bg-light);
      color: var(--color-text-dark);
      padding: 20px;
      margin: 0;
      box-sizing: border-box;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 0 10px;
    }
    h2, h3 {
      text-align: center;
      color: var(--color-primary-dark);
      margin-bottom: 20px;
    }
    input, select, button {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      font-size: 16px;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-base);
      box-sizing: border-box;
      box-shadow: var(--shadow-light);
      min-height: 48px;
    }
    input:focus, select:focus, button:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px hsla(210, 100%, 40%, 0.2);
    }
    button {
      background-color: var(--color-primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: var(--shadow-medium);
    }
    button:hover {
      background-color: var(--color-primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-strong);
    }
    #form { margin-top: 20px; }
    #benvenuto {
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
      color: var(--color-text-dark);
      font-size: 20px;
    }
    #btnInvia {
      background: linear-gradient(to right, var(--color-accent), var(--color-accent-dark));
      font-size: 18px;
      font-weight: bold;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    #btnInvia:hover {
      background: linear-gradient(to right, var(--color-accent-dark), hsl(140, 60%, 25%));
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
    }
    .section-label {
      font-weight: bold;
      color: var(--color-text-dark);
      margin-top: 15px;
      display: block;
      margin-bottom: 5px;
    }
    .card {
      background-color: white;
      padding: 15px;
      border-radius: var(--border-radius-base);
      box-shadow: var(--shadow-medium);
      border: 1px solid var(--color-border);
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="notifica"><strong>Dati inseriti correttamente</strong></div>
    <div id="benvenuto"><div id="messaggioBenvenuto"></div></div>
    <div id="login" class="card">
      <h2>ğŸ” Login</h2>
      <input type="text" id="user" placeholder="ğŸ”‘ Utente">
      <input type="password" id="pass" placeholder="ğŸ”’ Password">
      <button onclick="login()">ğŸ”“ Accedi</button>
      <div style="text-align:center; margin-top:15px;">
        <button onclick="cambiaLingua('it')" style="border:none; background:none; cursor:pointer;">ğŸ‡®ğŸ‡¹</button>
        <button onclick="cambiaLingua('en')" style="border:none; background:none; cursor:pointer;">ğŸ‡¬ğŸ‡§</button>
        <button onclick="cambiaLingua('fr')" style="border:none; background:none; cursor:pointer;">ğŸ‡«ğŸ‡·</button>
      </div>
    </div>
    <div id="form" style="display:none;">
      <h3>ğŸ“… Compila Presenza</h3>
      <label class="section-label" for="data">Data:</label>
      <input type="date" id="data">

      <div style="display:flex; flex-wrap:wrap; gap:15px; margin-top:15px;">
        <div style="flex:1;">
          <label class="section-label" for="oreLavorate">ğŸ•’ Ore lavorate:</label>
          <select id="oreLavorate">
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8" selected>8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
          </select>
        </div>
        <div style="flex:1;">
          <label class="section-label" for="numeroCantieri">ğŸ—ï¸ Cantieri:</label>
          <select id="numeroCantieri" onchange="generaCampiCantieri()">
            <option value="1" selected>1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
      </div>

      <div id="cantieriMultipli"></div>

      <button id="btnMultiOperai" onclick="mostraOperai()">ğŸ‘ğŸ¼ Inserisci dati per altri operai</button>

      <div id="multiOperai" class="card" style="display:none; margin-top:20px;">
        <p class="warning-message">âš ï¸ Agli operai selezionati verranno applicate le stesse lavorazioni indicate sopra.</p>
        <label class="section-label" for="operaio">ğŸ‘¥ Seleziona altri operai:</label>
        <select id="operaio" multiple size="6"></select>

        <div style="margin-top:15px;">
          <label class="section-label" for="nuovoOperaio">â• Oppure inserisci un nuovo operaio:</label>
          <input type="text" id="nuovoOperaio" placeholder="ğŸ‘· Inserisci nuovo operaio">
        </div>
      </div>

      <button onclick="mostraModal()" id="btnInvia">ğŸ“„ Invia Presenza</button>
      <button id="btnGestione" onclick="window.location.href='gestione.html'">ğŸ“… Vai alla Gestione Cantiere</button>

      <div id="ultimaLavorazioneBox">
        <span style="font-size: 24px; color: var(--color-primary);">âœ¨</span>
        <div>
          <p>La tua ultima lavorazione registrata:</p>
          <strong id="ultimaLavorazione">Caricamento...</strong>
        </div>
      </div>

      <div id="ultimi7" class="card">
        <h4>Recentemente:</h4>
      </div>
    </div>

    <div id="riepilogoAdmin" class="card" style="display:none;">
      <h3>ğŸ“ Riepilogo presenze odierne</h3>
      <div id="riepilogoCompilati" style="margin-bottom:20px;"></div>
      <div id="riepilogoMancanti"></div>
    </div>

    <div id="modalConferma">
      <div>
        <p>Vuoi confermare l'invio della presenza?</p>
        <div id="riepilogoDati"></div>
        <button onclick="confermaInvio()">âœ… Conferma</button>
        <button onclick="chiudiModal()">âŒ Annulla</button>
      </div>
    </div>

    <footer style="text-align:center; font-size: 12px; color: #999; margin-top: 40px; padding-bottom: 20px;">
      Â© 2025 Davide Ferrarini â€” Tutti i diritti riservati
    </footer>
  </div>
<script>
  let utente = "";
  let nomeOperaio = "";
  let ultimoTestoLavorazione = "";
  let elencoCantieri = [];

  function login() {
    const userInput = document.getElementById("user").value.trim();
    const passInput = document.getElementById("pass").value.trim();

    fetch("https://opensheet.elk.sh/1glvkWLOpUhdBUmY4j-2DJoXQvY6dnQD_OQkYYCaXXEQ/Utenti")
      .then(r => r.json())
      .then(data => {
        const utenteTrovato = data.find(r => r["User"] === userInput && r["Password"] === passInput);
        if (utenteTrovato) {
          utente = utenteTrovato["User"];
          nomeOperaio = utenteTrovato["Nome"];
          const ruolo = utenteTrovato["Ruolo"] || "";
          localStorage.setItem("ruolo", ruolo);
          document.getElementById("messaggioBenvenuto").innerText = `Benvenuto, ${nomeOperaio}`;
          if (ruolo.toLowerCase() !== "amministratore") {
            document.getElementById("btnGestione").style.display = "none";
          }
          document.getElementById("login").style.display = "none";
          document.getElementById("form").style.display = "block";
          document.getElementById("data").value = new Date().toISOString().split("T")[0];
          caricaUltimaLavorazione(utente);
          caricaCantieri();
          caricaOperai();
          caricaUltimi7();
          caricaRiepilogoAdmin();
          generaCampiCantieri();
        } else {
          alert("Credenziali errate");
        }
      });
  }

  function caricaCantieri() {
    fetch("https://opensheet.elk.sh/1glvkWLOpUhdBUmY4j-2DJoXQvY6dnQD_OQkYYCaXXEQ/Cantieri")
      .then(r => r.json())
      .then(data => {
        elencoCantieri = data.filter(r => r["Cantiere"]).map(r => r["Cantiere"]);
        generaCampiCantieri();
      });
  }

  function caricaOperai() {
    fetch("https://opensheet.elk.sh/1glvkWLOpUhdBUmY4j-2DJoXQvY6dnQD_OQkYYCaXXEQ/Utenti")
      .then(r => r.json())
      .then(data => {
        const select = document.getElementById("operaio");
        select.innerHTML = "";
        data.forEach(r => {
          if (r["Nome"]) {
            const opt = document.createElement("option");
            opt.value = r["Nome"];
            opt.textContent = r["Nome"];
            select.appendChild(opt);
          }
        });
      });
  }

  function mostraCantiereLibero(index) {
    const div = document.getElementById(`cantiereLibero_${index}`);
    div.style.display = (div.style.display === "block") ? "none" : "block";
  }

  function generaCampiCantieri() {
    const nCantieri = parseInt(document.getElementById("numeroCantieri").value);
    const container = document.getElementById("cantieriMultipli");
    container.innerHTML = "";
    for (let i = 1; i <= nCantieri; i++) {
      let selectHtml = `<select id="cantiere_${i}"><option value="">-- Seleziona Cantiere --</option>`;
      elencoCantieri.forEach(nome => {
        selectHtml += `<option value="${nome}">${nome}</option>`;
      });
      selectHtml += `</select>`;
      container.innerHTML += `
        <div class="card" style="margin-top: 15px;">
          <label class="section-label" for="cantiere_${i}">ğŸ—ï¸ Cantiere ${i}:</label>
          ${selectHtml}
          <button type="button" onclick="mostraCantiereLibero(${i})" id="btnCantiereAltro">ğŸ  Cantiere non presente</button>
          <div id="cantiereLibero_${i}" style="display:none;">
            <input type="text" id="cantiereAltro_${i}" placeholder="ğŸ¢ Inserisci nome cantiere ${i}">
          </div>
          <div id="importaBox">
            <h4>ğŸ’…â€‹ Lavorazioni eseguite per cantiere ${i}</h4>
            <p class="sottotitolo">ğŸ’¡ Scegli tra le lavorazioni recenti o scrivine una nuova:</p>
            <div class="importa-riga">
              <input list="suggerimentiLavorazioni" id="lavorazione_${i}" placeholder="ğŸ§  Lavorazioni e suggerimenti" />
            </div>
          </div>
        </div>`;
    }
    document.getElementById("btnMultiOperai").style.display = (nCantieri === 1) ? "inline-block" : "none";
  }

  function mostraOperai() {
    const div = document.getElementById("multiOperai");
    div.style.display = (div.style.display === "block") ? "none" : "block";
  }

  function mostraModal() {
    const oreLavorate = parseInt(document.getElementById("oreLavorate").value) || 8;
    const data = document.getElementById("data").value;
    let operai = nomeOperaio;
    if (document.getElementById("multiOperai").style.display === "block") {
      const selezionati = Array.from(document.getElementById("operaio").selectedOptions).map(opt => opt.value);
      const nuovo = document.getElementById("nuovoOperaio").value.trim();
      if (nuovo) selezionati.push(nuovo);
      operai = selezionati.length > 0 ? selezionati.join(", ") : nomeOperaio;
    }
    const numeroCantieri = parseInt(document.getElementById("numeroCantieri").value);
    let dettagliCantieri = "";
    for (let i = 1; i <= numeroCantieri; i++) {
      let nomeCantiere = document.getElementById(`cantiere_${i}`)?.value || "(nessuno)";
      const nomeCantiereAltro = document.getElementById(`cantiereAltro_${i}`)?.value.trim() || "";
      if (nomeCantiereAltro) nomeCantiere = nomeCantiereAltro;
      const lavorazione = document.getElementById(`lavorazione_${i}`)?.value || "(nessuna)";
      dettagliCantieri += `<li><strong>Cantiere ${i}:</strong> ${nomeCantiere}<br><strong>Lavorazione:</strong> ${lavorazione}</li>`;
    }
    const riepilogoHTML = `
      <ul>
        <li><strong>Data:</strong> ${data}</li>
        <li><strong>Ore:</strong> ${oreLavorate}</li>
        <li><strong>Operai:</strong> ${operai}</li>
        <li><strong>Dettaglio Cantieri:</strong>
          <ul>${dettagliCantieri}</ul>
        </li>
      </ul>`;
    document.getElementById("riepilogoDati").innerHTML = riepilogoHTML;
    document.getElementById("modalConferma").style.display = "flex";
  }

  function chiudiModal() {
    document.getElementById("modalConferma").style.display = "none";
  }

  function confermaInvio() {
    chiudiModal();
    invia();
    const n = document.getElementById("notifica");
    n.style.display = "block";
    setTimeout(() => { n.style.display = "none"; }, 3500);
    document.getElementById("data").value = new Date().toISOString().split("T")[0];
    document.getElementById("oreLavorate").value = "8";
    document.getElementById("numeroCantieri").value = "1";
    document.getElementById("cantieriMultipli").innerHTML = "";
    document.getElementById("multiOperai").style.display = "none";
    document.getElementById("operaio").selectedIndex = -1;
    document.getElementById("nuovoOperaio").value = "";
    generaCampiCantieri();
    caricaUltimi7();
    caricaRiepilogoAdmin();
  }

  function invia() {
    /* tua funzione invia rimane identica */
  }

  function caricaUltimaLavorazione(username) {
    /* funzione rimane identica */
  }

  function caricaUltimi7() {
    /* funzione rimane identica */
  }

  function caricaRiepilogoAdmin() {
    /* funzione rimane identica */
  }

  window.addEventListener("DOMContentLoaded", () => {
    caricaSuggerimentiLavorazioni?.();
  });

  // aggiungo la funzione lingua
  const traduzioni = {
    it: {
      login: "ğŸ” Login",
      utente: "ğŸ”‘ Utente",
      password: "ğŸ”’ Password",
      accedi: "ğŸ”“ Accedi",
      compila: "ğŸ“… Compila Presenza",
      conferma: "âœ… Conferma",
      annulla: "âŒ Annulla",
      datiInseriti: "Dati inseriti correttamente",
      confermaTesto: "Vuoi confermare l'invio della presenza?"
    },
    en: {
      login: "ğŸ” Login",
      utente: "ğŸ”‘ User",
      password: "ğŸ”’ Password",
      accedi: "ğŸ”“ Login",
      compila: "ğŸ“… Submit Attendance",
      conferma: "âœ… Confirm",
      annulla: "âŒ Cancel",
      datiInseriti: "Data submitted successfully",
      confermaTesto: "Do you want to confirm the presence submission?"
    },
    fr: {
      login: "ğŸ” Connexion",
      utente: "ğŸ”‘ Utilisateur",
      password: "ğŸ”’ Mot de passe",
      accedi: "ğŸ”“ Se connecter",
      compila: "ğŸ“… Enregistrer la prÃ©sence",
      conferma: "âœ… Confirmer",
      annulla: "âŒ Annuler",
      datiInseriti: "DonnÃ©es enregistrÃ©es avec succÃ¨s",
      confermaTesto: "Voulez-vous confirmer l'envoi de la prÃ©sence?"
    }
  };

  function cambiaLingua(lang) {
    document.querySelector("#login h2").textContent = traduzioni[lang].login;
    document.getElementById("user").placeholder = traduzioni[lang].utente;
    document.getElementById("pass").placeholder = traduzioni[lang].password;
    document.querySelector("#login button").textContent = traduzioni[lang].accedi;
    document.querySelector("#form h3").textContent = traduzioni[lang].compila;
    document.getElementById("notifica").innerHTML = `<strong>${traduzioni[lang].datiInseriti}</strong>`;
    document.querySelector("#modalConferma p").textContent = traduzioni[lang].confermaTesto;
    document.querySelector("#modalConferma button:first-of-type").textContent = traduzioni[lang].conferma;
    document.querySelector("#modalConferma button:last-of-type").textContent = traduzioni[lang].annulla;
  }
</script>
</body>
</html>
