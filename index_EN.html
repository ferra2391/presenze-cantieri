<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Site Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --color-primary:hsl(210,100%,40%);
      --color-primary-dark:hsl(210,100%,30%);
      --color-accent:hsl(140,60%,40%);
      --color-accent-dark:hsl(140,60%,30%);
      --color-warning:hsl(40,90%,60%);
      --color-text-dark:hsl(210,10%,20%);
      --color-text-light:hsl(210,5%,50%);
      --color-bg-light:hsl(210,20%,98%);
      --color-bg-alt:hsl(210,10%,95%);
      --color-border:hsl(210,15%,85%);
      --color-success-bg:hsl(140,60%,95%);
      --color-success-border:hsl(140,60%,75%);
      --color-warning-bg:hsl(40,90%,95%);
      --color-warning-border:hsl(40,90%,80%);
      --border-radius-base:12px;
      --shadow-light:0 1px 3px rgba(0,0,0,.05);
      --shadow-medium:0 4px 8px rgba(0,0,0,.1);
      --shadow-strong:0 8px 16px rgba(0,0,0,.15);
    }
    body{font-family:'Roboto',sans-serif;background:var(--color-bg-light);color:var(--color-text-dark);padding:20px;margin:0;box-sizing:border-box}
    .container{max-width:860px;margin:0 auto;padding:0 10px}
    h2,h3{text-align:center;color:var(--color-primary-dark);margin-bottom:20px}

    input,select,textarea,button{width:100%;padding:14px;margin:10px 0;font-size:16px;border:1px solid var(--color-border);border-radius:10px;box-sizing:border-box;box-shadow:var(--shadow-light);min-height:48px}
    input:focus,select:focus,button:focus{outline:none;border-color:var(--color-primary);box-shadow:0 0 0 3px hsla(210,100%,40%,.2)}
    button{background:var(--color-primary);color:#fff;border:none;cursor:pointer;font-weight:bold;transition:background-color .3s ease,transform .2s ease,box-shadow .3s ease;box-shadow:var(--shadow-medium)}
    button:hover{background:var(--color-primary-dark);transform:translateY(-2px);box-shadow:var(--shadow-strong)}

    #form{margin-top:20px}
    #benvenuto{text-align:center;margin-bottom:20px;font-weight:bold;color:var(--color-text-dark);font-size:20px}
    #btnInvia{background:linear-gradient(to right,var(--color-accent),var(--color-accent-dark));font-size:18px;font-weight:bold;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.2)}
    #btnInvia:hover{background:linear-gradient(to right,var(--color-accent-dark),hsl(140,60%,25%));box-shadow:0 8px 16px rgba(0,0,0,.25)}
    .section-label{font-weight:bold;color:var(--color-text-dark);margin-top:15px;display:block;margin-bottom:5px}
    .card{background:#fff;padding:15px;border-radius:var(--border-radius-base);box-shadow:var(--shadow-medium);border:1px solid var(--color-border);margin-top:20px}

    /* recent works block */
    #importaBox{background:var(--color-success-bg);padding:16px;border-radius:10px;margin:10px 0;box-shadow:var(--shadow-light);border:1px solid var(--color-success-border)}
    #importaBox h4{margin:0 0 6px 0;color:var(--color-accent-dark);font-size:18px;font-weight:bold}
    #importaBox .sottotitolo{margin:0 0 12px 0;font-size:14px;color:var(--color-text-light)}

    #ultimaLavorazioneBox{background:#f0f7ff;padding:12px 15px;border:1px solid #cce0ff;border-radius:10px;margin:15px 0;display:flex;align-items:center;gap:10px;box-shadow:var(--shadow-light)}
    #ultimaLavorazioneBox p{margin:0;font-size:14px;color:var(--color-text-light)}
    #ultimaLavorazioneBox strong{font-size:16px;color:var(--color-primary-dark)}
    #btnGestione{background:var(--color-primary);border-radius:10px;font-weight:bold}

    /* snackbar */
    #notifica{display:none;position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(50px) scale(.9);opacity:0;background:var(--color-accent);color:#fff;padding:16px 30px;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,.3);font-size:18px;z-index:99999;transition:all .5s ease-out}
    #notifica.show{transform:translateX(-50%) translateY(0) scale(1);opacity:1}

    /* submission confirmation modal */
    #modalConferma{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:9999;justify-content:center;align-items:center}
    #modalConferma>div{background:#fff;max-width:400px;width:90%;margin:auto;padding:25px;border-radius:12px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.2);position:relative;transform:scale(.9);opacity:0;transition:all .3s ease-out;box-sizing:border-box}
    #modalConferma.show>div{transform:scale(1);opacity:1}
    #riepilogoDati{background:var(--color-bg-alt);padding:15px;border-radius:10px;border:1px solid var(--color-border);margin:15px 0;text-align:left;color:var(--color-text-dark);font-size:15px}
    #riepilogoDati ul{padding-left:15px;margin:0;list-style:none}
    #riepilogoDati li{margin-bottom:8px;line-height:1.4}
    #modalConferma button{padding:10px 25px;margin:0 8px;font-size:16px;border-radius:8px;box-shadow:var(--shadow-light)}
    #modalConferma button:first-of-type{background:var(--color-accent)}
    #modalConferma button:last-of-type{background:#ccc;color:var(--color-text-dark)}

    .warning-message{margin-bottom:10px;font-size:14px;color:var(--color-text-dark);background:var(--color-warning-bg);border-left:5px solid var(--color-warning-border);padding:12px;border-radius:10px}
    #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.3);z-index:998;display:none}

    textarea.lavorazione-autoresize{width:100%;font-size:16px;line-height:1.4;padding:12px;resize:none;overflow:hidden;min-height:44px;box-sizing:border-box;border:1px solid var(--color-border);border-radius:10px;background:#fff}
    .suggerimenti-box{position:absolute;background:#fff;border:1px solid var(--color-border);border-radius:10px;z-index:1000;max-height:200px;overflow-y:auto;font-size:16px;width:calc(100% - 30px);box-shadow:var(--shadow-medium);margin-top:4px}
    .suggerimenti-box div{padding:8px 12px;cursor:pointer}
    .suggerimenti-box div:hover{background:var(--color-bg-alt)}

    #ultimi7{display:none !important;}

    .agenda-list{display:flex;flex-direction:column;gap:12px}
    .agenda-day{display:flex;gap:12px;align-items:flex-start;padding:10px;background:#fff;border:1px solid var(--color-border);border-radius:12px}
    .date-badge{min-width:64px;text-align:center;background:var(--color-bg-alt);border:1px solid var(--color-border);border-radius:10px;padding:6px 8px}
    .date-badge .dow{font-size:12px;color:var(--color-text-light);font-weight:700}
    .date-badge .day{font-size:20px;font-weight:800}
    .date-badge.sabato,.date-badge.weekend,.date-badge.festivo{background:hsla(30,100%,50%,.12);border-color:hsla(30,100%,50%,.35)}
    .agenda-day.sabato,.agenda-day.weekend,.agenda-day.festivo{background:hsla(30,100%,50%,.07);border-color:hsla(30,100%,50%,.25)}

    .day-entries{flex:1;display:flex;flex-direction:column;gap:8px}
    .entry-card{display:flex;gap:10px;justify-content:space-between;align-items:flex-start;padding:12px;border:1px solid var(--color-border);border-radius:10px;background:#fff;cursor:pointer}
    .entry-card:hover{background:var(--color-bg-alt)}
    .entry-cant{font-weight:700;text-transform:uppercase;line-height:1.2}
    .entry-lav{font-style:italic;color:var(--color-text-light)}
    .entry-ore{border:1px solid var(--color-border);background:var(--color-bg-alt);border-radius:999px;padding:4px 10px;font-weight:700;white-space:nowrap}
    .agenda-empty{color:var(--color-text-light);text-align:center;padding:10px 0}
    .entry-missing{color:#c00000;font-weight:800;letter-spacing:.02em}
    #ultimaLavorazioneBox { display: none !important; }

    .label-row{display:flex;align-items:center;gap:10px}
    .label-row .section-label{margin:0}
    .btn-assente{
      margin-left:auto;
      width:auto; padding:10px 12px; min-height:auto;
      font-size:13px; line-height:1; border-radius:6px;
      background:#d32f2f; color:#fff; border:none; box-shadow:var(--shadow-medium); cursor:pointer;
    }
    .btn-assente:hover{ background:#b71c1c; transform:translateY(-1px); }

    /* time-row for morning/afternoon */
    .time-row{display:flex;align-items:center;gap:8px}
    .time-row select{flex:1;min-width:0}
    .time-sep{user-select:none}



/* --- TIME CARDS (morning/afternoon) --- */
.time-card{
  background: linear-gradient(180deg, #fff, hsla(210,100%,50%,0.06));
  border: 1px solid var(--color-border);
  border-radius: 18px;
  padding: 14px 14px 12px;
  box-shadow: var(--shadow-light);
}

.time-card .section-label{
  display:block;
  text-align:center;
  margin:0 0 8px 0;
  font-weight:800;
  color: var(--color-primary-dark);
  letter-spacing:.02em;
}

.time-card .time-row{
  display:flex;
  align-items:center;
  justify-content:center;  /* center the time fields */
  gap:8px;
}

.time-card .time-row select{
  flex:0 1 46%;            /* two selects side-by-side */
  min-width:0;
}

.time-card .time-sep{ user-select:none; }

.time-card small{
  display:block;
  text-align:center;      /* centered description */
  margin-top:6px;
  color: var(--color-text-light);
}
/* responsive two-column grid (stacks on mobile) */
.grid-coppia{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap:15px;
  margin-top:5px;
}


    /* iOS Safari: normalize DATE field inside time-cards */
.time-card { overflow: hidden; } /* prevents any borders/shadows from overflowing */

.time-card input[type="date"]{
  -webkit-appearance: none; /* disable iOS "capsule" style */
  appearance: none;
  background: #fff;
  border: 1px solid var(--color-border);
  border-radius: 10px;
  padding: 10px 12px;
  min-height: 44px;
  line-height: 1.2;
  width: 100%;
  margin: 6px 0;          /* slightly smaller margin */
  box-shadow: var(--shadow-light);
}

/* refinements for value and calendar icon in WebKit */
.time-card input[type="date"]::-webkit-date-and-time-value{ 
  text-align: left;
  min-height: 1.2em;
}
.time-card input[type="date"]::-webkit-calendar-picker-indicator{
  padding: 0;
  margin: 0 2px 0 6px;
}

  </style>
</head>
<body>
  <div class="container">
    <datalist id="suggerimentiLavorazioni"></datalist>

    <div id="notifica"><strong>Data entered successfully</strong></div>

    <div id="benvenuto"><div id="messaggioBenvenuto"></div></div>

    <div id="login" class="card">
<div style="display:flex;justify-content:center;gap:20px;margin-bottom:15px;">
  <a href="https://ferra2391.github.io/presenze-cantieri/index_EN.html"><img src="images/EN.png" alt="English" style="width:50px;height:auto"></a>
  <a href="https://ferra2391.github.io/presenze-cantieri/"><img src="images/IT.png" alt="Italian" style="width:50px;height:auto"></a>
  <a href="https://ferra2391.github.io/presenze-cantieri/index_FR.html"><img src="images/FR.png" alt="French" style="width:50px;height:auto"></a>
</div>


      <h2>üîê Login</h2>
      <input type="text" id="user" placeholder="üîë User">
      <input type="password" id="pass" placeholder="üîí Password">
      <button onclick="login()">üîì Log In</button>
    </div>

    <div id="form" style="display:none;">
<h3>üìÖ Fill Attendance</h3>

<div class="grid-coppia">
  <div class="time-card">
    <label class="section-label" for="data">üìÖ Date</label>
    <input type="date" id="data">
  </div>

  <div class="time-card">
    <label class="section-label" for="numeroCantieri">üèóÔ∏è Sites</label>
    <select id="numeroCantieri" onchange="generaCampiCantieri()">
      <option value="1" selected>1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>
  </div>
</div>

<div class="grid-coppia">
  <div class="time-card">
    <label class="section-label" for="mStart">‚òÄÔ∏è Morning Hours</label>
    <div class="time-row">
      <select id="mStart"></select>
      <span class="time-sep">‚Äì</span>
      <select id="mEnd"></select>
    </div>
    <small>Morning slot</small>
  </div>

  <div class="time-card">
    <label class="section-label" for="pStart">üåá Afternoon Hours</label>
    <div class="time-row">
      <select id="pStart"></select>
      <span class="time-sep">‚Äì</span>
      <select id="pEnd"></select>
    </div>
    <small>Afternoon slot</small>
  </div>
</div>


      <div id="cantieriMultipli"></div>

      <button id="btnMultiOperai" onclick="mostraOperai()">üëèüèº‚Äã Enter data for other workers</button>

      <div id="multiOperai" class="card" style="display:none;margin-top:20px;">
        <p class="warning-message">‚ö†Ô∏è The same work details indicated above will be applied to the selected workers.</p>
        <label class="section-label" for="operaio">üë• Select other workers:</label>
        <select id="operaio" multiple size="6" onchange="gestisciMoltiplicatori()"></select>
        <div id="contenitoreMoltiplicatori" style="margin-top:15px;"></div>
        <div style="margin-top:15px;">
          <label class="section-label" for="nuovoOperaio">‚ûï Or add a new worker:</label>
          <input type="text" id="nuovoOperaio" placeholder="üë∑ Add new worker">
        </div>
      </div>

      <label class="section-label" for="note">üìù Optional NOTES:</label>
      <textarea id="note" class="lavorazione-autoresize" placeholder="Add times and notes..." rows="1" oninput="autoResize(this)"></textarea>

      <button onclick="mostraModal()" id="btnInvia">üìÑ Submit Attendance</button>
      <button id="btnGestione" onclick="window.location.href='gestione.html'">üìÖ Go to Site Management</button>

      <div id="ultimaLavorazioneBox">
        <span style="font-size:24px;color:var(--color-primary)">‚ú®</span>
        <div><p>Your last recorded work activity:</p><strong id="ultimaLavorazione">Loading...</strong></div>
      </div>

      <div id="ultimi7" class="card"><h4>Recently:</h4></div>

      <div id="agendaView" class="card" style="margin-top:16px;">
        <h4 id="agendaTitolo">Attendance (...)</h4>
        <div id="agendaList" class="agenda-list"></div>
      </div>

      <div id="overlay"></div>

      <div id="modalePresenza" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:1em;border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,.2);z-index:999;width:90%;max-width:400px">
        <h3>Edit Attendance</h3>
        <form id="formModifica">
          <input type="hidden" id="mod_id">
          <label>Date: <input type="date" id="mod_data"></label><br><br>
          <label>Times: <input type="text" id="mod_orari"></label><br><br>
          <label>Site: <input type="text" id="mod_cantiere"></label><br><br>
          <label>Work Activity: <input type="text" id="mod_lavorazione"></label><br><br>
          <label>Hours: <input type="number" id="mod_ore"></label><br><br>
          <label>Notes: <textarea id="mod_note" rows="3"></textarea></label><br><br>
          <button type="button" onclick="inviaModifica()">üíæ Save</button>
          <button type="button" onclick="chiudiModale()">‚ùå Cancel</button>
        </form>
      </div>

      <div id="riepilogoAdmin" class="card" style="display:none;">
        <h3>üìù Today's Attendance Summary</h3>
        <div id="riepilogoCompilati" style="margin-bottom:20px;"></div>
        <div id="riepilogoMancanti"></div>
      </div>
    </div>
  </div>

  <div id="modalConferma">
    <div>
      <p>Do you want to confirm the attendance submission?</p>
      <div id="riepilogoDati"></div>
      <button onclick="confermaInvio()">‚úÖ Confirm</button>
      <button onclick="chiudiModal()">‚ùå Cancel</button>
    </div>
  </div>

  <script>
    let utente="", nomeOperaio="", elencoCantieri=[], ruoliUtenti={}, ultimoTestoLavorazione="";
    let payloadAssente = null;

    function isAdmin(){ return (localStorage.getItem("ruolo") || "").toLowerCase() === "amministratore"; }

    function login(){
      const userInput=document.getElementById("user").value.trim();
      const passInput=document.getElementById("pass").value.trim();

      fetch("https://opensheet.elk.sh/1glvkWLOpUhdBUmY4j-2DJoXQvY6dnQD_OQkYYCaXXEQ/Utenti")
        .then(r=>r.json())
        .then(data=>{
          const u=data.find(r=>r["User"]===userInput && r["Password"]===passInput);
          if(!u){alert("Incorrect credentials");return;}
          utente=u["User"]; nomeOperaio=u["Nome"];
          const ruolo=u["Ruolo"]||"";
          localStorage.setItem("ruolo",ruolo);
          document.getElementById("btnMultiOperai").style.display = isAdmin() ? "inline-block" : "none";

          document.getElementById("messaggioBenvenuto").innerText=`Welcome, ${nomeOperaio}`;
          if(ruolo.toLowerCase()!=="amministratore") document.getElementById("btnGestione").style.display="none";
          document.getElementById("login").style.display="none";
          document.getElementById("form").style.display="block";
          document.getElementById("data").value=new Date().toISOString().split("T")[0];

          populateTimeSelects();        // ‚è∞ initialize time menus
          caricaCantieri();
          caricaOperai();
          caricaRiepilogoAdmin();
          generaCampiCantieri();
          caricaAgendaMensile();
        });
    }

    /* ========== TIME HELPERS ========== */
    function pad2(n){return String(n).padStart(2,'0');}
    function minutesToHHMM(min){const h=Math.floor(min/60), m=min%60; return `${pad2(h)}:${pad2(m)}`;}
    function HHMMtoMinutes(str){
      if(!str||!str.includes(":")) return null;
      const [h,m]=str.split(":").map(n=>parseInt(n,10));
      if(Number.isNaN(h)||Number.isNaN(m)) return null;
      return h*60+m;
    }

    function buildOptionsHTML(minMin, maxMin, stepMin, kind){
      // kind: 'start' => last option is max-step; 'end' => first option is min+step
      const adjMin = (kind==='end') ? (minMin + stepMin) : minMin;
      const adjMax = (kind==='start') ? (maxMin - stepMin) : maxMin;
      let html = `<option value="">‚Äî</option>`;
      for(let t=adjMin; t<=adjMax; t+=stepMin){
        const v=minutesToHHMM(t);
        html += `<option value="${v}">${v}</option>`;
      }
      return html;
    }

    function populateTimeSelects(){
      const mStart=document.getElementById("mStart");
      const mEnd=document.getElementById("mEnd");
      const pStart=document.getElementById("pStart");
      const pEnd=document.getElementById("pEnd");
      if(!mStart||!mEnd||!pStart||!pEnd) return;

      const STEP=30;
      const M_MIN=6*60, M_MAX=15*60;
      const P_MIN=12*60, P_MAX=20*60;

      mStart.innerHTML = buildOptionsHTML(M_MIN, M_MAX, STEP, 'start');
      mEnd.innerHTML   = buildOptionsHTML(M_MIN, M_MAX, STEP, 'end');
      pStart.innerHTML = buildOptionsHTML(P_MIN, P_MAX, STEP, 'start');
      pEnd.innerHTML   = buildOptionsHTML(P_MIN, P_MAX, STEP, 'end');
    }

    function getSelectedIntervals(){
      const ms = HHMMtoMinutes(document.getElementById("mStart").value);
      const me = HHMMtoMinutes(document.getElementById("mEnd").value);
      const ps = HHMMtoMinutes(document.getElementById("pStart").value);
      const pe = HHMMtoMinutes(document.getElementById("pEnd").value);
      return {ms, me, ps, pe};
    }

    function validateIntervals(ms,me,ps,pe){
      const anyMorning = (ms!==null || me!==null);
      const anyAfternoon = (ps!==null || pe!==null);
      if(!anyMorning && !anyAfternoon){
        alert("Please enter at least one time slot (morning or afternoon).");
        return false;
      }
      if(anyMorning && (ms===null || me===null)){
        alert("Please complete the morning slot (start and end).");
        return false;
      }
      if(anyMorning && ms>=me){
        alert("Invalid morning slot: the end time must be after the start time.");
        return false;
      }
      if(anyAfternoon && (ps===null || pe===null)){
        alert("Please complete the afternoon slot (start and end).");
        return false;
      }
      if(anyAfternoon && ps>=pe){
        alert("Invalid afternoon slot: the end time must be after the start time.");
        return false;
      }
      return true;
    }

    function buildOrariString(ms,me,ps,pe){
      const parts=[];
      if(ms!==null && me!==null) parts.push(`${minutesToHHMM(ms)}-${minutesToHHMM(me)}`);
      if(ps!==null && pe!==null) parts.push(`${minutesToHHMM(ps)}-${minutesToHHMM(pe)}`);
      return parts.join(" + ");
    }

    function computeTotalHours(ms,me,ps,pe){
      let minutes=0;
      if(ms!==null && me!==null && me>ms) minutes += (me - ms);
      if(ps!==null && pe!==null && pe>ps) minutes += (pe - ps);
      return minutes/60; // decimal hours
    }

    /* ========== LOADING LISTS ========== */
    function caricaCantieri(){
      fetch("https://opensheet.elk.sh/1glvkWLOpUhdBUmY4j-2DJoXQvY6dnQD_OQkYYCaXXEQ/Cantieri")
        .then(r=>r.json())
        .then(data=>{
          elencoCantieri=data.filter(r=>r["Cantiere"]).map(r=>r["Cantiere"]);
          generaCampiCantieri();
        });
    }

    function caricaOperai(){
      fetch("https://opensheet.elk.sh/1glvkWLOpUhdBUmY4j-2DJoXQvY6dnQD_OQkYYCaXXEQ/Utenti")
        .then(r=>r.json())
        .then(data=>{
          const select=document.getElementById("operaio");
          select.innerHTML=""; ruoliUtenti={};
          data.forEach(r=>{
            if(r["Nome"]){
              const opt=document.createElement("option");
              opt.value=r["Nome"]; opt.textContent=r["Nome"]; select.appendChild(opt);
              ruoliUtenti[r["Nome"]]=r["Ruolo"]?.toUpperCase()||"OPERAIO";
            }
          });
        });
    }

    function mostraCantiereLibero(i){
      const div=document.getElementById(`cantiereLibero_${i}`);
      div.style.display=(div.style.display==="block")?"none":"block";
    }

    function generaCampiCantieri(){
      const n=parseInt(document.getElementById("numeroCantieri").value);
      const container=document.getElementById("cantieriMultipli");
      container.innerHTML="";
      for(let i=1;i<=n;i++){
        let sel=`<select id="cantiere_${i}"><option value="">-- Select Site --</option>`;
        elencoCantieri.forEach(nome=>sel+=`<option value="${nome}">${nome}</option>`); sel+=`</select>`;

        const btnAssente = (i === 1 && isAdmin())
          ? `<button type="button" class="btn-assente" onclick="apriAssente()" title="Register absence for the selected date">üö´ ABSENT</button>`
          : ``;

        container.innerHTML+=`
          <div class="card" style="margin-top:15px;padding:15px;position:relative;">
            <div class="label-row">
              <label class="section-label" for="cantiere_${i}">üèóÔ∏è Site ${i}:</label>
              ${btnAssente}
            </div>
            ${sel}
            <button type="button" onclick="mostraCantiereLibero(${i})" id="btnCantiereAltro">üè† Click HERE if the site is not listed</button>
            <div id="cantiereLibero_${i}" style="display:none;">
              <input type="text" id="cantiereAltro_${i}" placeholder="üè¢ Enter site name ${i}">
            </div>
            <div id="importaBox">
              <h4>üíÖ‚Äã Work activities for site ${i}</h4>
              <p class="sottotitolo">üí° Choose from recent activities or write a new one:</p>
              <textarea id="lavorazione_${i}" class="lavorazione-autoresize" placeholder="üß†‚Äã Work activities and suggestions" rows="1" oninput="autoResize(this); mostraSuggerimenti(this)" autocomplete="off"></textarea>
              <div class="suggerimenti-box" id="suggerimentiBox_${i}" style="display:none;"></div>
            </div>
          </div>`;
      }
      const btn = document.getElementById("btnMultiOperai");
      btn.style.display = (n === 1 && isAdmin()) ? "inline-block" : "none";
    }

    function mostraOperai(){const div=document.getElementById("multiOperai");div.style.display=(div.style.display==="block")?"none":"block";}

    /* === sequential submission === */
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    async function invia(){
      const {ms,me,ps,pe} = getSelectedIntervals();
      if(!validateIntervals(ms,me,ps,pe)) return;

      const orari = buildOrariString(ms,me,ps,pe);              // string for column B
      const oreTot = computeTotalHours(ms,me,ps,pe);            // total decimal hours
      const nCant = parseInt(document.getElementById("numeroCantieri").value);
      const orePerCantiere = oreTot / nCant;

      const data=document.getElementById("data").value;
      const note=document.getElementById("note").value.trim();

      const rowsToSend = [];

      for(let i=1;i<=nCant;i++){
        let nomeCantiere=document.getElementById(`cantiere_${i}`)?.value||"";
        const altro=document.getElementById(`cantiereAltro_${i}`)?.value.trim()||"";
        if(altro) nomeCantiere=altro;
        const lavorazione=document.getElementById(`lavorazione_${i}`)?.value||"";
        if(!nomeCantiere||!lavorazione){alert(`‚ö†Ô∏è You must fill in the site and work activity for row ${i}`);return;}

        let operai=[];
        if(document.getElementById("multiOperai").style.display==="block"){
          operai=Array.from(document.getElementById("operaio").selectedOptions).map(o=>o.value);
          const nuovo=document.getElementById("nuovoOperaio").value.trim(); if(nuovo) operai.push(nuovo);
          if(operai.length===0) operai=[nomeOperaio];
        }else{ operai=[nomeOperaio]; }

        operai.forEach(nome=>{
          const molId="moltiplicatore_"+(nome||"").trim().replace(/\s+/g,"_");
          const raw = document.getElementById(molId)?.value;
          const mol = Math.max(1, Number.parseInt(raw, 10) || 1);
          for(let k=0;k<mol;k++){
            rowsToSend.push({
              data,
              orari,                        // <-- written in column B by GAS
              cantiere:nomeCantiere,
              lavorazione,
              ore: Number(orePerCantiere.toFixed(2)), // equally divided among sites
              operaio:nome,
              user:utente,
              note
            });
          }
        });
      }

      for(const body of rowsToSend){
        try{
          await fetch("https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec",{
            method:"POST",mode:"no-cors",body:JSON.stringify(body),headers:{"Content-Type":"application/json"}
          });
        }catch(_){}
        await sleep(120 + Math.random()*120);
      }
    }

    function caricaUltimaLavorazione(username){
      fetch(`https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec?getLastWork=1&username=${username}`)
        .then(r=>r.text())
        .then(txt=>{
          const el=document.getElementById("ultimaLavorazione");
          if(txt && txt.trim()!==""){el.textContent=txt; ultimoTestoLavorazione=txt;}
          else {el.textContent="(No work activity found)"; ultimoTestoLavorazione="";}
        });
    }

    function mostraModal(){
      const {ms,me,ps,pe} = getSelectedIntervals();
      if(!validateIntervals(ms,me,ps,pe)) return;

      const data=document.getElementById("data").value;
      let operai="";
      if(document.getElementById("multiOperai").style.display==="block"){
        const selezione=document.getElementById("operaio");
        const s=Array.from(selezione.selectedOptions).map(o=>o.value);
        const nuovo=document.getElementById("nuovoOperaio").value.trim(); if(nuovo) s.push(nuovo);
        operai=s.length>0?s.join(", "):nomeOperaio;
      }else{ operai=nomeOperaio; }

      const n=parseInt(document.getElementById("numeroCantieri").value);
      let dettagli="";
      for(let i=1;i<=n;i++){
        let cant=document.getElementById(`cantiere_${i}`)?.value||"(none)";
        const altro=document.getElementById(`cantiereAltro_${i}`)?.value.trim()||"";
        if(altro) cant=altro;
        const lav=document.getElementById(`lavorazione_${i}`)?.value||"(none)";
        dettagli+=`<li><strong>Site ${i}:</strong> ${cant}<br><strong>Work Activity:</strong> ${lav}</li>`;
      }

      const orariStr = buildOrariString(ms,me,ps,pe);
      const oreTot = computeTotalHours(ms,me,ps,pe);

      document.getElementById("riepilogoDati").innerHTML=
        `<ul>
          <li><strong>Date:</strong> ${data}</li>
          <li><strong>Workers:</strong> ${operai}</li>
          <li><strong>Total hours:</strong> ${oreTot.toFixed(2)}</li>
          <li><strong>Times:</strong> ${orariStr}</li>
          <li><strong>Site Details:</strong>
            <ul>${dettagli}</ul>
          </li>
        </ul>`;

      document.getElementById("modalConferma").style.display="flex";
      document.getElementById("modalConferma").classList.add("show");
    }
    function chiudiModal(){document.getElementById("modalConferma").classList.remove("show");setTimeout(()=>{document.getElementById("modalConferma").style.display="none";},300);}

    /* ===== ABSENT ===== */
    function apriAssente(){
      if(!isAdmin()){ alert("This function is for administrators only."); return; }
      const data = document.getElementById("data").value;
      if(!data){ alert("Please select a date first."); return; }

      let target = [];
      if(document.getElementById("multiOperai").style.display==="block"){
        target = Array.from(document.getElementById("operaio").selectedOptions).map(o=>o.value);
        const nuovo = document.getElementById("nuovoOperaio").value.trim();
        if(nuovo) target.push(nuovo);
      }
      if(target.length===0) target=[nomeOperaio];

      const note = document.getElementById("note").value.trim();
      payloadAssente = target.map(op => ({
        data, orari:"-",
        cantiere:"ABSENT",
        lavorazione:"ABSENT",
        ore:0,
        operaio:op,
        user:utente,
        note
      }));

      document.getElementById("riepilogoDati").innerHTML = `
        <ul>
          <li><strong>Date:</strong> ${data}</li>
          <li><strong>Type:</strong> <span style="color:#b71c1c;font-weight:700;">ABSENT</span></li>
          <li><strong>Absent:</strong> ${target.join(", ")}</li>
          <li><strong>Hours:</strong> 0</li>
        </ul>
      `;
      document.getElementById("modalConferma").style.display="flex";
      document.getElementById("modalConferma").classList.add("show");
    }

    function confermaInvio(){
      chiudiModal();

      if(payloadAssente){
        (async () => {
          for(const row of payloadAssente){
            try{
              await fetch("https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec",{
                method:"POST", mode:"no-cors",
                body: JSON.stringify(row),
                headers: {"Content-Type":"application/json"}
              });
            }catch(_){}
            await sleep(120 + Math.random()*120);
          }
        })();
        payloadAssente = null;
      } else {
        invia(); // async fire-and-forget
      }

      const n=document.getElementById("notifica");
      n.style.display="block"; n.classList.add("show");
      setTimeout(()=>{n.classList.remove("show"); setTimeout(()=>{n.style.display="none";},500);},3500);

      // reset fields
      document.getElementById("data").value=new Date().toISOString().split("T")[0];
      document.getElementById("numeroCantieri").value="1";
      document.getElementById("cantieriMultipli").innerHTML="";
      document.getElementById("multiOperai").style.display="none";
      document.getElementById("operaio").selectedIndex=-1;
      document.getElementById("nuovoOperaio").value="";
      document.getElementById("note").value="";
      // reset times
      if(document.getElementById("mStart")) document.getElementById("mStart").value="";
      if(document.getElementById("mEnd")) document.getElementById("mEnd").value="";
      if(document.getElementById("pStart")) document.getElementById("pStart").value="";
      if(document.getElementById("pEnd")) document.getElementById("pEnd").value="";

      generaCampiCantieri();
      caricaRiepilogoAdmin();
      setTimeout(caricaAgendaMensile,1200);
    }

    function caricaRiepilogoAdmin(){
      const ruolo=localStorage.getItem("ruolo");
      if(ruolo && ruolo.toLowerCase()==="amministratore"){
        const box=document.getElementById("riepilogoAdmin");
        if(!box) return;
        box.style.display="block";
        const oggiISO=new Date().toISOString().split("T")[0];
        fetch("https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec?riepilogo=1&data="+oggiISO)
          .then(r=>r.json())
          .then(dati=>{
            const compilati=dati.compilati||[], mancanti=dati.mancanti||[];
            document.getElementById("riepilogoCompilati").innerHTML=`<h4>Submitted:</h4><ul>${compilati.map(op=>`<li>${op.nome} (${op.cantiere} - ${op.lavorazione})</li>`).join("")}</ul>`;
            document.getElementById("riepilogoMancanti").innerHTML=`<h4>Missing:</h4><ul>${mancanti.map(op=>`<li>${op}</li>`).join("")}</ul>`;
          });
      }
    }

    function autoResize(t){t.style.height="auto";t.style.height=t.scrollHeight+"px";}

    function mostraSuggerimenti(el){
      const index=el.id.split("_")[1];
      const box=document.getElementById("suggerimentiBox_"+index);
      const testo=el.value.toLowerCase();
      const s=window.lavorazioniRecenti||[];
      if(!testo||s.length===0){box.style.display="none";return;}
      const f=s.filter(x=>x.toLowerCase().includes(testo)).slice(0,10);
      if(f.length===0){box.style.display="none";return;}
      box.innerHTML="";
      f.forEach(val=>{
        const div=document.createElement("div");
        div.textContent=val; div.onclick=()=>{el.value=val; autoResize(el); box.style.display="none";};
        box.appendChild(div);
      });
      box.style.display="block";
    }

    function gestisciMoltiplicatori(){
      const c=document.getElementById("contenitoreMoltiplicatori"); c.innerHTML="";
      const selez=Array.from(document.getElementById("operaio").selectedOptions).map(o=>o.value);
      selez.forEach(nome=>{
        if(ruoliUtenti[nome]==="SUB"){
          const id="moltiplicatore_"+nome.replace(/\s+/g,"_");
          const b=document.createElement("div");
          b.style.marginBottom="10px";
          b.innerHTML=`<label style="font-weight:bold;">${nome} ‚Äì How many people to count for this company?</label>
                         <input type="number" id="${id}" value="1" min="1" max="10" style="width:80px;margin-left:10px" />`;
          c.appendChild(b);
        }
      });
    }

    /* ====== Monthly Agenda ====== */
    function enMonthName(d){ return d.toLocaleString('en-US',{month:'long'}); }
    function calcEaster(Y){const a=Y%19,b=Math.floor(Y/100),c=Y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,L=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*L)/451),month=Math.floor((h+L-7*m+114)/31),day=((h+L-7*m+114)%31)+1;return new Date(Y,month-1,day);}
    function italianHolidays(year){
      const set=new Set(),add=(m,d)=>set.add(`${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`);
      add(1,1);add(1,6);add(4,25);add(5,1);add(6,2);add(8,15);add(11,1);add(12,8);add(12,25);add(12,26);
      const p=calcEaster(year), q=new Date(p); q.setDate(p.getDate()+1);
      add(p.getMonth()+1,p.getDate()); add(q.getMonth()+1,q.getDate());
      return set;
    }

    function caricaAgendaMensile(){
      if(!utente) return;
      const oggi=new Date(); const y=oggi.getFullYear(), m=oggi.getMonth()+1;
      const titolo=document.getElementById('agendaTitolo');
      if(titolo) titolo.textContent = `Attendance (${enMonthName(oggi)} ${y})`;

      const url=`https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec?presenzeMese=1&username=${encodeURIComponent(utente)}&opName=${encodeURIComponent(nomeOperaio)}&year=${y}&month=${String(m).padStart(2,'0')}`;
      fetch(url).then(r=>r.json()).then(json=>{
        renderAgenda(json.presenze||[], y, m);
      }).catch(_=>renderAgenda([], y, m));
    }

    function renderAgenda(presenze, y, m){
      const list=document.getElementById('agendaList'); if(!list) return;
      list.innerHTML='';
      const holidays=italianHolidays(y);

      const byDay={};
      presenze.forEach(p=>{
        const iso=p.dataISO||p.data||p.data_iso; if(!iso) return;
        const d=+String(iso).split('-')[2]; (byDay[d] ||= []).push(p);
      });
      Object.values(byDay).forEach(arr=>arr.sort((a,b)=> (a.id||0)-(b.id||0)));

      const daysInMonth = new Date(y, m, 0).getDate();
      const today = new Date(); today.setHours(0,0,0,0);
      const isCurrentMonth = (today.getFullYear()===y && (today.getMonth()+1)===m);
      const dowLbl=['M','T','W','T','F','S','S'];

      for(let d=1; d<=daysInMonth; d++){
        const dateObj = new Date(y, m-1, d); dateObj.setHours(0,0,0,0);
        const dow = (dateObj.getDay()+6)%7;
        const iso = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const entries = byDay[d] || [];

        const dayRow=document.createElement('div'); dayRow.className='agenda-day';
        const badge=document.createElement('div'); badge.className='date-badge';
        if(dow===5) badge.classList.add('sabato');
        if(dow===6) badge.classList.add('weekend');
        if(holidays.has(iso)) badge.classList.add('festivo');
        if(dow===5) dayRow.classList.add('sabato');
        if(dow===6) dayRow.classList.add('weekend');
        if(holidays.has(iso)) dayRow.classList.add('festivo');

        badge.innerHTML=`<div class="dow">${dowLbl[dow]}</div><div class="day">${String(d).padStart(2,'0')}</div>`;
        dayRow.appendChild(badge);

        const entriesWrap=document.createElement('div'); entriesWrap.className='day-entries';

        if(entries.length===0){
          if(isCurrentMonth && dateObj < today){
            const miss=document.createElement('div');
            miss.className='entry-missing';
            miss.textContent='NOT FILLED';
            entriesWrap.appendChild(miss);
          }
        } else {
          entries.forEach(r=>{
            const card=document.createElement('div'); card.className='entry-card';
            card.setAttribute('title',(r.ore?`${r.ore}h ‚Äì `:'')+(r.cantiere||'')); 
            card.addEventListener('click',()=>{ if(r.id) apriModifica(String(r.id)); });

            const left=document.createElement('div'); left.style.flex='1';
            left.innerHTML=`<div class="entry-cant">${(r.cantiere||'').toString().toUpperCase()}</div>
                              <div class="entry-lav">${r.lavorazione||''}</div>`;

            const ore=document.createElement('div'); ore.className='entry-ore';
            ore.textContent = r.ore ? (r.ore+' h') : '';

            card.appendChild(left); card.appendChild(ore);
            entriesWrap.appendChild(card);
          });
        }

        dayRow.appendChild(entriesWrap);
        list.appendChild(dayRow);
      }

      if(presenze.length===0){
        const info=document.createElement('div');
        info.className='agenda-empty';
        info.textContent='No attendance recorded for this month.';
        list.appendChild(info);
      }
    }

    window.addEventListener("DOMContentLoaded",()=>{
      fetch("https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec?lavorazioniRecenti=1")
        .then(r=>r.json()).then(data=>{window.lavorazioniRecenti=data||[];});
    });

    function apriModifica(id){
      fetch(`https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec?getPresenza=1&id=${id}`)
        .then(res=>res.json())
        .then(dati=>{
          document.getElementById("mod_id").value=dati.id;
          document.getElementById("mod_data").value=(typeof dati.data==='string'? dati.data.split("T")[0] : new Date(dati.data).toISOString().split('T')[0]);
          document.getElementById("mod_orari").value=dati.orari||"";
          document.getElementById("mod_cantiere").value=dati.cantiere||"";
          document.getElementById("mod_lavorazione").value=dati.lavorazione||"";
          document.getElementById("mod_ore").value=dati.ore||"";
          document.getElementById("mod_note").value=dati.note||"";
          document.getElementById("overlay").style.display="block";
          document.getElementById("modalePresenza").style.display="block";
        });
    }
    function chiudiModale(){document.getElementById("overlay").style.display="none";document.getElementById("modalePresenza").style.display="none";}
    function inviaModifica(){
      const dati={
        modifica:1,
        id:document.getElementById("mod_id").value,
        data:document.getElementById("mod_data").value,
        orari:document.getElementById("mod_orari").value,
        cantiere:document.getElementById("mod_cantiere").value,
        lavorazione:document.getElementById("mod_lavorazione").value,
        ore:document.getElementById("mod_ore").value,
        note:document.getElementById("mod_note").value
      };
      fetch("https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec",{method:"POST",body:JSON.stringify(dati)})
        .then(res=>res.text())
        .then(_=>{
          alert("Changes saved!");
          chiudiModale();
          setTimeout(caricaAgendaMensile,500);
        });
    }
  </script>
</body>
</html>
