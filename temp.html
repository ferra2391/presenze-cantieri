<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Gestione Presenze - Dashboard Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary: hsl(210,100%,45%);
      --primary-dark: hsl(210,100%,35%);
      --text: hsl(210,15%,15%);
      --text-light: hsl(210,10%,40%);
      --muted: hsl(210,8%,50%);
      --bg: hsl(210,25%,96%);
      --card: #ffffff;
      --border: hsl(210,20%,88%);
      --border-strong: hsl(210,20%,75%);
      --orange-weak: hsla(30,100%,50%,0.12);
      --orange-border: hsla(30,100%,50%,0.3);
      --success: hsl(140,70%,40%);
      --error: hsl(0,70%,50%);
      --hover-bg: hsl(210,30%,98%);
      --danger: #c00000;
      --overlay: rgba(0,0,0,.5);

      /* tabella */
      --col-w: 270px;
      --col-op: 210px;
      --day-h: 120px;

      --fs-day: 22px;
      --fs-cantiere: 24px;
      --fs-ore: 23px;
      --fs-tot: 22px;
      --fs-note: 18px;
      --fs-lav: 18px;
    }

    * { box-sizing: border-box; }
    
    html, body { height: 100%; }
    
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 16px/1.6 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 32px 40px;
    }
    
    h1 {
      margin: 0 0 24px;
      font-size: 32px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.5px;
    }

    /* CONTROL PANEL */
    .control-panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,.06);
      margin-bottom: 28px;
    }
    
    .control-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .control-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .nav {
      display: flex;
      gap: 10px;
    }
    
    .nav a {
      padding: 10px 18px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      text-decoration: none;
      font-weight: 600;
      font-size: 15px;
      color: var(--text);
      transition: all 0.2s;
    }
    
    .nav a:hover {
      border-color: var(--primary);
      background: var(--hover-bg);
    }
    
    .nav a.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .nav a.primary:hover {
      background: var(--primary-dark);
    }
    
    input[type="month"] {
      padding: 10px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      font-size: 15px;
      font-weight: 500;
      min-width: 160px;
      transition: border-color 0.2s;
    }
    
    input[type="month"]:focus {
      outline: none;
      border-color: var(--primary);
    }

    select {
      padding: 10px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      font-size: 15px;
      font-weight: 500;
      transition: border-color 0.2s;
    }

    select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    button {
      padding: 10px 18px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.2s;
      color: var(--text);
    }
    
    button:hover:not(:disabled) {
      border-color: var(--primary);
      background: var(--hover-bg);
    }
    
    button.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    button.primary:hover:not(:disabled) {
      background: var(--primary-dark);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .month-btn {
      width: 42px;
      height: 42px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .spinner {
      display: none;
    }
    
    .spinner.show {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ddd;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: -4px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    #status {
      margin-top: 12px;
      font-size: 15px;
    }
    
    .ok {
      color: var(--success);
      font-weight: 600;
    }
    
    .error {
      color: var(--error);
      font-weight: 600;
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-light);
      font-size: 14px;
      font-weight: 600;
    }

    .pill {
      display: inline-block;
      height: 14px;
      width: 24px;
      border-radius: 4px;
      background: var(--orange-weak);
      border: 1px solid var(--orange-border);
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .hidden { display: none !important; }

    /* TABLE CARDS */
    .matrix-stack {
      display: flex;
      flex-direction: column;
      gap: 28px;
    }

    .table-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,.06);
      overflow: hidden;
    }
    
    .table-title {
      padding: 20px 24px;
      border-bottom: 2px solid var(--border);
      font-weight: 700;
      font-size: 20px;
      color: var(--text);
      background: linear-gradient(to bottom, var(--card), var(--hover-bg));
    }
    
    .table-wrap {
      position: relative;
      overflow-x: auto;
      overflow-y: visible;
      max-width: 100%;
    }
    
    .matrix {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
      table-layout: auto;
    }
    
    .matrix thead th {
      position: sticky;
      top: 0;
      z-index: 4;
      background: var(--card);
      color: var(--text);
      font-weight: 700;
      font-size: var(--fs-day);
      text-align: center;
      padding: 18px 10px;
      border-bottom: 2px solid var(--border-strong);
      border-right: 1px solid var(--border);
      white-space: nowrap;
    }
    
    .matrix tbody th {
      position: sticky;
      left: 0;
      z-index: 3;
      background: var(--card);
      color: var(--text);
      font-weight: 600;
      font-size: 16px;
      text-align: left;
      padding: 18px 20px;
      border-right: 2px solid var(--border-strong);
      border-bottom: 1px solid var(--border);
      width: var(--col-op);
      min-width: var(--col-op);
      max-width: var(--col-op);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .matrix tbody tr:hover th {
      background: var(--hover-bg);
    }
    
    .matrix td {
      border: 1px solid var(--border);
      padding: 12px;
      width: var(--col-w);
      min-width: var(--col-w);
      max-width: var(--col-w);
      height: var(--day-h);
      min-height: var(--day-h);
      max-height: var(--day-h);
      vertical-align: top;
      text-align: left;
      position: relative;
      background: var(--card);
      overflow: hidden;
      font-size: 15px;
    }
    
    .matrix tbody tr:hover td {
      background: var(--hover-bg);
    }
    
    .matrix td.weekend {
      background: hsl(210,20%,97%);
    }
    
    .matrix tbody tr:hover td.weekend {
      background: hsl(210,20%,95%);
    }
    
    .matrix td.holiday {
      background: hsl(0,60%,96%);
    }
    
    .matrix tbody tr:hover td.holiday {
      background: hsl(0,60%,94%);
    }
    
    .entry {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 8px 10px;
      border-radius: 8px;
      background: var(--orange-weak);
      border: 1px solid var(--orange-border);
      margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,.05);
    }
    
    .entry:last-child { margin-bottom: 0; }
    
    .entry-cantiere {
      font-weight: 700;
      font-size: var(--fs-cantiere);
      color: var(--text);
      letter-spacing: 0.3px;
      line-height: 1.2;
      word-wrap: break-word;
    }
    
    .entry-ore {
      font-weight: 700;
      font-size: var(--fs-ore);
      color: var(--primary);
      letter-spacing: 0.3px;
    }
    
    .entry-lav {
      font-size: var(--fs-lav);
      color: var(--text-light);
      font-weight: 600;
      line-height: 1.3;
      word-wrap: break-word;
    }
    
    .entry-note {
      font-size: var(--fs-note);
      color: var(--muted);
      line-height: 1.3;
      font-style: italic;
      word-wrap: break-word;
    }
    
    .entry-orari {
      font-size: var(--fs-note);
      color: var(--text-light);
      line-height: 1.3;
      word-wrap: break-word;
    }
    
    .tot {
      font-weight: 700;
      font-size: var(--fs-tot);
      color: var(--text);
      text-align: center;
      padding: 6px;
      border-top: 1px solid var(--orange-border);
      margin-top: 4px;
    }
    
    @media print {
      body { background: white; }
      .control-panel, button { display: none; }
      .table-wrap { overflow: visible; width: auto; }
      .matrix thead th, .matrix tbody th { position: static; }
      .table-card { box-shadow: none; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>üìã Gestione Presenze Cantiere</h1>
  <div class="control-panel">
    <div class="control-row">
      <div class="control-left">
        <div class="nav">
          <a href="index.html">üè† Home</a>
          <a href="presenze.html">üÜï Nuovo Inserimento</a>
        </div>
        <button id="prevMonth" class="month-btn" title="Mese precedente">‚óÄ</button>
        <input type="month" id="mese" />
        <div id="meseFallback" class="hidden" style="display:flex;gap:8px;">
          <select id="selMese"></select>
          <select id="selAnno"></select>
        </div>
        <button id="nextMonth" class="month-btn" title="Mese successivo">‚ñ∂</button>
        <button id="btnCarica" class="primary">üîç Carica</button>
      </div>
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <label class="checkbox-label">
          <input type="checkbox" id="chkLav" checked />
          Mostra Lavorazioni
        </label>
        <div class="legend">
          <span class="pill"></span>
          <span>Parziale (mezza giornata)</span>
        </div>
        <button id="btnPDF" title="Esporta PDF A3 Verticale (3 fogli)">üìÑ PDF</button>
        <button id="btnXLS" title="Esporta Excel">üìä Excel</button>
      </div>
    </div>
    <div id="status"></div>
  </div>

  <div class="matrix-stack">
    <div class="table-card" id="cardA">
      <div class="table-title">Giorni 1‚Äì10</div>
      <div class="table-wrap"><table class="matrix" id="tableA"></table></div>
    </div>
    <div class="table-card" id="cardB">
      <div class="table-title">Giorni 11‚Äì20</div>
      <div class="table-wrap"><table class="matrix" id="tableB"></table></div>
    </div>
    <div class="table-card" id="cardC">
      <div class="table-title">Giorni 21‚Äì31</div>
      <div class="table-wrap"><table class="matrix" id="tableC"></table></div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  const SHEET_ID = "1FYnWnWnO5PH-kLLK1qXr7w9oHlFCWDSDuN_lrT7V4TY";
  const GID = "1738028949";
  let SHOW_LAV = true;
  
  const statusEl = document.getElementById("status");
  const chkLav = document.getElementById("chkLav");
  const selMese = document.getElementById("selMese");
  const selAnno = document.getElementById("selAnno");
  const tableA = document.getElementById("tableA");
  const tableB = document.getElementById("tableB");
  const tableC = document.getElementById("tableC");

  const supportsMonth = (() => { const i=document.createElement('input'); i.setAttribute('type','month'); return i.type==='month'; })();

  const cache = { Y:null, M:null, data:[], operai:[], byOpDay:{} };

  chkLav.addEventListener("change", ()=>{ SHOW_LAV = chkLav.checked; buildAll(); });

  function pad(n){ return String(n).padStart(2,'0'); }

  function populateYearSelect(Y){
    selAnno.innerHTML="";
    for(let y=Y-5;y<=Y+5;y++){
      const opt=document.createElement("option");
      opt.value=y; opt.textContent=y;
      selAnno.appendChild(opt);
    }
  }

  function populateMonthSelect(){
    const mesi=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
    selMese.innerHTML="";
    for(let m=1;m<=12;m++){
      const opt=document.createElement("option");
      opt.value=m; opt.textContent=mesi[m-1];
      selMese.appendChild(opt);
    }
  }
  populateMonthSelect();

  function setYM(Y,M, updateInput){
    cache.Y = Y;
    cache.M = M;
    if(updateInput){
      const v = `${Y}-${pad(M)}`;
      if(supportsMonth){
        document.getElementById("mese").value = v;
      }else{
        selAnno.value = String(Y);
        selMese.value = String(M);
      }
    }
  }

  function shiftMonth(delta){
    let Y=cache.Y, M=cache.M;
    if(!Y||!M)return;
    M+=delta;
    if(M<1){ M=12; Y--; }
    if(M>12){ M=1; Y++; }
    setYM(Y,M,true);
    carica();
  }

  function italianHolidays(Y){
    function easter(y){
      const a=y%19, b=~~(y/100), c=y%100, d=~~(b/4), e=b%4;
      const f=~~((b+8)/25), g=~~((b-f+1)/3), h=(19*a+b-d-g+15)%30;
      const i=~~(c/4), k=c%4, l=(32+2*e+2*i-h-k)%7;
      const m=~~((a+11*h+22*l)/451), n=~~((h+l-7*m+114)/31);
      const p=(h+l-7*m+114)%31;
      return new Date(y,n-1,p+1);
    }
    const e=easter(Y), eM=e.getMonth(), eD=e.getDate();
    const set={
      [`${Y}-01-01`]:1,[`${Y}-01-06`]:1,[`${Y}-04-25`]:1,[`${Y}-05-01`]:1,[`${Y}-06-02`]:1,
      [`${Y}-08-15`]:1,[`${Y}-11-01`]:1,[`${Y}-12-08`]:1,[`${Y}-12-25`]:1,[`${Y}-12-26`]:1
    };
    const lun=new Date(Y,eM,eD+1); set[`${Y}-${pad(lun.getMonth()+1)}-${pad(lun.getDate())}`]=1;
    return set;
  }

  function parseDateTime(s){
    if(!s||s==="-"||s==="‚Äî")return null;
    s=s.trim();
    const parts=s.split(/[\/\-]/);
    if(parts.length===3){
      const [d,m,y]=parts.map(Number);
      if(d>=1&&d<=31 && m>=1&&m<=12 && y>1900)return new Date(y,m-1,d);
    }
    return null;
  }

  function parseOre(s){
    s=String(s||"").trim().toLowerCase();
    if(!s||s==="-"||s==="‚Äî")return null;
    s=s.replace(/[h]/g,"").trim();
    const n=parseFloat(s);
    return (!isNaN(n)&&n>=0)?n:null;
  }

  function parsePartialDay(s){
    const st=String(s||"").toLowerCase().trim();
    return st==="mattina"||st==="pomeriggio";
  }

  async function carica(){
    const Y=cache.Y, M=cache.M;
    if(!Y||!M){alert("Seleziona un mese valido.");return;}

    const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
    statusEl.innerHTML='<span class="spinner show"></span> Caricamento...';
    try{
      const r=await fetch(url);
      if(!r.ok)throw new Error("Errore download CSV");
      const text=await r.text();
      cache.data=parseCSV(text);
      statusEl.innerHTML='<span class="ok">‚úì Dati caricati con successo!</span>';
      setTimeout(()=>statusEl.textContent='',3000);
      buildAll();
    }catch(e){
      console.error(e);
      statusEl.innerHTML=`<span class="error">‚úó ${e.message}</span>`;
    }
  }

  function parseCSV(txt){
    const lines=txt.split(/\r?\n/).filter(l=>l.trim());
    if(lines.length<2)return[];
    const header=lines[0].split(',');
    const rows=[];
    for(let i=1;i<lines.length;i++){
      const cells=parseCSVLine(lines[i]);
      if(cells.length!==header.length)continue;
      const obj={};
      for(let j=0;j<header.length;j++){obj[header[j].trim()]=cells[j];}
      rows.push(obj);
    }
    return rows;
  }

  function parseCSVLine(line){
    const res=[]; let cell='',inQuote=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){
        if(inQuote&&line[i+1]==='"'){cell+='"';i++;}
        else inQuote=!inQuote;
      }else if(c===','&&!inQuote){res.push(cell.trim());cell='';}
      else cell+=c;
    }
    res.push(cell.trim());
    return res;
  }

  function buildAll(){
    const Y=cache.Y, M=cache.M;
    if(!Y||!M)return;

    const filtered=cache.data.filter(r=>{
      const dt=parseDateTime(r.data);
      return dt&&dt.getFullYear()===Y&&(dt.getMonth()+1)===M;
    });
    const opSet=new Set(filtered.map(r=>r.operaio).filter(Boolean));
    cache.operai=Array.from(opSet).sort();

    cache.byOpDay={};
    filtered.forEach(r=>{
      const op=r.operaio; if(!op)return;
      const dt=parseDateTime(r.data);
      const d=dt.getDate();
      if(!cache.byOpDay[op])cache.byOpDay[op]={};
      if(!cache.byOpDay[op][d])cache.byOpDay[op][d]=[];
      cache.byOpDay[op][d].push({
        cantiere:r.cantiere||"",
        ore:parseOre(r.ore),
        partial:parsePartialDay(r.partial_day),
        orari:r.orari||"",
        lavorazione:r.lavorazione||"",
        note:r.note||""
      });
    });

    buildTable(tableA, 1, 10);
    buildTable(tableB, 11, 20);
    buildTable(tableC, 21, 31);
  }

  function buildTable(tbl, startDay, endDay){
    const Y=cache.Y, M=cache.M;
    const daysInMonth=new Date(Y,M,0).getDate();
    const holidays=italianHolidays(Y);

    let html='<thead><tr><th style="width:var(--col-op);min-width:var(--col-op);">Operaio</th>';
    for(let d=startDay;d<=endDay;d++){
      if(d>daysInMonth)html+='<th></th>';
      else html+=`<th>${d}</th>`;
    }
    html+='</tr></thead><tbody>';

    cache.operai.forEach(op=>{
      html+='<tr><th>'+op+'</th>';
      for(let d=startDay;d<=endDay;d++){
        if(d>daysInMonth){html+='<td></td>';continue;}
        const dt=new Date(Y,M-1,d);
        const dow=dt.getDay();
        const iso=`${Y}-${pad(M)}-${pad(d)}`;
        let cls='';
        if(holidays[iso])cls='holiday';
        else if(dow===0||dow===6)cls='weekend';

        const entries=(cache.byOpDay[op]&&cache.byOpDay[op][d])?cache.byOpDay[op][d]:[];
        if(!entries.length){html+=`<td class="${cls}">‚Äî</td>`;continue;}

        let content='';
        let totalOre=0;
        entries.forEach(en=>{
          const cant=(en.cantiere||"").toString().toUpperCase();
          const ore=en.ore;
          if(ore!=null && !isNaN(ore))totalOre+=ore;

          let ecls="entry";
          if(en.partial)ecls+=" ";

          content+=`<div class="${ecls}">`;
          if(cant)content+=`<div class="entry-cantiere">${cant}</div>`;
          if(ore!=null && !isNaN(ore))content+=`<div class="entry-ore">${ore} h</div>`;
          if(SHOW_LAV && en.lavorazione)content+=`<div class="entry-lav">${en.lavorazione}</div>`;
          if(en.orari)content+=`<div class="entry-orari">${en.orari}</div>`;

          const nt=(en.note||"").trim();
          const orr=(en.orari||"").trim();
          if(nt && nt!=="-" && nt!=="‚Äî" && nt!=="." && nt!=="¬∑" && nt!==orr){
            content+=`<div class="entry-note">${nt}</div>`;
          }
          content+=`</div>`;
        });

        if(entries.length>1){
          content+=`<div class="tot">Tot: ${(+totalOre.toFixed(2)).toString()} h</div>`;
        }

        let style='';
        if(en && en.partial)style=' style="background:var(--orange-weak);border:1px solid var(--orange-border);"';
        html+=`<td class="${cls}"${style}>${content}</td>`;
      }
      html+='</tr>';
    });

    html+='</tbody>';
    tbl.innerHTML=html;
  }

  /* ============ PDF EXPORT ============ */
  let pdfLibsLoaded = false;
  async function ensurePdfLibs(){
    if(pdfLibsLoaded)return;
    await Promise.all([
      loadScript("https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"),
      loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js")
    ]);
    pdfLibsLoaded=true;
  }

  function loadScript(url){
    return new Promise((resolve,reject)=>{
      if(document.querySelector(`script[src="${url}"]`)){resolve();return;}
      const s=document.createElement('script');
      s.src=url; s.onload=resolve; s.onerror=reject;
      document.head.appendChild(s);
    });
  }

  async function captureCardFull(cardId){
    const src=document.getElementById(cardId);
    if(!src)throw new Error('Card non trovata: '+cardId);

    const tbl=src.querySelector('table.matrix');
    if(!tbl)throw new Error('Tabella non trovata in '+cardId);

    const cols=tbl.querySelectorAll('thead th').length;
    const colW=270, colOp=210;
    const fullWidth=colOp+(cols-1)*colW;

    const clone=src.cloneNode(true);
    const cloneWrap=clone.querySelector('.table-wrap');
    if(cloneWrap){
      cloneWrap.style.overflow='visible';
      cloneWrap.style.width=(fullWidth+2)+'px';
      cloneWrap.style.maxWidth='none';
    }
    clone.querySelectorAll('thead th, tbody th').forEach(el=>{el.style.position='static';});

    const holder=document.createElement('div');
    holder.style.position='absolute';
    holder.style.left='-10000px';
    holder.style.top='0';
    holder.style.background='#ffffff';
    holder.appendChild(clone);
    document.body.appendChild(holder);

    await new Promise(r=>requestAnimationFrame(r));

    const w=holder.scrollWidth;
    const h=holder.scrollHeight;
    const MAX_AREA=12e6;
    const baseDpr=Math.min(1.5,window.devicePixelRatio||1);
    let scale=baseDpr;
    if(w*h*scale*scale>MAX_AREA){
      scale=Math.sqrt(MAX_AREA/(w*h));
    }
    scale=Math.max(0.6,Math.min(scale,1.2));

    const canvas=await html2canvas(clone,{
      scale,
      backgroundColor:'#ffffff',
      useCORS:true,
      logging:false,
      windowWidth:holder.scrollWidth,
      windowHeight:holder.scrollHeight,
      willReadFrequently:true
    });

    document.body.removeChild(holder);
    return canvas;
  }

  function downscaleCanvasIfNeeded(canvas,maxArea=8e6,maxDim=4200){
    const area=canvas.width*canvas.height;
    if(area<=maxArea&&Math.max(canvas.width,canvas.height)<=maxDim)return canvas;

    const factor=Math.min(
      Math.sqrt(maxArea/area),
      maxDim/Math.max(canvas.width,canvas.height)
    );

    const tmp=document.createElement('canvas');
    tmp.width=Math.max(1,Math.floor(canvas.width*factor));
    tmp.height=Math.max(1,Math.floor(canvas.height*factor));
    const ctx=tmp.getContext('2d');
    ctx.imageSmoothingEnabled=true;
    ctx.imageSmoothingQuality='high';
    ctx.drawImage(canvas,0,0,tmp.width,tmp.height);
    return tmp;
  }

  function canvasToDataURLSafe(canvas){
    const qualities=[0.82,0.7,0.6,0.5];
    for(const q of qualities){
      try{return canvas.toDataURL('image/jpeg',q);}catch(e){}
    }
    try{return canvas.toDataURL('image/png');}catch(e){}
    throw new Error('Impossibile codificare immagine (memoria)');
  }

  async function exportPDF(){
    try{
      await ensurePdfLibs();
      statusEl.innerHTML='<span class="ok">‚è≥ Preparazione PDF in corso...</span>';

      let [canvasA,canvasB,canvasC]=await Promise.all([
        captureCardFull('cardA'),
        captureCardFull('cardB'),
        captureCardFull('cardC')
      ]);

      canvasA=downscaleCanvasIfNeeded(canvasA,8e6,4200);
      canvasB=downscaleCanvasIfNeeded(canvasB,8e6,4200);
      canvasC=downscaleCanvasIfNeeded(canvasC,8e6,4200);

      const {jsPDF}=window.jspdf;
      const doc=new jsPDF({orientation:'portrait',unit:'pt',format:'a3'});

      const pageW=doc.internal.pageSize.getWidth();
      const pageH=doc.internal.pageSize.getHeight();
      const MARGIN=10;

      function addCanvasPage(canvas,first){
        const availW=pageW-2*MARGIN;
        const availH=pageH-2*MARGIN;
        const s=Math.min(availW/canvas.width,availH/canvas.height);
        const w=canvas.width*s;
        const h=canvas.height*s;
        const x=MARGIN+(availW-w)/2;
        const y=MARGIN+(availH-h)/2;

        const safeCanvas=downscaleCanvasIfNeeded(canvas,8e6,4200);
        const img=canvasToDataURLSafe(safeCanvas);

        if(!first)doc.addPage();
        doc.addImage(img,'JPEG',x,y,w,h);
      }

      addCanvasPage(canvasA,true);
      addCanvasPage(canvasB,false);
      addCanvasPage(canvasC,false);

      const [Y,M]=[cache.Y,cache.M];
      const fname=`Presenze_${Y}-${pad(M)}.pdf`;
      doc.save(fname);

      statusEl.innerHTML='<span class="ok">‚úì PDF esportato con successo!</span>';
      setTimeout(()=>statusEl.textContent='',3000);
    }catch(e){
      console.error(e);
      alert('Export PDF fallito: '+(e&&e.message?e.message:e));
      statusEl.innerHTML='<span class="error">‚úó Errore durante l\'export PDF</span>';
    }
  }

  /* ============ EXCEL EXPORT ============ */
  function xmlEscape(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&apos;");
  }

  function buildMatrix(startDay,endDay){
    const Y=cache.Y,M=cache.M;
    const daysInMonth=new Date(Y,M,0).getDate();
    const holidays=italianHolidays(Y);
    const header=["Operaio"];
    for(let d=startDay;d<=endDay;d++){
      header.push(d<=daysInMonth?String(d):"");
    }
    const rows=[header];

    cache.operai.forEach(op=>{
      const line=[op];
      for(let d=startDay;d<=endDay;d++){
        if(d>daysInMonth){line.push("");continue;}
        const entries=(cache.byOpDay[op]&&cache.byOpDay[op][d])?cache.byOpDay[op][d]:[];
        if(!entries.length){line.push("‚Äî");continue;}

        let total=0;
        const parts=[];
        entries.forEach(en=>{
          const chunks=[];
          const cantDisp=(en.cantiere||"").toString().toUpperCase();
          if(cantDisp)chunks.push(cantDisp);
          if(en.ore!=null&&!isNaN(en.ore)){chunks.push(`${en.ore} h`);total+=Number(en.ore);}
          if(SHOW_LAV&&en.lavorazione){chunks.push(en.lavorazione);}

          let line=en.orari||"";
          const nt=(en.note||"").trim();
          if(nt&&nt!=="-"&&nt!=="‚Äî"&&nt!=="."&&nt!=="¬∑"&&nt!==line.trim()){
            line=line?(line+" ‚Äî "+nt):nt;
          }
          if(line)chunks.push(line);

          parts.push(chunks.join("\n"));
        });
        if(entries.length>1){parts.push(`Tot: ${(+total.toFixed(2)).toString()} h`);}
        line.push(parts.join("\n\n"));
      }
      rows.push(line);
    });
    return rows;
  }

  function sheetXML(name,rows){
    const colCount=rows[0]?.length||1;
    let cols="";
    for(let i=0;i<colCount;i++){
      const w=i===0?160:80;
      cols+=`<Column ss:Width="${w}"/>`;
    }
    const lines=rows.map((r,ri)=>{
      const cells=r.map((c)=>{
        const text=xmlEscape(c==null?"":String(c));
        return `<Cell${ri===0?` ss:StyleID="hdr"`:""}><Data ss:Type="String">${text}</Data></Cell>`;
      }).join("");
      return `<Row>${cells}</Row>`;
    }).join("");
    return `<Worksheet ss:Name="${xmlEscape(name)}"><Table>${cols}${lines}</Table></Worksheet>`;
  }

  function exportExcel(){
    if(!cache.Y||!cache.M){
      alert("Carica prima un mese.");
      return;
    }

    statusEl.innerHTML='<span class="ok">‚è≥ Generazione Excel...</span>';

    const dataA=buildMatrix(1,10);
    const dataB=buildMatrix(11,20);
    const dataC=buildMatrix(21,31);

    const now=new Date().toISOString();
    const xml=
`<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
 <DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">
  <Author>Presenze Cantiere</Author>
  <Created>${now}</Created>
 </DocumentProperties>
 <ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">
  <ProtectStructure>False</ProtectStructure>
  <ProtectWindows>False</ProtectWindows>
 </ExcelWorkbook>
 <Styles>
  <Style ss:ID="Default" ss:Name="Normal">
    <Alignment ss:Vertical="Top" ss:WrapText="1"/>
    <Borders/>
    <Font ss:FontName="Calibri" ss:Size="11"/>
    <Interior/>
    <NumberFormat/>
    <Protection/>
  </Style>
  <Style ss:ID="hdr">
    <Font ss:Bold="1"/>
    <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
    <Interior ss:Color="#EEEEEE" ss:Pattern="Solid"/>
  </Style>
 </Styles>
 ${sheetXML("Giorni 1‚Äì10",dataA)}
 ${sheetXML("Giorni 11‚Äì20",dataB)}
 ${sheetXML("Giorni 21‚Äì31",dataC)}
</Workbook>`;

    const blob=new Blob([xml],{type:"application/vnd.ms-excel"});
    const [Y,M]=[cache.Y,cache.M];
    const fname=`Presenze_${Y}-${pad(M)}.xls`;
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=fname;
    document.body.appendChild(a);a.click();a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href),3000);

    statusEl.innerHTML='<span class="ok">‚úì Excel esportato con successo!</span>';
    setTimeout(()=>statusEl.textContent='',3000);
  }

  /* ============ INIT ============ */
  (function init(){
    if(!supportsMonth){
      document.getElementById("mese").classList.add('hidden');
      document.getElementById("meseFallback").classList.remove('hidden');
    }
    const now=new Date();
    populateYearSelect(now.getFullYear());
    const Y=now.getFullYear();
    const M=now.getMonth()+1;
    setYM(Y,M,true);

    document.getElementById("btnCarica").addEventListener("click",carica);
    document.getElementById("prevMonth").addEventListener("click",()=>shiftMonth(-1));
    document.getElementById("nextMonth").addEventListener("click",()=>shiftMonth(+1));
    document.getElementById("btnPDF").addEventListener("click",exportPDF);
    document.getElementById("btnXLS").addEventListener("click",exportExcel);

    const meseInputEl=document.getElementById("mese");
    meseInputEl.addEventListener("change",()=>{
      const v=meseInputEl.value;
      if(v&&/^\d{4}-\d{2}$/.test(v)){
        const [y,m]=v.split('-').map(Number);
        setYM(y,m,true);
      }
    });
    selMese.addEventListener("change",()=>setYM(Number(selAnno.value),Number(selMese.value),false));
    selAnno.addEventListener("change",()=>setYM(Number(selAnno.value),Number(selMese.value),false));

    carica();
  })();
  </script>
</body>
</html>
