<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Analisi per Operaio - Dashboard Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --primary: hsl(210,100%,45%);
    --primary-dark: hsl(210,100%,35%);
    --text: hsl(210,15%,15%);
    --text-light: hsl(210,10%,40%);
    --muted: hsl(210,8%,50%);
    --bg: hsl(210,25%,96%);
    --card: #ffffff;
    --border: hsl(210,20%,88%);
    --border-strong: hsl(210,20%,75%);
    --orange-weak: hsla(30,100%,50%,0.12);
    --orange-border: hsla(30,100%,50%,0.3);
    --success: hsl(140,70%,40%);
    --error: hsl(0,70%,50%);
    --hover-bg: hsl(210,30%,98%);
  }
  
  * { box-sizing: border-box; }
  
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font: 16px/1.6 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }
  
  .container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 32px 40px;
  }
  
  h1 {
    margin: 0 0 24px;
    font-size: 32px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.5px;
  }

  /* CONTROL PANEL */
  .control-panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 2px 12px rgba(0,0,0,.06);
    margin-bottom: 28px;
  }
  
  .control-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
  }
  
  .control-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .nav {
    display: flex;
    gap: 10px;
  }
  
  .nav a {
    padding: 10px 18px;
    border: 2px solid var(--border);
    border-radius: 10px;
    background: var(--card);
    text-decoration: none;
    font-weight: 600;
    font-size: 15px;
    color: var(--text);
    transition: all 0.2s;
  }
  
  .nav a:hover {
    border-color: var(--primary);
    background: var(--hover-bg);
  }
  
  .nav a.primary {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }
  
  .nav a.primary:hover {
    background: var(--primary-dark);
  }
  
  input[type="month"] {
    padding: 10px 16px;
    border: 2px solid var(--border);
    border-radius: 10px;
    background: var(--card);
    font-size: 15px;
    font-weight: 500;
    min-width: 160px;
    transition: border-color 0.2s;
  }
  
  input[type="month"]:focus {
    outline: none;
    border-color: var(--primary);
  }
  
  button {
    padding: 10px 18px;
    border: 2px solid var(--border);
    border-radius: 10px;
    background: var(--card);
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    transition: all 0.2s;
    color: var(--text);
  }
  
  button:hover:not(:disabled) {
    border-color: var(--primary);
    background: var(--hover-bg);
  }
  
  button.primary {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }
  
  button.primary:hover:not(:disabled) {
    background: var(--primary-dark);
  }
  
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .spinner {
    display: none;
  }
  
  .spinner.show {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #ddd;
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: -4px;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  #status {
    margin-top: 12px;
    font-size: 15px;
  }
  
  .ok {
    color: var(--success);
    font-weight: 600;
  }
  
  .error {
    color: var(--error);
    font-weight: 600;
  }

  /* TABLE CARDS */
  .table-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,.06);
    overflow: hidden;
    margin-bottom: 28px;
  }
  
  .table-title {
    padding: 20px 24px;
    border-bottom: 2px solid var(--border);
    font-weight: 700;
    font-size: 20px;
    color: var(--text);
    background: linear-gradient(to bottom, var(--card), var(--hover-bg));
  }
  
  .table-wrap {
    overflow-x: auto;
  }

  table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    font-size: 15px;
  }
  
  thead th {
    background: var(--hover-bg);
    border-bottom: 2px solid var(--border-strong);
    padding: 16px 18px;
    text-align: left;
    white-space: nowrap;
    font-weight: 700;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-light);
  }
  
  tbody td,
  tbody th {
    border-top: 1px solid var(--border);
    padding: 16px 18px;
    font-size: 15px;
  }
  
  tbody tr {
    transition: background-color 0.15s;
  }
  
  tbody tr:hover {
    background: var(--hover-bg);
  }
  
  td.num {
    text-align: right;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }

  .op-link {
    color: var(--primary);
    font-weight: 700;
    font-size: 16px;
    text-decoration: none;
    cursor: pointer;
    transition: color 0.2s;
  }
  
  .op-link:hover {
    color: var(--primary-dark);
    text-decoration: underline;
  }

  /* DETAIL TABLE */
  .detail {
    font-size: 14px;
  }
  
  .detail .daycell {
    white-space: nowrap;
    font-weight: 700;
    font-size: 15px;
    color: var(--text);
    min-width: 120px;
  }
  
  .detail .cant {
    font-weight: 800;
    color: #c00000;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    font-size: 13px;
  }
  
  .detail .lav {
    color: var(--text);
    margin-top: 6px;
    line-height: 1.5;
  }
  
  .detail .note {
    color: var(--muted);
    font-style: italic;
    margin-top: 4px;
    font-size: 13px;
  }
  
  .detail td,
  .detail th {
    vertical-align: top;
    padding: 14px 16px;
  }
  
  .detail tfoot td {
    font-weight: 800;
    border-top: 3px solid var(--border-strong);
    padding: 18px 16px;
    font-size: 16px;
    background: var(--hover-bg);
  }

  /* Weekend/Festivi highlight */
  .detail tr.off td {
    background: var(--orange-weak) !important;
  }

  /* Alternanza righe normali */
  .detail tr.alt td {
    background: #fafafa;
  }

  /* Gabbia perimetro giorno */
  .detail tr.gstart td {
    border-top: 2px solid var(--border-strong);
  }
  
  .detail tr.gend td {
    border-bottom: 2px solid var(--border-strong);
  }

  .detail tr.gstart td.daycell,
  .detail tr.gmid td.daycell,
  .detail tr.gend td.daycell {
    border-left: 2px solid var(--border-strong);
  }

  .detail tr.gstart td:last-child,
  .detail tr.gmid td:last-child,
  .detail tr.gend td:last-child {
    border-right: 2px solid var(--border-strong);
  }

  /* Arrotondamenti */
  .detail tr.gstart td.daycell {
    border-top-left-radius: 10px;
  }
  
  .detail tr.gstart td:last-child {
    border-top-right-radius: 10px;
  }
  
  .detail tr.gend td.daycell {
    border-bottom-left-radius: 10px;
  }
  
  .detail tr.gend td:last-child {
    border-bottom-right-radius: 10px;
  }

  /* Tot giorno */
  .detail tr.daytot td {
    font-weight: 800;
    background: var(--hover-bg);
  }
  
  /* Footer azioni */
  .detail-footer {
    padding: 20px 24px;
    border-top: 2px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    background: var(--hover-bg);
  }
  
  /* Empty state */
  .empty-state {
    padding: 60px 24px;
    text-align: center;
    color: var(--muted);
    font-size: 16px;
  }

  /* PDF LAYOUT container */
  .pdf-container {
    display: none;
  }

  @media print {
    body { background: white; }
    .container { padding: 20px; }
  }
</style>
</head>
<body>
<div class="container">
  <h1>ðŸ“Š Analisi per Operaio</h1>

  <div class="control-panel">
    <div class="control-row">
      <div class="control-left">
        <button id="prevMonth" title="Mese precedente">â—€</button>
        <input type="month" id="mese" />
        <button id="nextMonth" title="Mese successivo">â–¶</button>
        <button id="btnCarica" class="primary">Carica Dati</button>
        <span id="spin" class="spinner"></span>
      </div>
      <div class="nav">
        <a href="gestione.html">Presenze</a>
        <a class="primary" href="analisi-operaio.html">Analisi per Operaio</a>
        <a href="analisi-cantiere.html">Analisi per Cantiere</a>
      </div>
    </div>
    <div id="status"></div>
  </div>

  <!-- RIEPILOGO -->
  <div class="table-card">
    <div class="table-title">ðŸ“ˆ Riepilogo Mensile</div>
    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>Operaio</th>
            <th class="num">Ore Totali</th>
            <th class="num">Giorni Lavorati</th>
            <th class="num">Media / Giorno</th>
            <th class="num">Ore Weekend/Festivi</th>
            <th class="num">GG "NO DATI" (feriali)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- DETTAGLIO -->
  <div class="table-card" id="detailCard" style="display:none">
    <div class="table-title" id="detailTitle">ðŸ‘¤ Dettaglio Operaio</div>
    <div class="table-wrap">
      <table id="detailTable" class="detail">
        <thead>
          <tr>
            <th>Giorno</th>
            <th>Cantiere</th>
            <th class="num">Orario / Ore</th>
            <th>Lavorazioni / Note</th>
          </tr>
        </thead>
        <tbody id="detailBody"></tbody>
        <tfoot>
          <tr>
            <td colspan="2"><strong>Totale Mese</strong></td>
            <td class="num" id="detailTotOre">0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="detail-footer">
      <button id="btnDetailPDF">ðŸ“„ Esporta PDF (2 colonne)</button>
      <button id="btnCloseDetail">âœ• Chiudi Dettaglio</button>
    </div>
  </div>
</div>

<!-- Container nascosto per il PDF -->
<div id="pdfContainer" class="pdf-container"></div>

<!-- Librerie -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ====== CONFIG ====== */
const SHEET_ID = "1WLK8tqQPAddqOm1DkTAOdtG5iFS9nYQFc3pxL0Fdc70";
const TAB_CANDIDATES = ["Foglio1","Presenze","Sheet1","Foglio 1"];

/* ====== UTIL ====== */
const pad = n => String(n).padStart(2,"0");

function calcEaster(Y){
  const a=Y%19,b=Math.floor(Y/100),c=Y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),
        g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,L=(32+2*e+2*i-h-k)%7,
        m=Math.floor((a+11*h+22*L)/451),month=Math.floor((h+L-7*m+114)/31),day=((h+L-7*m+114)%31)+1;
  return new Date(Y,month-1,day);
}

function italianHolidays(year){
  const set=new Set(),add=(m,d)=>set.add(`${year}-${pad(m)}-${pad(d)}`);
  add(1,1); add(1,6); add(4,25); add(5,1); add(6,2); add(8,15); add(11,1); add(12,8); add(12,25); add(12,26);
  const p=calcEaster(year), q=new Date(p); q.setDate(p.getDate()+1);
  add(p.getMonth()+1,p.getDate()); add(q.getMonth()+1,q.getDate());
  return set;
}

const normalize = s => String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim().toLowerCase();

function parseDateAny(v){
  if(!v) return null;
  if(v instanceof Date) return v;
  const s = String(v).trim();
  if(/^\d{4}-\d{2}-\d{2}/.test(s)){ const [Y,M,D]=s.split("T")[0].split("-").map(Number); return new Date(Y,M-1,D); }
  if(/^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)){ const [d,m,y]=s.split(/[ /]/).map(Number); return new Date(y,m-1,d); }
  const t = new Date(s); return isNaN(t) ? null : t;
}

function pick(row, ...names){
  if(!row) return "";
  const map = new Map(Object.keys(row).map(k => [normalize(k), k]));
  for(const name of names){
    const key = map.get(normalize(name));
    if(key && row[key] != null && row[key] !== "") return row[key];
  }
  return "";
}

function isBlankCantiere(value){
  const s = String(value||"").trim();
  if(!s) return true;
  if (/^[-â€“â€”]+$/.test(s)) return true;
  if (/^(nd|n\.d\.|n\/d|na|n\.a\.|n\/a|non\s+specificato|sconosciuto|nessuno|undefined|null)$/i.test(s)) return true;
  if (/^\(s.*cantiere\)$/i.test(s)) return true;
  return false;
}

const TIME_RANGE_RE = /\b\d{1,2}[:.]\d{2}\s*-\s*\d{1,2}[:.]\d{2}\b/g;
const stripIntervals = s => s ? String(s).replace(TIME_RANGE_RE,"").replace(/\s{2,}/g," ").trim() : "";

/* ====== STATE & UI refs ====== */
const meseInput = document.getElementById('mese');
const prevBtn   = document.getElementById('prevMonth');
const nextBtn   = document.getElementById('nextMonth');
const btnCarica = document.getElementById('btnCarica');
const spin      = document.getElementById('spin');
const statusEl  = document.getElementById('status');
const tbody     = document.getElementById('tbody');

const detailCard   = document.getElementById('detailCard');
const detailTitle  = document.getElementById('detailTitle');
const detailBody   = document.getElementById('detailBody');
const detailTotOre = document.getElementById('detailTotOre');
const btnCloseDetail = document.getElementById('btnCloseDetail');

const state = { Y:null, M:null, holidays:new Set(), byOpDay:{}, operai:[], summary:[], currentOp:null };

function setYM(Y,M){ meseInput.value = `${Y}-${pad(M)}`; }

function getYM(){
  const v = meseInput.value;
  if(/^\d{4}-\d{2}$/.test(v)){ const [Y,M]=v.split('-').map(Number); return [Y,M]; }
  const d=new Date(); return [d.getFullYear(), d.getMonth()+1];
}

function shiftMonth(delta){
  let [Y,M]=getYM(); M+=delta;
  if(M<1){M=12;Y--} if(M>12){M=1;Y++}
  setYM(Y,M); carica();
}

function setLoading(on){
  spin.classList.toggle('show', !!on);
  btnCarica.disabled = !!on; prevBtn.disabled=!!on; nextBtn.disabled=!!on;
}

/* ====== FETCH ====== */
async function fetchRowsFromOpenSheet(sheetId){
  for(const tab of TAB_CANDIDATES){
    try{
      const url = `https://opensheet.elk.sh/${sheetId}/${encodeURIComponent(tab)}`;
      const res = await fetch(url, { cache: "no-store" });
      if(res.ok){
        const rows = await res.json();
        if(Array.isArray(rows)){
          statusEl.innerHTML = `<span class="ok">âœ“ Dati caricati con successo (tab: ${tab})</span>`;
          return rows;
        }
      }
    }catch(_e){}
  }
  throw new Error("Impossibile leggere il foglio: controlla il nome della tab.");
}

function groupDayEntries(entries){
  const map = new Map();
  entries.forEach(e=>{
    const cant = isBlankCantiere(e.cantiere) ? 'NO DATI' : String(e.cantiere).trim().toUpperCase();
    const lav  = stripIntervals(e.lavorazione||"");
    const note = stripIntervals(e.note||"");
    const key = `${cant}|${lav}|${note}`;
    if(!map.has(key)) map.set(key, {cant, lav, note, ore:0, orari:new Set(), count:0});
    const rec = map.get(key);
    rec.ore += (e.ore||0);
    if(e.orari){ String(e.orari).split(/[,;]+/).map(s=>s.trim()).filter(Boolean).forEach(x=>rec.orari.add(x)); }
    rec.count++;
  });
  return Array.from(map.values()).map(v=>({
    cant: v.count>1 ? `${v.cant} (x${v.count})` : v.cant,
    lav: v.lav,
    note: v.note,
    orari: Array.from(v.orari).join(', '),
    ore: +(+v.ore).toFixed(2)
  }));
}

/* ====== RENDER ====== */
function renderSummary(list){
  tbody.innerHTML = '';
  if(list.length===0){
    tbody.innerHTML = `<tr><td colspan="6" class="empty-state">Nessun operaio con ore registrate in questo mese.</td></tr>`;
    return;
  }
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><a class="op-link" data-op="${r.op}">${r.op}</a></td>
      <td class="num">${r.tot} h</td>
      <td class="num">${r.days}</td>
      <td class="num">${r.media} h</td>
      <td class="num">${r.weekend} h</td>
      <td class="num">${r.nodati}</td>`;
    tbody.appendChild(tr);
  });
}

function showDetail(op){
  state.currentOp = op;
  const [Y,M] = [state.Y, state.M];
  const daysInMonth = new Date(Y, M, 0).getDate();
  detailBody.innerHTML = '';
  let totMese = 0;
  let altFlag = false;

  for(let d=1; d<=daysInMonth; d++){
    const list0 = (state.byOpDay[op] && state.byOpDay[op][d]) ? state.byOpDay[op][d] : [];
    const date = new Date(Y, M-1, d);
    const dow  = (date.getDay()+6)%7;
    const iso  = `${Y}-${pad(M)}-${pad(d)}`;
    const isOff= (dow===5||dow===6) || state.holidays.has(iso);

    const nomeG = date.toLocaleDateString('it-IT',{weekday:'short'});
    const dayLabel = `${pad(d)}/${pad(M)} ${nomeG}`;

    const altClass = (!isOff && altFlag) ? 'alt' : '';

    if(!list0.length){
      const tr = document.createElement('tr');
      tr.className = `${isOff?'off':''} ${altClass} gstart gend`.trim();
      tr.innerHTML = `
        <td class="daycell">${dayLabel}</td>
        <td>â€”</td>
        <td class="num"></td>
        <td></td>`;
      detailBody.appendChild(tr);
      if(!isOff) altFlag = !altFlag;
      continue;
    }

    const list = groupDayEntries(list0);
    const rowspan = list.length;
    let dayTot = 0;

    list.forEach((en, idx) => {
      const tr = document.createElement('tr');
      if(isOff) tr.classList.add('off');
      if(altClass) tr.classList.add('alt');
      if(rowspan===1) tr.classList.add('gstart','gend');
      else if(idx===0) tr.classList.add('gstart');
      else if(idx===rowspan-1) tr.classList.add('gend');
      else tr.classList.add('gmid');

      if(idx === 0){
        const tdDay = document.createElement('td');
        tdDay.className = 'daycell';
        tdDay.rowSpan = rowspan;
        tdDay.textContent = dayLabel;
        tr.appendChild(tdDay);
      }

      const tdCant = document.createElement('td');
      tdCant.innerHTML = `<div class="cant">${en.cant}</div>`;

      const tdOrario = document.createElement('td');
      tdOrario.className = 'num';
      const firstLine = en.orari ? en.orari : '';
      const secondLine = en.ore ? `<br><strong>${en.ore} h</strong>` : '';
      tdOrario.innerHTML = firstLine + secondLine;

      const tdLav = document.createElement('td');
      const lavHtml  = en.lav  ? `<div class="lav">${en.lav.replace(/\n/g,'<br>')}</div>` : '';
      const noteHtml = en.note ? `<div class="note">${en.note.replace(/\n/g,'<br>')}</div>` : '';
      tdLav.innerHTML = lavHtml + noteHtml;

      dayTot += (en.ore || 0);

      tr.appendChild(tdCant);
      tr.appendChild(tdOrario);
      tr.appendChild(tdLav);
      detailBody.appendChild(tr);
    });

    if(list.length > 1){
      const trSub = document.createElement('tr');
      if(isOff) trSub.classList.add('off');
      if(altClass) trSub.classList.add('alt');
      trSub.classList.add('daytot','gend');

      trSub.innerHTML = `
        <td class="daycell"></td>
        <td style="text-align:right;">Tot giorno:</td>
        <td class="num"><strong>${(+dayTot.toFixed(2))} h</strong></td>
        <td></td>`;
      detailBody.appendChild(trSub);
    }

    totMese += dayTot;
    if(!isOff) altFlag = !altFlag;
  }

  detailTotOre.textContent = `${(+totMese.toFixed(2))} h`;
  detailTitle.textContent = `ðŸ‘¤ Dettaglio Operaio â€” ${op} (${pad(M)}/${Y})`;
  detailCard.style.display = 'block';
  detailCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/* ====== DATA LOAD ====== */
async function carica(){
  try{
    setLoading(true); statusEl.textContent=""; tbody.innerHTML=''; detailCard.style.display='none';

    const [Y,M]=getYM();
    state.Y=Y; state.M=M; state.holidays = italianHolidays(Y);

    const rows = await fetchRowsFromOpenSheet(SHEET_ID);

    state.byOpDay = {};
    rows.forEach((r)=>{
      const dataVal = pick(r, "Data Presenza", "Data");
      const dt = parseDateAny(dataVal);
      if(!dt) return;
      const y=dt.getFullYear(), m=dt.getMonth()+1, d=dt.getDate();
      if(y!==Y || m!==M) return;

      const op = String(pick(r, "Nome Operaio", "Operaio")).trim();
      if(!op) return;

      const cant     = String(pick(r, "Cantiere")).trim();
      const orariStr = String(pick(r, "Orari") || "").trim();
      const oreV     = pick(r, "Ore");
      const ore      = (oreV!=="" && oreV!=null) ? Number(String(oreV).replace(",",".")) : 0;
      const lav      = stripIntervals(String(pick(r, "Lavorazione") || ""));
      const note     = stripIntervals(String(pick(r, "Note") || ""));

      (state.byOpDay[op] ||= {});
      (state.byOpDay[op][d] ||= []);
      state.byOpDay[op][d].push({ ore, cantiere:cant, lavorazione:lav, note, orari: orariStr });
    });

    state.operai = Object.keys(state.byOpDay).sort((a,b)=>a.localeCompare(b,'it'));

    state.summary = state.operai.map(op=>{
      let tot=0, daysWorked=0, weekendHours=0, noDataDays=0;
      const days = state.byOpDay[op] || {};
      Object.keys(days).forEach(sd=>{
        const d = Number(sd);
        const list = days[d] || [];
        if(!list.length) return;

        let dayH=0, hasNoCant=false;
        const date = new Date(Y, M-1, d);
        const dow  = (date.getDay()+6)%7;
        const iso  = `${Y}-${pad(M)}-${pad(d)}`;
        const isOff= (dow===5||dow===6) || state.holidays.has(iso);

        list.forEach(en=>{
          const h = (en.ore!=null && !isNaN(en.ore)) ? Number(en.ore) : 0;
          dayH += h;
          if(isBlankCantiere(en.cantiere)) hasNoCant = true;
        });

        if(dayH>0){
          daysWorked++;
          tot += dayH;
          if(isOff) weekendHours += dayH;
        }
        if(hasNoCant && !isOff) noDataDays++;
      });

      const media = daysWorked ? +(tot/daysWorked).toFixed(2) : 0;
      return { op, tot:+tot.toFixed(2), days:daysWorked, media, weekend:+weekendHours.toFixed(2), nodati:noDataDays };
    }).sort((a,b)=> b.tot - a.tot || a.op.localeCompare(b.op,'it'));

    renderSummary(state.summary);
  }catch(e){
    console.error(e);
    statusEl.innerHTML = `<span class="error">âœ— ${e.message || "Errore nel caricamento dati."}</span>`;
  }finally{
    setLoading(false);
  }
}

/* ====== EXPORT PDF A4 â€” due colonne affiancate full-width + statistiche sotto ====== */
async function exportDetailPDF(){
  if(detailCard.style.display === 'none'){
    alert('Apri prima un dettaglio operaio.');
    return;
  }

  const { jsPDF } = window.jspdf;
  const [Y, M] = [state.Y, state.M];
  const op = state.currentOp;
  const daysInMonth = new Date(Y, M, 0).getDate();

  // Statistiche cantieri
  const cantieriStats = {};
  const days = state.byOpDay[op] || {};
  Object.keys(days).forEach(d => {
    (days[d] || []).forEach(en => {
      const cant = isBlankCantiere(en.cantiere) ? 'NO DATI' : String(en.cantiere).trim().toUpperCase();
      cantieriStats[cant] = (cantieriStats[cant] || 0) + (en.ore || 0);
    });
  });
  const totMese = state.summary.find(s => s.op === op)?.tot || 0;
  const cantieriArray = Object.entries(cantieriStats)
    .sort((a,b)=>b[1]-a[1])
    .map(([nome,ore])=>({nome, ore:+ore.toFixed(2), percentuale: totMese>0 ? +((ore/totMese)*100).toFixed(1) : 0}));

  const splitDay = 15;

  function createTableForRange(startDay, endDay, title, totRangeOp){
    const table = document.createElement('table');
    table.className = 'detail';
    // Stili per il PDF (alta risoluzione per html2canvas)
    table.style.tableLayout = 'fixed';
    table.style.wordBreak = 'break-word';
    table.style.width = '100%';
    table.style.fontSize = '50px'; // Ridotto leggermente
    table.style.borderCollapse = 'separate';
    table.style.borderSpacing = '0';
    table.style.border = '10px solid #c00'; // Bordo rosso come da immagine
    table.style.height = '100%'; // Tenta di riempire l'altezza della colonna

    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr>
        <th colspan="4" style="padding:40px 30px; text-align:center; font-weight:900; font-size:75px; color:#c00; background:#fff; border-bottom:10px solid #c00;">
          ${title}
        </th>
      </tr>
      <tr style="background:#f0f0f0;">
        <th style="padding:32px 25px; text-align:left; border-right:2px solid #ddd; font-weight:900; font-size:45px; color:#333; width:200px;">Giorno</th>
        <th style="padding:32px 25px; text-align:left; border-right:2px solid #ddd; font-weight:900; font-size:45px; color:#333;">Cantiere/Lav.</th>
        <th style="padding:32px 25px; text-align:center; border-right:2px solid #ddd; font-weight:900; font-size:45px; color:#333; width:280px;">Orario</th>
        <th style="padding:32px 25px; text-align:right; font-weight:900; font-size:45px; color:#333; width:150px;">Ore</th>
      </tr>`;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    let totRange = 0, altFlag = false;

    for(let d=startDay; d<=endDay; d++){
      const list0 = (state.byOpDay[op] && state.byOpDay[op][d]) ? state.byOpDay[op][d] : [];
      const date = new Date(Y, M-1, d);
      const dow  = (date.getDay()+6)%7;
      const iso  = `${Y}-${pad(M)}-${pad(d)}`;
      const isOff= (dow===5||dow===6) || state.holidays.has(iso);

      const nomeG = date.toLocaleDateString('it-IT',{weekday:'short'}).toUpperCase();
      const dayLabel = `<div style="font-size:55px; font-weight:900; line-height:1.2;">${pad(d)}/${pad(M)}</div><div style="font-size:35px; font-weight:700; color:#555;">${nomeG}</div>`;
      const bgColor = isOff ? '#ffe8cc' : (altFlag ? '#f9f9f9' : '#fff');
      const rowBorderColor = '#ddd';

      if(!list0.length){
        const tr = document.createElement('tr');
        tr.style.background = bgColor;
        tr.innerHTML = `
          <td style="padding:30px 25px; border-top:2px solid ${rowBorderColor}; font-weight:800; vertical-align:top;">${dayLabel}</td>
          <td style="padding:30px 25px; border-top:2px solid ${rowBorderColor}; text-align:center; color:#999; font-size:45px; vertical-align:top;">â€”</td>
          <td style="padding:30px 25px; border-top:2px solid ${rowBorderColor}; vertical-align:top;"></td>
          <td style="padding:30px 25px; border-top:2px solid ${rowBorderColor}; vertical-align:top;"></td>`;
        tbody.appendChild(tr);
        if(!isOff) altFlag = !altFlag;
      }else{
        const list = groupDayEntries(list0);
        let dayTot = 0;
        list.forEach((en, idx) => {
          const tr = document.createElement('tr');
          tr.style.background = bgColor;
          const borderStyle = idx===0 ? `border-top:2px solid ${rowBorderColor};` : '';

          if(idx===0){
            const tdDay = document.createElement('td');
            tdDay.rowSpan = list.length;
            tdDay.style.cssText = `padding:30px 25px; ${borderStyle} font-weight:800; vertical-align:top;`;
            tdDay.innerHTML = dayLabel;
            tr.appendChild(tdDay);
          }

          const tdCant = document.createElement('td');
          tdCant.style.cssText = `padding:25px 25px; ${borderStyle} vertical-align:top; line-height:1.4;`;
          tdCant.innerHTML = `<div style="margin-bottom:10px;">
            <strong style="color:#c00; font-size:48px; font-weight:900; text-transform:uppercase;">${en.cant}</strong>
          </div>`;
          if(en.lav)  tdCant.innerHTML += `<div style="font-size:42px; color:#222; line-height:1.3;">${en.lav}</div>`;
          if(en.note) tdCant.innerHTML += `<div style="margin-top:8px; font-size:38px; color:#666; font-style:italic; line-height:1.2;">${en.note}</div>`;

          const tdOrario = document.createElement('td');
          tdOrario.style.cssText = `padding:25px 25px; ${borderStyle} text-align:center; vertical-align:top; white-space:nowrap;`;
          tdOrario.innerHTML = en.orari ? `<span style="font-size:42px; font-weight:800; color:#333; background:#f0f0f0; padding:15px 25px; border-radius:8px; display:inline-block; border:2px solid #ccc;">${en.orari}</span>` : '';

          const tdOre = document.createElement('td');
          tdOre.style.cssText = `padding:25px 25px; ${borderStyle} text-align:right; font-weight:900; vertical-align:top; font-size:55px; color:#000;`;
          tdOre.textContent = en.ore ? `${en.ore} h` : '';

          dayTot += (en.ore || 0);

          tr.appendChild(tdCant);
          tr.appendChild(tdOrario);
          tr.appendChild(tdOre);
          tbody.appendChild(tr);
        });

        if(list.length>1){
          const trSub = document.createElement('tr');
          trSub.style.background = isOff ? '#ffd699' : '#e8e8e8';
          trSub.innerHTML = `
            <td style="padding:20px; border-top:3px solid #666;"></td>
            <td style="padding:20px; border-top:3px solid #666; text-align:right; font-weight:900; font-size:45px; color:#000;">TOT GIORNO:</td>
            <td style="padding:20px; border-top:3px solid #666;"></td>
            <td style="padding:20px; border-top:3px solid #666; text-align:right; font-weight:900; font-size:50px; color:#000; background:#ffeb99;">${(+dayTot.toFixed(2))} h</td>`;
          tbody.appendChild(trSub);
        }
        totRange += dayTot;
        if(!isOff) altFlag = !altFlag;
      }
    }

    const tfoot = document.createElement('tfoot');
    tfoot.innerHTML = `
      <tr style="background:#fff;">
        <td colspan="4" style="padding:0; border-top:10px solid #c00;"></td>
      </tr>`;
    table.appendChild(tbody);
    table.appendChild(tfoot);
    
    // Total row moved to header as per image reference (testo grande sopra)
    const totalRow = document.createElement('div');
    totalRow.style.cssText = `padding:20px 30px; border:10px solid #00f; background:#fff; text-align:center; font-size:60px; font-weight:900; color:#0000ff;`;
    totalRow.textContent = `ORE TOTALI MESE: ${(+totRange.toFixed(2))} h`; // Modificato testo
    
    // Per ottenere l'effetto "due riquadri separati" della foto, li avvolgo
    const wrapper = document.createElement('div');
    wrapper.style.cssText = `display:flex; flex-direction:column; height:100%;`;
    
    const titleDiv = document.createElement('div');
    titleDiv.style.cssText = `padding:20px 30px; text-align:center; font-size:60px; font-weight:900; color:#c00; background:#fff;`;
    titleDiv.textContent = title;
    
    const hoursDiv = document.createElement('div');
    hoursDiv.style.cssText = `padding:20px 30px; text-align:center; font-size:60px; font-weight:900; color:#00f; background:#fff;`;
    hoursDiv.textContent = totRangeOp; // Il testo sarÃ  "ORE TOTALI MESE"

    const tableWrapper = document.createElement('div');
    tableWrapper.style.cssText = `flex-grow:1; display:flex; flex-direction:column; border:10px solid ${title.includes('1 AL 15') ? '#c00000' : '#0000ff'};`;
    
    tableWrapper.appendChild(titleDiv);
    
    // Aggiungo la tabella avvolta in un div per gestire lo scroll
    const tableScrollDiv = document.createElement('div');
    tableScrollDiv.style.cssText = 'overflow:hidden; flex-grow:1;';
    tableScrollDiv.appendChild(table);
    tableWrapper.appendChild(tableScrollDiv);
    
    tableWrapper.appendChild(hoursDiv);

    return { wrapper: tableWrapper, total: totRange };
  }

  // Canvas virtuale largo: due colonne affiancate full-width + statistiche sotto
  // Aumentato per avere piÃ¹ spazio per le due colonne
  const CAPTURE_W = 2600; 
  const CAPTURE_H = 3400; // Altezza fissa per simulare un A4 alto
  const GAP = 40; 

  const pdfContainer = document.getElementById('pdfContainer');
  pdfContainer.innerHTML = '';
  pdfContainer.style.display = 'block';
  pdfContainer.style.position = 'absolute';
  pdfContainer.style.left = '-10000px';
  pdfContainer.style.top = '0';
  pdfContainer.style.width = CAPTURE_W + 'px';
  pdfContainer.style.height = CAPTURE_H + 'px'; // Altezza fissa
  pdfContainer.style.background = '#fff';
  pdfContainer.style.padding = '50px'; // Bordo interno
  pdfContainer.style.boxSizing = 'border-box';
  pdfContainer.style.border = '5px solid #000'; // Bordo del "foglio"

  // Header
  const header = document.createElement('div');
  header.style.cssText = 'text-align:center; margin-bottom:40px;';
  header.innerHTML = `<h1 style="margin:0; font-size:100px; color:#000; font-weight:900; letter-spacing:1px;">NOME OPERAIO: ${op}</h1>`;
  pdfContainer.appendChild(header);

  // COLONNE AFFIANCATE (FLEX per altezza dinamica ma simulando GRID)
  const columnsDiv = document.createElement('div');
  columnsDiv.style.cssText =
    `display:flex;
     justify-content:space-between;
     align-items:stretch;
     gap:${GAP}px;
     width:100%;
     height:75%; /* Riserva spazio per le statistiche */
     margin-bottom:40px;`;

  const col1 = document.createElement('div');
  col1.style.cssText = 'flex:1; display:flex;'; // flex:1 per larghezza equa
  const r1 = createTableForRange(1, Math.min(splitDay, daysInMonth), 'DAL 1 AL 15', 'ORE TOTALI MESE');
  col1.appendChild(r1.wrapper);

  const col2 = document.createElement('div');
  col2.style.cssText = 'flex:1; display:flex;'; // flex:1 per larghezza equa
  if(daysInMonth > splitDay){
    const r2 = createTableForRange(splitDay + 1, daysInMonth, 'DAL 16 AL 31', 'ORE TOTALI MESE');
    col2.appendChild(r2.wrapper);
  }

  columnsDiv.appendChild(col1);
  columnsDiv.appendChild(col2);
  pdfContainer.appendChild(columnsDiv);

  // STATISTICHE sotto, centrate (verde)
  const statsWrapper = document.createElement('div');
  statsWrapper.style.cssText = 'display:flex; justify-content:center; width:100%; height:25%;';
  const cantieriBox = document.createElement('div');
  cantieriBox.style.cssText = `
    padding:32px 40px;
    background:#fff;
    border:10px solid #28a745;
    border-radius:12px;
    width:90%;
    max-width:1800px; /* Larghezza massima per centrarlo */
    display:flex;
    flex-direction:column;
    align-items:center;
  `;
  
  let cantieriHTML = '<div style="font-size:70px; font-weight:900; margin-bottom:30px; color:#28a745; text-align:center; padding-bottom:14px;">STATISTICHE CANTIERI</div>';
  
  // Tabella delle statistiche per una migliore formattazione
  cantieriHTML += '<table style="width:100%; border-collapse:collapse;"><tbody>';
  cantieriArray.forEach((c, idx) => {
    const bgColor = idx===0 ? '#27ae60' : (idx===1 ? '#3498db' : (idx===2 ? '#e67e22' : '#95a5a6'));
    cantieriHTML += `
      <tr>
        <td style="padding:15px 0; font-size:50px; font-weight:900; color:#000; width:50%; vertical-align:middle;">${c.nome}</td>
        <td style="padding:15px 0; text-align:right; font-size:55px; font-weight:900; color:#000; width:25%; vertical-align:middle;">${c.ore} h</td>
        <td style="padding:15px 0; text-align:right; font-size:45px; font-weight:900; color:#666; width:25%; vertical-align:middle;">(${c.percentuale}%)</td>
      </tr>
      <tr>
        <td colspan="3" style="padding:0 0 20px 0;">
          <div style="background:#ddd; height:30px; border-radius:8px; overflow:hidden; border:3px solid #999;">
            <div style="background:${bgColor}; width:${c.percentuale}%; height:100%; border-radius:5px;"></div>
          </div>
        </td>
      </tr>`;
  });
  cantieriHTML += '</tbody></table>';

  cantieriBox.innerHTML = cantieriHTML;
  statsWrapper.appendChild(cantieriBox);
  pdfContainer.appendChild(statsWrapper);

  // Forza box-sizing su tutto il contenuto del PDF
  pdfContainer.querySelectorAll('*').forEach(el => { el.style.boxSizing = 'border-box'; });
  
  // Forza uno sfondo bianco per l'area di cattura
  pdfContainer.style.background = '#ffffff';

  // Render e fit su UNA pagina
  await new Promise(r => requestAnimationFrame(r));
  await new Promise(r => setTimeout(r, 100));

  const canvas = await html2canvas(pdfContainer, { scale: 1, backgroundColor: '#ffffff', useCORS: true, logging: false, width: CAPTURE_W, height: CAPTURE_H });
  pdfContainer.style.display = 'none';

  const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4', compress: true });
  const pageW = pdf.internal.pageSize.getWidth(); // 595.28 pt
  const pageH = pdf.internal.pageSize.getHeight(); // 841.89 pt
  
  // Calcola la scala per adattare il contenuto del canvas all'altezza della pagina
  let scale = pageH / canvas.height;
  // Regola la scala per non eccedere la larghezza (tutta larghezza con margini minimi)
  const maxW = pageW * 0.95; // 95% della larghezza della pagina per un po' di margine
  if ((canvas.width * scale) > maxW) {
    scale = maxW / canvas.width;
  }

  const imgW = canvas.width * scale;
  const imgH = canvas.height * scale;
  
  // Centra il contenuto (orizzontalmente e verticalmente)
  const x = (pageW - imgW) / 2;
  const y = (pageH - imgH) / 2;

  pdf.addImage(canvas.toDataURL('image/png'), 'PNG', x, y, imgW, imgH, undefined, 'FAST');
  pdf.save(`Dettaglio_${op}_${pad(M)}_${Y}.pdf`.replace(/\s+/g,'_'));
}

/* ====== INIT ====== */
(function init(){
  const now = new Date();
  setYM(now.getFullYear(), now.getMonth() + 1);

  btnCarica.addEventListener('click', carica);
  prevBtn.addEventListener('click', () => shiftMonth(-1));
  nextBtn.addEventListener('click', () => shiftMonth(+1));
  meseInput.addEventListener('change', carica);

  tbody.addEventListener('click', (e) => {
    const a = e.target.closest('.op-link');
    if(a && a.dataset.op) {
      showDetail(a.dataset.op);
    }
  });

  document.getElementById('btnDetailPDF').addEventListener('click', exportDetailPDF);
  btnCloseDetail.addEventListener('click', () => {
    detailCard.style.display = 'none';
  });

  carica();
})();
</script>
</body>
</html>
